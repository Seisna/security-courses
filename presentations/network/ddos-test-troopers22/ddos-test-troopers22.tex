\documentclass[Screen16to9,17pt]{foils}
%\documentclass[16pt,landscape,a4paper,footrule]{foils}
\usepackage{zencurity-slides-troopers}

% Abstract
% When connecting to the Internet we immediately receive traffic from unknown sources. We should consider testing our infrastructure using active pentest methods, to verify robustness. This talk will be about doing port scans for discovery of infrastructures and detailed advice how to perform active DDoS simulation to find bottlenecks in the network. The attack tools will be already known tools like Nmap and Hping3 with IPv6 patches. The focus is on the process and experiences doing this over many years.


% Description
% Networks are insecure, and often not as robust as we wish. There is a high risk that networks are vulnerable to one or more DDoS attack vectors, if not tested and verified. When setting up networks we often ignore the built-in features available, and we often have to select which features to enable on specific devices. The vendors tell us they can do everything in every box, but the truth is that attackers can often use more resources than we have available.

% This presentation will take a holistic view on networking infrastructure, but due to time limits focus on hosting web services and providing services to the Internet. The process and advice would transfer to other services and can thus be applied by a practitioner afterwards on their own.

% The main content in this presentation is about performing structured DDoS testing, what to attack, what to expect, how to reduce the number of vulnerable scenarios -- with existing infrastucture devices. The presentation will provide some specific configurations and recommendations using example devices found in normal networks.


% Notes
% I have over the years done multiple workshops with this content. Examples, https://ripe72.ripe.net/wp-content/uploads/presentations/32-simulated-ddos-ripe.pdf and https://bornhack.dk/bornhack-2021/program/simulating-ddos-packets/

% I would prefer this is "just" a presentation, and interested parties contact me afterwards - will be on-site all week.

% Note: I asked Kerstin for an academic voucher, but after realized that I could submit this.

% Why is your material different, innovative, and/or significant?
% My material is not very innovative, but significant based on real-life experiences building, testing and configuring networks over many year. This presentation does provide innovation, in providing a simple patch set for the Hping3 tool enabling the use of IPv6. It seems there are very few DDoS testing tools that work with IPv6, so it might count as innovation.

% I find it significant that very few people perform structured testing, and only consider enabling existing features when under attack. This prolongs the reaction time, as opposed to performing structured testing and hardening of devices BEFORE DDoS attacks.

% We have seen actual networks being able to handle much larger attacks by themselves, by tuning existing devices.

% What technical requirements are there for this talk?
% There will be a lot of networking terms used, port, port scan, IP address, rate limit, router, firewall, SYN flood. So a basic understanding of networking and having heard of DDoS SYN flooding will be beneficial.

% The main attendees would be firewall administrators, network administrators, but anyone with responsibility for a network will benefit - as they can afterwards hand over the information to others that perform the actual tuning of networks.


% Dont forget input from:
% Old troopers I didnt hold
% Modern firewalls

% Test Lab

% Penguin01 Dell 3240 with Dual 10G Intel card 10.0.45.69
% Available via apu2c4 10.0.42.74
% Projects VM: ssh penguin01

\addbibresource{/home/user/projects/books/firewall-publications/texfiles/firewall-refs.bib}

\begin{document}

%\rm
\selectlanguage{english}
\mytitlepage{DDoS Testing Your Infrastructure,\\ including IPv6 SYN floods}{TROOPERS22}

{\small
Note: My main contribution is about performing structured DDoS testing, many great tools exist already}

\slide{What is this presentation about}

\begin{quote}
When connecting to the Internet we immediately receive traffic from unknown sources. We should consider testing our infrastructure using active pentest methods, to verify robustness.
\end{quote}


You will learn:
\begin{list2}
\item This talk will be about firewall infrastructures -- what is a firewall really, short
\item Doing port scans for discovery of infrastructures followed by detailed advice how to perform active DDoS simulation
\end{list2}

Note: The attack tools will be already known tools, but with a lot of focus on the process and experiences


Plan

\slide{The Internet and DDoS is trouble}

DDoS has become extremely large


\centerline{Don't give up!}

We can do a lot to improve our infrastucture

\slide{Definitions}


Multiple definitions for firewalls exist, below are a few examples to illustrate some of the variations that exist.

The first book about firewalls used this definition:

\begin{quote}
We define a firewall as a collection of components placed between two networks that collectively have
the following properties:
\begin{list2}
\item All traffic from inside to outside, and vice-versa, must pass through the firewall.
\item Only authorized traffic, as defined by the local security policy, will be allowed to pass.
\item The firewall itself is immune to penetration.
\end{list2}
We should note that these are design goals; a failure in one aspect does not mean that the collection
is not a firewall, simply that it is not a very good one.
\end{quote}

Source: \citetitle{Cheswick94} by \citeauthor{Cheswick94} \citeyear{Cheswick94}

We will consider this a firewall, but we know today that both inside and outside at meaningless, since we have multiple networks inside, we have partner network connections etc.

Another short definition that encapsulates this is found on Wikipedia, and may suffice in many situations. Again there will typically be multiple networks, zones or areas of the networks with varying degrees of trust.
\begin{quote}
In computing, a firewall is a network security system that monitors and controls incoming and outgoing network traffic based on predetermined security rules.[1] A firewall typically establishes a barrier between a trusted network and an untrusted network, such as the Internet.[2]
\end{quote}
Source: Wikipedia
 \link{https://en.wikipedia.org/wiki/Firewall_(computing)}

 \begin{list2}
 \item {\bf Firewall Technology:} \emph{Mechanism to help enforce access policies about communication traffic entering or leaving networks.}
\end{list2}

Source: \citetitle{lyles} by \citeauthor{lyles} \citeyear{lyles}




\slide{A firewall -- in the vendor eyes}

% Single line in firewall - single line out
% With text device under test, as caption
\hlkimage{17cm}{Firewall-vendor.pdf}


\begin{quote}
{\bf Can your firewall flex in the face of change?}\\
Does it harmonize your network, workload, and application security? Does it protect apps and employees in your hybrid or multicloud environment? Make sure you're covered.
\end{quote}
Source: not shown to protect the audience from further marketing speak





\slide{A firewall -- in the enterprise mindset }

% Single line in firewall,
% cloud with at-sign Internet on the left,\\
% cloud with at-sign LAN on the right
\hlkimage{17cm}{Firewall-enterprise.pdf}


\slide{}

%\hlkimage{}{}

\begin{quote}

\end{quote}

\begin{list2}
\item Even though some vendors suggest they can do everything in a single box, dont believe them!
\item Truth -- yes, we can do almost anything in software
\item Realization {\bf Your infrastructure is based on multiple components and or devices}
\end{list2}



\slide{Packet processing in firewalls -- detailed view}

% Picture with pipeline from Juniper SRX
\hlkimage{20cm}{srx-firewall-flow-based-processing.png}
Example from Juniper SRX\\ {\footnotesize
\link{https://www.juniper.net/documentation/us/en/software/junos/flow-packet-processing/topics/topic-map/security-srx-devices-processing-overview.html}}


\slide{Defense in depth}

%\hlkimage{10cm}{Bartizan.png}
\hlkimage{15cm}{medieval-clipart-5}
\centerline{Picture originally from: \url{http://karenswhimsy.com/public-domain-images}}




\slide{My idea of a firewall -- multiple devices!}

\hlkimage{15cm}{network-layers-2022.pdf}




\slide{Another definition}
I am also fond of this longer and technical definition from RFC4949:
\begin{quote}
\$ firewall

      1. (I) {\bf An internetwork gateway that restricts data communication
      traffic to and from one of the connected networks} (the one said to
      be "inside" the firewall) and thus protects that network's system
      resources against threats from the other network (the one that is
      said to be "outside" the firewall). (See: guard, security
      gateway.)

      2. (O) {\bf A device or system that controls the flow of traffic
      between networks using differing security postures.} Wack, J. et al (NIST), "Guidelines on Firewalls and Firewall Policy", Special Publication 800-41,
      January 2002.

      Tutorial: A firewall typically protects a smaller, secure network
      (such as a corporate LAN, or even just one host) from a larger
      network (such as the Internet). The firewall is installed at the
      point where the networks connect, and the firewall applies policy
      rules to control traffic that flows in and out of the protected
      network.
\end{quote}

\slide{Another definition}

\begin{quote}
\$ firewall, continued

      {\bf A firewall is not always a single computer.} For example, a
      firewall may consist of a pair of filtering routers and one or
      more proxy servers running on one or more bastion hosts, all
      connected to a small, dedicated LAN (see: buffer zone) between the
      two routers.

      The external router blocks attacks that use IP to
      break security (IP address spoofing, source routing, packet
      fragments), while proxy servers block attacks that would exploit a
      vulnerability in a higher-layer protocol or service. The internal
      router blocks traffic from leaving the protected network except
      through the proxy servers.

      The difficult part is defining criteria by which packets are denied passage through the firewall, because
      a firewall not only needs to keep unauthorized traffic (i.e., intruders) out, but usually also needs to let authorized traffic
      pass both in and out.
\end{quote}

\slide{The Modern Firewall Infrastructure}


\begin{center}
\begin{tikzpicture}[scale=0.6, transform shape]
\input{firewall-problems-mindmap.tikz}
\end{tikzpicture}
\end{center}




\slide{Bottlenecks exist, but where}


\hlkimage{12cm}{overview-routing-customer-2015.pdf}

\begin{list2}
\item Transport Layer Attacks TCP SYN flood TCP sequence numbers
\item High level attacks like Slowloris - keep TCP/HTTP connection for a long time.
\end{list2}

\slide{Availability and Network flooding attacks}

\begin{list2}
\item SYN flood is the most basic and very common on the internet towards 80/tcp and 443/tcp
\item ICMP and UDP flooding are the next popular targets
\item Special packets
\item All of them try to use up some resources
\begin{list2}
\item Memory space in specific sections of the kernel, TCP state, firewalls state, number of concurrent sessions/connections
\item Interrupt processing of packets - packets per second
\item CPU processing in firewalls, pps
\item CPU processing in server software
\item Bandwidth - megabits per second mbps
\item And amplification attacks abusing devices on the Internet
\end{list2}
\end{list2}



\slide{Testing network the legal issues}

{\bfseries Straffelovens paragraf 263 Stk. 2. Med bøde eller fængsel indtil 1 år og 6 måneder straffes den, der uberettiget skaffer sig adgang til en andens oplysninger eller programmer, der er bestemt til at bruges i et informationssystem. }

\begin{list2}
\item Danish law about hacking -- check in your own country/area!
\item Please check with your legal department, and/or be careful
\item We {\bf always} contact network between us and the network to be tested
\item Be good netizens
\end{list2}

Hint: use a variable to keep the target address, carefull enter it and avoid mystyping it later
\begin{alltt}
\small
# export CUST_NET="192.0.2.0/24"
# nmap -p 1-65535 -A -oA full-scan $CUST_NET
# export CUST_IP=192.0.2.1
# date;time hping3 -q -c 1000000  -i u60 -S -p 80  $CUST_IP
\end{alltt}






\slide{DDoS traffic before filtering}
\hlkimage{20cm}{ddos-before-filtering}

\centerline{Only two links shown, at least 3Gbit incoming for this single IP}

\slide{DDoS traffic after filtering}
\hlkimage{20cm}{ddos-after-filtering}

\begin{list1}
\item Link toward server (next level firewall actually) about ~350Mbit outgoing
\item Knowing what it going on, is half the battle
\end{list1}


\slide{Make incremental changes}

\begin{center}
\begin{tikzpicture}[->,>=stealth',scale=0.7, transform shape]
\newlength{\boxwidth}
\setlength{\boxwidth}{0.21\paperwidth}
\newlength{\boxheight}
\setlength{\boxheight}{0.25\paperheight}
\newlength{\boxspace}
\setlength{\boxspace}{10cm}
\input{incremental-changes-flowchart.tikz}
\end{tikzpicture}
\end{center}








\slide{Conclusion DDoS and network attacks}

\hlkimage{10cm}{network-layers-2022.pdf}
~
\begin{list2}
\item You really should try testing, and investigate your existing devices
all of them, RTFM, upgrade firmware
\item Choose which devices does which
part - discard early to free resources for later devices to dig deeper
\item This is just one small part of your security posture, extra slides has my take on enterprise network security
\end{list2}

\myquestionspage


Thank you for coming. I'll be around until friday.

\slide{Further reading}

I have a lot of older presentations, which are open source, copy and find inspiration\\
\url{https://github.com/kramse/security-courses}

\begin{list2}
\item HLK DDoS presentations, advice for configuring routers in front of the networks\\
Multiple exercises described for performing testing with Nmap, hping3 and t50
\item TROOPERS19 HLK VXLAN recommendations about VXLAN, consider your tunnelled protocols for inspection!
\item Portscanning - start using portscans in your networks, verify how far malware and hackers can travel, and identify soft systems needing updates or isolation
\end{list2}

One of my favourite books \emph{Network Warrior} by Gary A. Donahue, recommends designing your network without restrictions and then working toward this goal.\\
{\footnotesize \emph{Network Warrior}, 2nd Edition
by Gary A. Donahue, May 2011, O'Reilly Media, ISBN: 9781449387860


\slide{Concrete advise for enterprise networks}


\begin{list2}
\item Have separation -- anywhere, starting with organisation units, management networks, server networks, customers, guests, LA
N, WAN, Mail, web, ...
\item Use Web proxies - do not allow HTTP directly except for a short allow list, \\
do not allow traffic to and from any new TLD
\item Use only your own DNS servers, create a pair of Unbound servers, \\
point your internal DNS running on Windows to these\\
Create filtering, logging, restrictions on these Unbound DNS servers\\
\link{https://www.nlnetlabs.nl/projects/unbound/about/} and also \link{https://pi-hole.net/}
\item Only allow SMTP via your own mail servers, create a simple forwarder if you must
\end{list2}

Allow lists are better than block list, even if it takes some time to do it

\slide{Capture data and logs!}


\begin{list2}
\item Run DNS query logs -- when client1 is infected with malware from domain malwareexample.com, then search for more clients i
nfected
\item Run Zeek and gather information about all HTTPS sessions -- captures certificates by default, and we can again search for
certificate related to malwareexample.com
\item Run network logging -- session logs in enterprise networks are GREAT \\
(country wide illegal logging is of course NOT)
\end{list2}

Make sure to check with employees, inform them!

\slide{DROP SOME TRAFFIC NOW}

\begin{list2}
\item Drop some traffic on the border of everything
\item Seriously do NOT allow Windows RPC across borders
\item Border here may be from regional country office back to HQ
\item Border may be from internet to internal networks
\item Block Windows RPC ports, 135, 137, 139, 445
\item Block DNS directly to internet, do not allow clients to use any DNS, fake 8.8.8.8 if you must internally
\item Block SMTP directly to internet
\item Create allow list for internal networks, client networks should not contact other client networks but only relevant server networks
\end{list2}

You DONT need to allow direct DNS towards internet, except from your own recursive DNS servers

If you get hacked by Windows RPC in 2022, you probably deserve it, sorry for being blunt

Best would be to analyze traffic and create allow lists, some internal networks to not need internet at all


\slide{Default permit}

%\hlkimage{}{}

One of the early implementers of firewalls Marcus J. Ranum summarized in 2005 The Six Dumbest Ideas in Computer Security \link{https://www.ranum.com/security/computer_security/editorials/dumb/} which includes the always appropriate discussion about default permit versus default deny.

\begin{quote}\small {\bf
\#1) Default Permit}\\
This dumb idea crops up in a lot of different forms; it’s incredibly persistent and difficult to eradicate. Why? Because it’s so attractive. Systems based on ”Default Permit” are the computer security equivalent of empty calories: tasty, yet fattening.

The most recognizable form in which the ”Default Permit” dumb idea manifests itself is in firewall rules. Back in the very early days of computer security, network managers would set up an internet connection and decide to secure it by turning off incoming telnet, incoming rlogin, and incoming FTP. Everything else was allowed through, hence the name ”Default Permit.” This put the security practitioner in an endless arms-race with the hackers.
\end{quote}


\begin{list2}
\item Allow all current networks today on all ports for all protocols \emph{is} an allow list \\
Which tomorrow can be split into one for TCP, UDP and remaining, and measured upon
\item Measure, improve, repeat
\end{list2}



\slide{We cannot do X}

\begin{quote}
We cannot block SMTP from internal networks, since we do not know for sure if vendor X equipment needs to send the MOST important email alert at some unspecific time in the future
\end{quote}

Cool, then we can do an allow list starting today on our border firewall:
\begin{alltt}
table <smtp-exchange> \{ $exchange1 $exchange2 $exchange3 \}
table <smtp-unknown> persist file "/firewall/mail/smtp-internal-unknown.txt"
# Regular use, allowed
pass out on egress inet proto tcp from smtp-echange to any port 25/tcp
# Unknown, remove when phased out
pass out on egress inet proto tcp from smtp-internal to any port 25/tcp
\end{alltt}

Year 0 the unknown list may be 100\% of all internal networks, but new networks added to infrastructure are NOT added, so list will shrink -- evaluate the list, and compare to network logs, did networks send ANY SMTP for 1,2,3 years?

\slide{Zeek is a framework and platform}

\hlkimage{12cm}{zeek-ids.png}

\begin{quote}
While focusing on network security monitoring, Zeek provides a comprehensive platform for more general network traffic analysis as well. Well grounded in more than 15 years of research, Zeek has successfully bridged the traditional gap between academia and operations since its inception.
\end{quote}

\link{https://www.Zeek.org/}
Does useful things out of the box using more than 10.000 script lines

\slide{Suricata IDS/IPS/NSM}
\hlkimage{6cm}{suricata.png}

\begin{quote}
Suricata is a high performance Network IDS, IPS and Network Security Monitoring engine.
\end{quote}

 \link{http://suricata-ids.org/}
 \link{http://openinfosecfoundation.org}

Suricata, Zeek og DNS Capture -- it a nice world, use it!\\
{\small\link{https://github.com/kramse/security-courses/tree/master/courses/networking/suricatazeek-workshop}}


\end{document}
