\documentclass[Screen16to9,17pt]{foils}
%\documentclass[16pt,landscape,a4paper,footrule]{foils}
\usepackage{zencurity-slides-troopers}

% Abstract
% When connecting to the Internet we immediately receive traffic from unknown sources. We should consider testing our infrastructure using active pentest methods, to verify robustness. This talk will be about doing port scans for discovery of infrastructures and detailed advice how to perform active DDoS simulation to find bottlenecks in the network. The attack tools will be already known tools like Nmap and Hping3 with IPv6 patches. The focus is on the process and experiences doing this over many years.


% Description
% Networks are insecure, and often not as robust as we wish. There is a high risk that networks are vulnerable to one or more DDoS attack vectors, if not tested and verified. When setting up networks we often ignore the built-in features available, and we often have to select which features to enable on specific devices. The vendors tell us they can do everything in every box, but the truth is that attackers can often use more resources than we have available.

% This presentation will take a holistic view on networking infrastructure, but due to time limits focus on hosting web services and providing services to the Internet. The process and advice would transfer to other services and can thus be applied by a practitioner afterwards on their own.

% The main content in this presentation is about performing structured DDoS testing, what to attack, what to expect, how to reduce the number of vulnerable scenarios -- with existing infrastucture devices. The presentation will provide some specific configurations and recommendations using example devices found in normal networks.


% Notes
% I have over the years done multiple workshops with this content. Examples, https://ripe72.ripe.net/wp-content/uploads/presentations/32-simulated-ddos-ripe.pdf and https://bornhack.dk/bornhack-2021/program/simulating-ddos-packets/

% I would prefer this is "just" a presentation, and interested parties contact me afterwards - will be on-site all week.

% Note: I asked Kerstin for an academic voucher, but after realized that I could submit this.

% Why is your material different, innovative, and/or significant?
% My material is not very innovative, but significant based on real-life experiences building, testing and configuring networks over many year. This presentation does provide innovation, in providing a simple patch set for the Hping3 tool enabling the use of IPv6. It seems there are very few DDoS testing tools that work with IPv6, so it might count as innovation.

% I find it significant that very few people perform structured testing, and only consider enabling existing features when under attack. This prolongs the reaction time, as opposed to performing structured testing and hardening of devices BEFORE DDoS attacks.

% We have seen actual networks being able to handle much larger attacks by themselves, by tuning existing devices.

% What technical requirements are there for this talk?
% There will be a lot of networking terms used, port, port scan, IP address, rate limit, router, firewall, SYN flood. So a basic understanding of networking and having heard of DDoS SYN flooding will be beneficial.

% The main attendees would be firewall administrators, network administrators, but anyone with responsibility for a network will benefit - as they can afterwards hand over the information to others that perform the actual tuning of networks.


% Dont forget input from:
% Old troopers I didnt hold
% Modern firewalls

% Test Lab

% Penguin01 Dell 3240 with Dual 10G Intel card 10.0.45.69
% Available via apu2c4 10.0.42.74
% Projects VM: ssh penguin01

\addbibresource{/home/user/projects/books/firewall-publications/texfiles/firewall-refs.bib}

\begin{document}

%\rm
\selectlanguage{english}
\mytitlepage{DDoS Testing Your Infrastructure,\\ including IPv6 SYN floods}{TROOPERS22}

{\small
Note: My main contribution is about performing structured DDoS testing, many great tools exist already}


\slide{Testing network the legal issues}

{\bfseries Straffelovens paragraf 263 Stk. 2. Med bøde eller fængsel indtil 1 år og 6 måneder straffes den, der uberettiget skaffer sig adgang til en andens oplysninger eller programmer, der er bestemt til at bruges i et informationssystem. }

\begin{list2}
\item Danish law about hacking -- check in your own country/area!
\item Please check with your legal department, and/or be careful
\item We {\bf always} contact network between us and the network to be tested
\item Be good netizens
\end{list2}


\slide{What is this presentation about}

\begin{quote}
When connecting to the Internet we immediately receive traffic from unknown sources. We should consider testing our infrastructure using active pentest methods, to verify robustness.
\end{quote}


You will learn:
\begin{list2}
\item This talk will be about firewall infrastructures -- what is a firewall really, short
\item Doing port scans for discovery of infrastructures ...
\item Followed by detailed advice how to perform active DDoS simulation
\item My advice for protection using your existing devices
\end{list2}

Note: The attack tools will be already developed and possibly known tools, but with a lot of focus on the process and experiences. I also have some opinions and experiences to share.


\slide{The Internet and DDoS is trouble}

\hlkimage{13cm}{DDos_Attack_in_2021_arbor.png}

Security attacks and DDoS is very much in the media\\
Source: \link{https://www.netscout.com/threatreport/global-ddos-attack-trends/}

\slide{DDoS Attacks are HUGE}

\hlkimage{10cm}{DDos_Attack_in_2021_size_arbor.png}

Extremely hard to protect against from a small network\\
Source: link{https://www.netscout.com/threatreport/global-ddos-attack-trends/}

We can do a lot to improve our infrastucture -- Don't give up!

\slide{Definition of firewalls -- multiple definitions exist}

\begin{quote}
We define a firewall as {\bf a collection of components} placed between two networks that collectively have
the following properties:
\begin{list2}
\item All traffic from inside to outside, and vice-versa, must pass through the firewall.
\item Only authorized traffic, as defined by the {\bf local security policy}, will be allowed to pass.
\item The firewall itself is immune to penetration.
\end{list2}
We should note that these are design goals; a failure in one aspect does not mean that the collection
is not a firewall, simply that it is not a very good one.
\end{quote}

We will consider this a firewall, but we know today that {\bf both inside and outside at meaningless}, since we have {\bf multiple networks inside, we have partner network connections etc.}

Source: \citetitle{Cheswick94} by \citeauthor{Cheswick94} \citeyear{Cheswick94}

\slide{Definition of firewalls -- Wikipedia}

Another short definition that encapsulates this is found on Wikipedia, and may suffice in many situations. Again there will typically be multiple networks, zones or areas of the networks with varying degrees of trust.
\begin{quote}
In computing, a firewall is a {\bf network security system that monitors and controls incoming and outgoing network traffic based on predetermined security rules}.[1] A firewall typically establishes a barrier between a trusted network and an untrusted network, such as the Internet.[2]
\end{quote}
Source: Wikipedia
 \link{https://en.wikipedia.org/wiki/Firewall_(computing)}

{\bf TL;DR Not necessarily a single device}



\slide{A firewall -- in the vendor eyes}

% Single line in firewall - single line out
% With text device under test, as caption
\hlkimage{19cm}{Firewall-vendor.pdf}


\begin{quote}
"{\bf Can your firewall flex in the face of change?}\\
Does it harmonize your network, workload, and application security? Does it protect apps and employees in your hybrid or multicloud environment? Make sure you're covered."
\end{quote}
Source: not shown to protect the audience from further marketing speak
% Source is Cisco.com




\slide{A firewall -- in the enterprise mindset }

% Single line in firewall,
% cloud with at-sign Internet on the left,\\
% cloud with at-sign LAN on the right
\hlkimage{19cm}{Firewall-enterprise.pdf}

\begin{list2}
\item Even though some vendors suggest they can do everything in a single box, I don't believe them!
\item Truth -- yes, we can do almost anything in software
\item Realization {\bf Your infrastructure is based on multiple components and or devices}
\end{list2}

\slide{Defense in depth}

%\hlkimage{10cm}{Bartizan.png}
\hlkimage{15cm}{medieval-clipart-5}
\centerline{Picture originally from: \url{http://karenswhimsy.com/public-domain-images}}


%\slide{The Modern Firewall Infrastructure}

%\begin{center}
%\begin{tikzpicture}[scale=0.6, transform shape]
%\input{firewall-problems-mindmap.tikz}
%\end{tikzpicture}
%\end{center}


\slide{Bottlenecks exist, but where}


\hlkimage{12cm}{overview-routing-customer-2015.pdf}

\begin{list2}
\item Lower layer attacks Transport Layer Attacks TCP SYN flood -- packet based
\item Higher layer attacks like Slowloris and web attacks -- keep sessions running
\item Protect everything without loosing functionality or creating administrative nightmare
\end{list2}

\slide{Availability and Network flooding attacks}

The attacks we are discussing today are:
\begin{list2}
\item {\bf SYN flood} is the most basic and very common on the internet towards 80/tcp and 443/tcp
\item {\bf ICMP and UDP flooding} are the next popular targets -- more similar ones exist
\item Special packets and protocols -- anything that can create \emph{load on systems} work
\item All of them try to use up some resources
\begin{list2}
\item {\bf Memory space} in specific sections of the {\bf kernel, TCP state, firewalls state, number of concurrent sessions/connections}
\item {\bf Interrupt processing} of packets - packets per second (pps)
\item {\bf CPU processing} in firewalls, pps
\item CPU processing in server software
\item {\bf Bandwidth} - megabits per second (mbps)
\item Typically source is spoofed or amplification attacks abusing devices on the Internet
\end{list2}
\end{list2}





\slide{Packet processing in firewalls -- detailed view}

% Picture with pipeline from Juniper SRX
\hlkimage{21cm}{srx-firewall-flow-based-processing.png}
\emph{Traffic Processing on SRX Series Devices Overview}\\ {\scriptsize
\link{https://www.juniper.net/documentation/us/en/software/junos/flow-packet-processing/topics/topic-map/security-srx-devices-processing-overview.html}}




\slide{Scanning and Attacking -- \bf Pressure Points and Scope}

% Drawing showing "network"

\hlkimage{21cm}{generic-network-pressure-points.pdf}

\begin{list2}
\item In scope for me is everything that could adversely affect the network
\item Common scope IPv4: Link network /28 or /26 and a hosting network /24
\item Common scope IPv6: Link network /64 (bad) or /127 (RFC9099) and a hosting network /48 with subnets
%\item Domain Name Service outside of the network is ofc also attack vector, ignored today
\end{list2}



\slide{Prepare for the testing}

\begin{alltt}
\item
\end{alltt}

\begin{list2}
\item Portscan the whole hosting range in IPv4
\item Ask about IPv6 ranges in use, specific subnets and IPv6 addresses\\
We can guess from traceroute, Nmap test first 100 addresses in each subnet etc. but easier to ask
\item Portscan the whole linknet - identify provider devices, hosting network devices, type of device router/firewall
\end{list2}


\slide{Detailed Scope and Plan}

Select a few targets for monitoring and attacks, from the port scans

Best case would be to have:
\begin{list2}
\item Ping ICMP allowed to a provider router and hosting firewall -- is the connection alive
\item TCP port with service checks, HTTP being attacked and one not being attacked
\item UDP port with service check, DNS is a favourite -- ask for localhost/127.0.0.1
\item Put monitoring on these, a week before testing is nice
\item Agree on a day or night for testing, inform participants and system owners
\end{list2}

\slide{Before testing: Smokeping}

\hlkimage{17cm}{smokeping-before-testing.png}

\centerline{Before DDoS testing  use Smokeping software}

\slide{Before testing: Pingdom}

\hlkimage{17cm}{forside-pingdom.png}

\centerline{Another external monitoring from Pingdom.com}






\slide{Performing the DDoS test }

\begin{list2}
\item  Like Nmap and others, how do you perform this task then?

\item Listing options show multiple pages ...\\
Running \verb+man nmap | enscript -o test.ps+ result in 54 pages \smiley

\item So lets break this task down into:
\begin{enumerate}
\item Use Nmap to port scan the network
\item Setup monitoring -- not shown here
\item Run \verb+hping3+ and \verb+t50+
\end{enumerate}

\vskip 1cm
\item BTW we usually schedule this for night time! There WILL be interruptions
\end{list2}

% Slides from courses about Hping3

\slide{Hint: Save the scope in variables}

Hint: use a variable to keep the target address, carefull enter it and avoid mystyping it later
\begin{alltt}
\small
# export CUST_NET4="192.0.2.0/24"
# export CUST_NET6="192.0.2.0/24"
# nmap -p 1-65535 -Pn -A -oA full-scan $CUST_NET4
# export CUST_IP=192.0.2.138
# date;time hping3 -q -c 1000000  -i u60 -S -p 80 $CUST_IP
\end{alltt}

Better yet, script it all -- but most likely you will want to repeat specific steps.

\slide{Nmap port sweep for TCP services, full TCP scan }

\begin{alltt}\small
root@cornerstone:~#{\bfseries  nmap -Pn -A -p 1-65535 -oA full-tcp-customer-ipv4 $CUST_NET4}
...
Nmap scan report for 192.0.2.138
Host is up (0.00012s latency).
PORT    STATE  SERVICE
{\color{darkgreen}80/tcp  open   http}
443/tcp closed https
root@cornerstone:~#{\bfseries  nmap -Pn -A -p 1-65535 -oA full-tcp-customer-ipv6 $CUST_NET6}
root@cornerstone:~#{\bfseries  nmap -Pn -A -p 1-65535 -oA full-tcp-linknet-ipv4 $LINK_NET4}
root@cornerstone:~#{\bfseries  nmap -Pn -A -p 1-65535 -oA full-tcp-linknet-ipv6 $LINK_NET6}
\end{alltt}

Goal is to enumerate the ports that are allowed through the network.

Note: These commands are pretty harmless, if something dies, then it is\\
\emph{vulnerable to normal traffic} - and should be fixed!


\slide{Nmap options }

I always use these:
\begin{list2}
\item -Pn -- Scan all IPs, dont use ping or TCP ping to check alive
\item -A advanced -- perform full TCP connection and grab banner
\item -p 1-65535 -- full portscan all ports
\item -oA filename -- Saves output in "all formats" normal, XML, and grepable formats
\end{list2}





\slide{Nmap port sweep for SNMP port 161/UDP}

Perform some UDP scanning, cannot do full scan, but often SNMP is there, example:
\begin{alltt}\small
root@cornerstone:~#{\bfseries nmap -A -sU -p 161 --script "snmp-info" -oA snmp-scan $LINK_NET4}
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-26 20:20 CEST
Nmap scan report for 193.111.162.0
Host is up (0.00082s latency).

PORT    STATE SERVICE VERSION
161/udp open  snmp    Cisco SNMP service; ciscoSystems SNMPv3 server
| snmp-info:
|   enterprise: ciscoSystems
|   engineIDFormat: mac
|   engineIDData: 00:08:4f:xx:yy:zz
|   snmpEngineBoots: 4
|_  snmpEngineTime: {\bf 732d07h09m04s}
Too many fingerprints match this host to give specific OS details
Network Distance: 6 hops
\end{alltt}

\vskip 5mm
\centerline{More reliable to use Nmap script with probes like --script=snmp-info}

\slide{Common DDoS attack types}

A prioritized list of common attack types, like:

\begin{list2}
\item TCP SYN flooding
\item TCP other flooding
\item UDP flooding NTP, etc.
\item ICMP flooding
\item Misc - stranger attacks and illegal combinations of flags etc.
\end{list2}

\slide{hping3 packet generator}

\begin{alltt}\footnotesize
usage: hping3 host [options]
  -i  --interval  wait (uX for X microseconds, for example -i u1000)
      --fast      alias for -i u10000 (10 packets for second)
      --faster    alias for -i u1000 (100 packets for second)
      --flood      sent packets as fast as possible. Don't show replies.
...
hping3 is fully scriptable using the TCL language, and packets
can be received and sent via a binary or string representation
describing the packets.
\end{alltt}

\begin{list2}
\item Hping3 packet generator is a very flexible tool to produce simulated DDoS traffic with specific charateristics
\item Home page: \link{http://www.hping.org/hping3.html} Source repository \link{https://github.com/antirez/hping}
\item My fork with IPv6 and VXLAN branches added \link{https://github.com/kramse/hping-2018}
\end{list2}

\centerline{My primary DDoS testing tool, easy to get specific rate pps}

\slide{t50 packet generator}


\begin{alltt}\footnotesize
root@cornerstone03:~# t50 -?
T50 Experimental Mixed Packet Injector Tool 5.4.1
Originally created by Nelson Brito <nbrito@sekure.org>
Maintained by Fernando Mercês <fernando@mentebinaria.com.br>

Usage: T50 <host> [/CIDR] [options]

Common Options:
    --threshold NUM        Threshold of packets to send     (default 1000)
    --flood                This option supersedes the 'threshold'
...
6. Running T50 with '--protocol T50' option, sends ALL protocols sequentially.
root@cornerstone03:~# t50 -? | wc -l
264
\end{alltt}

\begin{list2}
\item T50 packet generator, another high speed packet generator
can easily overload most firewalls by producing a randomized traffic with multiple protocols like IPsec, GRE, MIX \\
home page: \link{http://t50.sourceforge.net/resources.html}
\end{list2}

\centerline{Extremely fast and breaks most firewalls when flooding, easy 800k pps/400Mbps}

\slide{Process: monitor, attack, break, repeat}

\begin{list2}
\item Start small, run with delays between packets
\item Turn up until it breaks, decrease delay - until using \verb+--flood+
\item Monitor speed of attack on your router interface pps/bandwidth
\item Give it maximum speed\\
 \verb+hping3 --flood -1+ and \verb+hping3 --flood -2+
\item Have a common chat with network operators/customer to talk about symptoms and things observed
\item Any information resulting from testing is good information
\end{list2}



\slide{Running Attacks with hping3}

\begin{alltt}\small
# export CUST_IP=192.0.2.138
# date;time hping3 -q -c 1000000  -i u60 -S -p 80 $CUST_IP &
 \end{alltt}

\begin{alltt}\small
# date;time hping3 -q -c 1000000  -i u60 -S -p 80 $CUST_IP &
Thu Jan 21 22:37:06 CET 2022
HPING 192.0.2.1 (eth0 192.0.2.1): S set, 40 headers + 0 data bytes

--- 192.0.2.1 hping statistic ---
1000000 packets transmitted, 999996 packets received, 1% packet loss
round-trip min/avg/max = 0.9/7.0/1005.5 ms

real    1m7.438s
user    0m1.200s
sys     0m5.444s
\end{alltt}

\vskip 1cm
\centerline{Dont forget to do a killall hping3 when done \smiley }



\slide{Recommendations During Test}

\begin{list2}
\item Run each test for at least 5 minutes, or even 15 minutes\\
Some attacks require some build-up before resource run out
\item Take note of any change in response, higher latency, lost probes
\item If you see a change, then re-test using the same parameters, or a little less first
\item We want to know the approximate level where it breaks
\item {\bf If you want to change environment, then wait until all scenarios are tested}
\item Keep a log handy, write notes and start the session with \verb+script ddos-date.log+
\item Check once in a while if you have some process running, using \verb+ps auxw | grep hping3+
\item Run multiple instances of the tools. One process might generate 800.000 pps, while two may double it. Though 10 processes might not be 10 times exactly
\end{list2}



\slide{Running the tools}

A basic test would be:
\begin{list2}
\item TCP SYN flooding
\item TCP other flags, PUSH-ACK, RST, ACK, FIN
\item ICMP flooding
\item UDP flooding
\item Spoofed packets src=dst=target \smiley
\item Small fragments
\item Bad fragment offset
\item Bad checksum
\item Be creative
\item Mixed packets - like \verb+t50 --protocol T50+
\item Perhaps esoteric or unused protocols, GRE, IPSec
\end{list2}

\slide{Test-cases / Scenarios}

The minimal run contains at least these:
\begin{list2}
\item SYN flood: \verb+hping3 -q -c 1000000  -i u60 -S -p 80 $CUST_IP &+
\item SYN+ACK: \verb+hping3 -q -c 1000000  -i u60 -S -A -p 80 $CUST_IP &+
\item ICMP flood: \verb+hping3 -q -c 1000000 --flood -1 $CUST_IP &+
\item UDP flood: \verb+hping3 -q -c 1000000 --flood -2 $CUST_IP &+
\item Near end of test we also throw in the joker to kill firewalls -- \verb+t50 --flood --protocol T50 $CUST_IP+
\end{list2}

While testing I use the tool \verb+ifpps+ tool from the Netsniff-ng package \link{http://netsniff-ng.org/} to monitor sending speed, or you can use your router/switch -- Junos \verb+monitor interface+

\slide{Tuning the testing}


Further hints:
\begin{list2}
\item Vary the speed using the packet interval \verb+-i u60+ up/down
\item Add more processes and monitor change in responses
\item Use flooding with caution, runs max speeeeeeeeeeeed \smiley
\item TCP testing use a port which is allowed through the network, often 80/443
\item Focus on attacks which are hard to block, example TCP SYN must be allowed in
\item Also if you found devices like routers in front of environment\\
\verb+hping3 -q -c 1000000  -i u60 -S -p 22 $ROUTER_IP+\\
\verb+hping3 -q -c 1000000  -i u60 -S -p 179 $ROUTER_IP+
\end{list2}

I start using a single test-case at a time, but later run multiple in parallel

\slide{Note about IPv6 Testing}

My favourite tools have not always supported IPv6, which is a shame

Two options, modify tools or use newer tools

\begin{list2}
\item Fortunately these tools are open source,

\item I truly love Hping3, this tools is very flexible and powerful, so I modified Hping to suit my needs, basically search and replace for inet to inet6, so I could have an IPv6 DDoS testing tool\\
\link{https://github.com/kramse/hping-2018} Hping-2018, raw support for IPv6 packets
\item Today I would recommend using MoonGen -- which support IPv6 already\\
\link{https://github.com/emmericp/MoonGen}
\end{list2}


\slide{Test-cases / Scenarios, continued Spoof Source}

Spoofed packets src=dst=target \smiley

Flooding with spoofed packet source, within hosting range

\begin{alltt}\small

-a --spoof hostname
    Use this option in order to set a fake IP  source  address,  this
    option ensures that target will not gain your real address.
\end{alltt}

\verb+hping3 -q --flood -p 80 -S -a $CUST_IP $CUST_IP+

Preferably using a test-case you know fails, to see effect

Still amazed how often this works



\slide{Test-cases / Scenarios, continued Small Fragments}

Using the built-in option -f for hping

\begin{alltt}\small
-f --frag
    Split  packets  in more fragments, this may be useful in order to test IP
    stacks fragmentation performance and to test if some packet filter is  so
    weak  that  can  be  passed using tiny fragments (anachronistic). Default
    {\bf 'virtual mtu' is 16 bytes}. see also --mtu option.
\end{alltt}

\begin{list1}
\item \verb+hping3 -q --flood -p 80 -S -f $CUST_IP+
\item Similar process with bad checksum and Bad fragment offset
\end{list1}

\slide{Rocky Horror Picture Show - 1}

\hlkimage{20cm}{smokeping-1.png}

\centerline{Really does it break from 50.000 pps SYN attack?}

\slide{Rocky Horror Picture Show - 2}

\hlkimage{20cm}{smokeping-2.png}

\centerline{Oh no 500.000 pps UDP attacks work?}

\slide{Rocky Horror Picture Show - 3}

\centerline{Oh no spoofing attacks work?}

\hlkimage{20cm}{smokeping-3.png}

\slide{Advanced and High Performance Testing}

\begin{list2}
\item Hping is not the fastest tool, which is fine when we don't want full speed
\item I can produce millions of packets, but it requires multiple CPU cores with Hping
\item We DO want to test maximum speed at some point, full 10Gbit and 14.8Million pps (Mpps)
\item Modern CPUs (for many years) support methods for sending and receiving high speed
\item Data Plane Development Kit (DPDK) is an open source software project which is very popular in this space \\
\link{https://en.wikipedia.org/wiki/Data_Plane_Development_Kit}
\end{list2}


\slide{Enter MoonGen and Dedicated Hardware}

\hlkimage{6cm}{dell-precision-3240-compact.jpg}

\begin{list2}
\item Modern computer with modern CPU and PCI x8 or better\\
I currently use a few cheap Dell devices Precision 3640 Tower / Precision 3240 Compact (not a recommendation)
\item Supported card - I am using the old Intel 82599 based 10Gbit cards
\item DPDK and software -- I use MoonGen \link{https://github.com/emmericp/MoonGen}
\item A huge thanks to Paul Emmerich emmericp for programming and publishing his works!
\item Maybe the easiest way to use DPDK currently -- "Craft all packets in user-controller Lua scripts"
\end{list2}


\slide{Running MoonGen}

\begin{alltt}

\end{alltt}

\begin{list2}
\item Installing Debian Linux went \emph{okay} -- little bit of disable secure boot, RAID/AHCI settings, ...
\item After install -- tuning and enabling Hugepages
\item Then adding a cable between the two ports on a dual card
\item Clone the repository \link{https://github.com/emmericp/MoonGen}
\end{list2}




\slide{Comparable to real DDoS?}

Tools are simple and widely available but are they actually producing same result as high-powered and advanced criminal botnets. We can confirm that the attack delivered in this test is, in fact, producing the traffic patterns very close to criminal attacks in real-life scenarios.

\begin{list2}
\item We can also monitor logs when running a single test-case
\item Gain knowledge about supporting infrastructure
\item Can your syslog infrastructure handle 800.000 events in $<$ 1 hour?
\end{list2}

Main difference are that attackers are free to switch attack types and mix them. While we try specifically to keep using one type, to see the worst and which ones that hurt the most.

I also start at the bottom, and work my way up -- while an attacker may begin attacking HTTP/HTTPS directly.

\slide{Protection -- configure your firewall}

\hlkimage{17cm}{network-layers-2022.pdf}

% My idea of a firewall -- unroll into multiple devices!



\slide{Enable More Packet filtering}

\begin{alltt}\footnotesize
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}

\begin{list2}
\item Packet filtering can be done one single packets -- stateless filtering
\item We can save information about direction and ongoing traffic -- stateful filtering/firewalling
\item \emph{Filtering} can also be setting a maximum number if packets for a protocol -- rate limit by protocol
\end{list2}


\slide{Designing the protection}

\begin{tabularx}{\textwidth-5cm}{|p{3cm}|p{7cm}|X|} \hline
{\bf Address family} & {\bf Services and ports} & {\bf Prefix}\\\hline
TCP & 25, 80, 8003, 443, 4443 & 192.0.2.0/25 \\\hline
UDP & 53 & 192.0.2.128/25 \\\hline
\end{tabularx}

\begin{tabularx}{\textwidth-5cm}{|p{3cm}|p{7cm}|X|} \hline
{\bf Protocol} & {\bf Mbps} & {\bf Prefix}\\\hline
TCP & Up to full bandwidth 10Gbps & 192.0.2.0/25 \\\hline
UDP & Less than 1Gbps & 192.0.2.128/25 \\\hline
ICMP & Less than 10Mbps & 192.0.2.0/24 \\\hline
\end{tabularx}

\begin{list2}
\item Create an address plan for your services
\item Monitor your traffic -- how much UDP and TCP do you have, roughly
\item Direction is also very important -- servers that never initiate connections have fewer requirements
\end{list2}



\slide{Config example: SNMP}

\begin{alltt}\footnotesize
snmp \{
    description "Router-CPH-01";
    location "Copenhagen, Denmark";
    contact "noc@zencurity.com";
    community yourcommunitynotmine \{
        authorization read-only;
        {\bf clients \{
               10.1.1.1/32;
               10.1.2.2/32;
        \}    }
    \}
\}
\end{alltt}

If you must use SNMPv2 then at least put it into separate VLAN! {\myalert}



%\slide{Stateless filtering Junos}
\slide{Stateless firewall filter throw stuff away}

\begin{alltt}\footnotesize
hlk@MX-CPH-02> show configuration firewall filter all | no-more
/* This is a sample, better to use BGP flowspec or BGP based RTBH */
term edgeblocker \{
    from \{
        source-address \{
            84.xx.xxx.173/32;
...
            87.xx.xxx.171/32;
        \}
        destination-address \{
            192.0.2.16/28;
        \}
        protocol [ tcp udp icmp ];
    \}
    then \{
        count edge-block;
        discard;
    \}
\}
\end{alltt}
Hint: can also leave out protocol and then it will match all protocols

\slide{Stateless firewall filter limit protocols}

\begin{alltt}\footnotesize
term limit-icmp \{
    from \{
        protocol icmp;
    \}
    then \{
        policer ICMP-100M;
        accept;
    \}
\}
term limit-udp \{
    from \{
        protocol udp;
    \}
    then \{
        policer UDP-1000M;
        accept;
    \}
\}
\end{alltt}

Routers also have extensive Class-of-Service (CoS) tools today, and in general rate limiting stuff is nice

\slide{Strict filtering for some servers, still stateless!}

\begin{alltt}\footnotesize
term some-server-allow \{
    from \{
        destination-address \{
            192.0.2.0/25;
        \}
        protocol tcp;
        destination-port [ 25 80 8003 443 4443 ];
    \} then accept;
\}
term some-server-block-unneeded \{
    from \{
        destination-address \{
            192.0.2.0/25; \}
        protocol-except icmp;  \}
    then \{ count some-server-block; discard;
    \}
\}
\end{alltt}

Wut - no UDP, yes only TCP service is used on these servers




\slide{uRPF unicast Reverse Path Forwarding}

\begin{quote}
Reverse path forwarding (RPF) is a technique used in modern routers for the purposes of ensuring loop-free forwarding of multicast packets in multicast routing and to help prevent IP address spoofing in unicast routing.
\end{quote}
Source: \link{http://en.wikipedia.org/wiki/Reverse_path_forwarding}

\begin{quote}
{\bf Configuring Unicast RPF Strict Mode}\\
In strict mode, unicast RPF checks whether the incoming packet has a source address that matches a prefix in the routing table, {\bf and whether the interface expects to receive a packet with this source address prefix.}
\end{quote}


\slide{Strict vs loose mode RPF}

\hlkimage{24cm}{uRPF-check-1.pdf}





\slide{Results from implementing -- DDoS traffic before filtering}
\hlkimage{20cm}{ddos-before-filtering}

\centerline{Only two links shown, at least 3Gbit incoming for this single IP}

\slide{DDoS traffic after filtering}
\hlkimage{20cm}{ddos-after-filtering}

\begin{list1}
\item Link toward server (next level firewall actually) about ~350Mbit outgoing
\item Knowing what it going on, is half the battle
\end{list1}


\slide{Make incremental changes}

\begin{center}
\begin{tikzpicture}[->,>=stealth',scale=0.7, transform shape]
\newlength{\boxwidth}
\setlength{\boxwidth}{0.21\paperwidth}
\newlength{\boxheight}
\setlength{\boxheight}{0.25\paperheight}
\newlength{\boxspace}
\setlength{\boxspace}{10cm}
\input{incremental-changes-flowchart.tikz}
\end{tikzpicture}
\end{center}




\slide{Improvements seen after testing}

\begin{list1}
\item Turning off unneeded features - free up resources
\item Tuning sesions, max sessions src / dst
\item Tuning firewalls, max sessions in half-open state, enabling services
\item Tuning network, drop spoofed src from inside net \smiley
\item Tuning network, can follow logs, manage network during attacks
\item ...
\item And organisation has better understanding of DDoS challenges
\item Including vendors, firewall consultants, ISPs etc.
\end{list1}

\vskip 1cm
\centerline{After tuning of {\bf existing devices/network} improves results 10-100 times}


\slide{Interesting findings}

%\hlkimage{}{}

\begin{quote}

\end{quote}

\begin{list2}
\item Customers have ISPs which have routers with 1800 days uptime\\
Seen using SNMP -- so missing critical updates, and we can affect performance
\item Even big companies still have 1Gbit internet connections, recommend getting 10Gbps
\item Most customers fail at least 3 scenarios which can be countered \emph{without loss of functionality}\\
Example we used a stateless filter to only allow TCP traffic towards a /24 with web services\\
(which don't need or want 10Gbps ICMP/UDP)

\item Ohh we lost our VPN into the environment, ohh the fw console is dead
\end{list2}



\slide{Conclusion DDoS and network attacks}

\hlkimage{10cm}{network-layers-2022.pdf}
~
\begin{list2}
\item You really should try testing, and investigate your existing devices
all of them, RTFM, upgrade firmware
\item Choose which devices does which
part - discard early to free resources for later devices to dig deeper
\item This is just one small part of your security posture, extra slides has my take on enterprise network security
\end{list2}

\myquestionspage


Thank you for coming. I'll be around until friday.



\slide{Further reading}

I have a lot of older presentations, which are open source, copy and find inspiration\\
Multiple about DDoS protection with more low level technical measures to implement at\\
{\footnotesize \link{https://github.com/kramse/security-courses/tree/master/presentations/network/introduction-ddos-testing}}

\begin{list2}
\item HLK DDoS presentations, advice for configuring routers in front of the networks\\
Multiple exercises described for performing testing with Nmap, hping3 and t50
\item TROOPERS19 HLK VXLAN recommendations about VXLAN, consider your tunnelled protocols for inspection!
\item Portscanning - start using portscans in your networks, verify how far malware and hackers can travel, and identify soft systems needing updates or isolation
\end{list2}

\slide{Concrete advice for enterprise networks}


\begin{list2}
\item Have separation -- anywhere, starting with organisation units, management networks, server networks, customers, guests, LAN, WAN, Mail, web, ...
\item Use Web proxies - do not allow HTTP directly except for a short allow list, \\
do not allow traffic to and from any new TLD
\item Use only your own DNS servers, create a pair of Unbound servers, \\
point your internal DNS running on Windows to these\\
Create filtering, logging, restrictions on these Unbound DNS servers\\
\link{https://www.nlnetlabs.nl/projects/unbound/about/} and also \link{https://pi-hole.net/}
\item Only allow SMTP via your own mail servers, create a simple forwarder if you must
\end{list2}

Allow lists are better than block list, even if it takes some time to do it

\slide{Capture data and logs!}


\begin{list2}
\item Run DNS query logs -- when client1 is infected with malware from domain malwareexample.com, then search for more clients i
nfected
\item Run Zeek and gather information about all HTTPS sessions -- captures certificates by default, and we can again search for
certificate related to malwareexample.com
\item Run network logging -- session logs in enterprise networks are GREAT \\
(country wide illegal logging is of course NOT)
\end{list2}

Make sure to check with employees, inform them!

\slide{DROP SOME TRAFFIC NOW}

\begin{list2}
\item Drop some traffic on the border of everything
\item Seriously do NOT allow Windows RPC across borders
\item Border here may be from regional country office back to HQ
\item Border may be from internet to internal networks
\item Block Windows RPC ports, 135, 137, 139, 445
\item Block DNS directly to internet, do not allow clients to use any DNS, fake 8.8.8.8 if you must internally
\item Block SMTP directly to internet
\item Create allow list for internal networks, client networks should not contact other client networks but only relevant server networks
\end{list2}

You DONT need to allow direct DNS towards internet, except from your own recursive DNS servers

If you get hacked by Windows RPC in 2022, you probably deserve it, sorry for being blunt

Best would be to analyze traffic and create allow lists, some internal networks to not need internet at all


\slide{Default permit}

%\hlkimage{}{}

One of the early implementers of firewalls Marcus J. Ranum summarized in 2005 The Six Dumbest Ideas in Computer Security \link{https://www.ranum.com/security/computer_security/editorials/dumb/} which includes the always appropriate discussion about default permit versus default deny.

\begin{quote}\small {\bf
\#1) Default Permit}\\
This dumb idea crops up in a lot of different forms; it’s incredibly persistent and difficult to eradicate. Why? Because it’s so attractive. Systems based on ”Default Permit” are the computer security equivalent of empty calories: tasty, yet fattening.

The most recognizable form in which the ”Default Permit” dumb idea manifests itself is in firewall rules. Back in the very early days of computer security, network managers would set up an internet connection and decide to secure it by turning off incoming telnet, incoming rlogin, and incoming FTP. Everything else was allowed through, hence the name ”Default Permit.” This put the security practitioner in an endless arms-race with the hackers.
\end{quote}


\begin{list2}
\item Allow all current networks today on all ports for all protocols \emph{is} an allow list \\
Which tomorrow can be split into one for TCP, UDP and remaining, and measured upon
\item Measure, improve, repeat
\end{list2}



\slide{We cannot do X}

\begin{quote}
We cannot block SMTP from internal networks, since we do not know for sure if vendor X equipment needs to send the MOST important email alert at some unspecific time in the future
\end{quote}

Cool, then we can do an allow list starting today on our border firewall:
\begin{alltt}
table <smtp-exchange> \{ $exchange1 $exchange2 $exchange3 \}
table <smtp-unknown> persist file "/firewall/mail/smtp-internal-unknown.txt"
# Regular use, allowed
pass out on egress inet proto tcp from smtp-echange to any port 25/tcp
# Unknown, remove when phased out
pass out on egress inet proto tcp from smtp-internal to any port 25/tcp
\end{alltt}

Year 0 the unknown list may be 100\% of all internal networks, but new networks added to infrastructure are NOT added, so list will shrink -- evaluate the list, and compare to network logs, did networks send ANY SMTP for 1,2,3 years?

\slide{Zeek is a framework and platform}

\hlkimage{12cm}{zeek-ids.png}

\begin{quote}
While focusing on network security monitoring, Zeek provides a comprehensive platform for more general network traffic analysis as well. Well grounded in more than 15 years of research, Zeek has successfully bridged the traditional gap between academia and operations since its inception.
\end{quote}

\link{https://www.Zeek.org/}
Does useful things out of the box using more than 10.000 script lines

\slide{Suricata IDS/IPS/NSM}
\hlkimage{6cm}{suricata.png}

\begin{quote}
Suricata is a high performance Network IDS, IPS and Network Security Monitoring engine.
\end{quote}

 \link{http://suricata-ids.org/}
 \link{http://openinfosecfoundation.org}

Suricata, Zeek og DNS Capture -- it a nice world, use it!\\
{\small\link{https://github.com/kramse/security-courses/tree/master/courses/networking/suricatazeek-workshop}}



\slide{Another definition}

% Remove?
I am also fond of this longer and technical definition from RFC4949:
\begin{quote}
\$ firewall

      1. (I) {\bf An internetwork gateway that restricts data communication
      traffic to and from one of the connected networks} (the one said to
      be "inside" the firewall) and thus protects that network's system
      resources against threats from the other network (the one that is
      said to be "outside" the firewall). (See: guard, security
      gateway.)

      2. (O) {\bf A device or system that controls the flow of traffic
      between networks using differing security postures.} Wack, J. et al (NIST), "Guidelines on Firewalls and Firewall Policy", Special Publication 800-41,
      January 2002.

      Tutorial: A firewall typically protects a smaller, secure network
      (such as a corporate LAN, or even just one host) from a larger
      network (such as the Internet). The firewall is installed at the
      point where the networks connect, and the firewall applies policy
      rules to control traffic that flows in and out of the protected
      network.
\end{quote}

\slide{Another definition}
% Remove?
\begin{quote}
\$ firewall, continued

      {\bf A firewall is not always a single computer.} For example, a
      firewall may consist of a pair of filtering routers and one or
      more proxy servers running on one or more bastion hosts, all
      connected to a small, dedicated LAN (see: buffer zone) between the
      two routers.

      The external router blocks attacks that use IP to
      break security (IP address spoofing, source routing, packet
      fragments), while proxy servers block attacks that would exploit a
      vulnerability in a higher-layer protocol or service. The internal
      router blocks traffic from leaving the protected network except
      through the proxy servers.

      The difficult part is defining criteria by which packets are denied passage through the firewall, because
      a firewall not only needs to keep unauthorized traffic (i.e., intruders) out, but usually also needs to let authorized traffic
      pass both in and out.
\end{quote}


\slide{Routing Security}


\begin{list2}
\item Use MD5 passwords or better authentication for routing protocols {\myalert}
\item TTL Security -- avoid routed packets
\item Max prefix -- of course, only allow expected networks
\item Prefix filtering -- only parts of IPv6 space is used
\item TCP Authentication Option [RFC 5925] replaces TCP MD5 [RFC 2385]
\item Turn ON RPKI for both IPv4 and IPv6 prefixes, {\myalert} \\
\link{https://nlnetlabs.nl/projects/rpki/about/}
\item Drop bogons on IPv4 and IPv6, article with multiple references YMMV\\
\link{https://theinternetprotocolblog.wordpress.com/2020/01/15/some-notes-on-ipv6-bogon-filtering/}
\end{list2}


\slide{Mutually Agreed Norms for Routing Security (MANRS)}

%\hlkimage{2cm}{MANRS_square.png}

\begin{quote}
  Mutually Agreed Norms for Routing Security (MANRS) is a global initiative, supported by the Internet Society, that provides crucial fixes to reduce the most common routing threats. ﻿
\end{quote}
Source: {\small\link{https://www.manrs.org/wp-content/uploads/2018/09/MANRS_PDF_Sep2016.pdf}}

\begin{list2}
\item Problems related to incorrect routing information
\item Problems related to traffic with spoofed source IP addresses
\item Problems related to coordination and collaboration between network operators
\item Also BCP38 RFC2827 \emph{Network Ingress Filtering: Defeating Denial of Service Attacks
which employ IP Source Address Spoofing}
\end{list2}

You should all ask your internet providers if they know about MANRS, and follow it. We should ask our government and institutions to support and follow MANRS and good practices for network on the Internet


\end{document}
