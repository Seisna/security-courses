\documentclass[Screen16to9,17pt]{foils}
\usepackage{zencurity-slides}

\externaldocument{system-security-exercises}
\selectlanguage{english}

\begin{document}

\mytitlepage
{7. Malware, Intrusion, Vulnerabilities}
{KEA Kompetence Computer Systems Security \the\year}

\slide{Goals for part I}

\hlkimage{6cm}{thomas-galler-hZ3uF1-z2Qc-unsplash.jpg}

 
\begin{list2}
\item Introduce the term malware -- malicious software
\item Look at some examples
\item Try out buffer overflows
\end{list2}

{\small Photo by Thomas Galler on Unsplash}

\slide{Plan for part I}

\begin{list1}
\item Subjects
\begin{list2}
  \item Trojan horses, Rootkits, computer viruses
  \item Computer worms, from Morris Worm to today
  \item Bots and botnets
  \item Ransomware
  \item Phishing and spear phishing
  \item Sandboxing, Java and browsers
  \item Penetration testing
  \item Common Vulnerabilities and Exposure CVE
  \item Common Weakness Enumeration
\end{list2}
\item Exercises
\begin{list2}
\item Perform privilege escalation using files
\item Anti-virus and ”endpoint security”
\end{list2}
\end{list1}



\slide{Reading Summary}

\begin{list1}
\item Read Bishop chapter 23: Malware
\item Skim Bishop chapter 24: Vulnerability Analysis
\item Skim Forensic Discovery chapter 5: Systems and Subversion, Chapter 6:Malware Analysis Basics
\item Smashing The Stack For Fun And Profit, Bypassing non-executable-stack during exploitation using return-to-libc, Basic Integer Overflows, Return-Oriented Programming

\end{list1}


\slide{Trojan horses}

\begin{list1}
\item {\bf Definition 23-1} \emph{Malicious logic}, more commonly called \emph{malware}, is a set\\
 of instructions that cause a site's security policy to be violated.
\item {\bf Definition 23-2} A \emph{Trojan horse} is a program with an overt (documented or\\
known) purpose and a covert (undocumented or unexpected) purpose.

\item Lots of free applications on Android are in fact trojans

\item Book also mentions the Ken Thompson example with login program and compiler\\Insert Login backdoor, by inserting backdoor to notice when compiling compiler \smiley
\end{list1}

The history lesson
\url{https://en.wikipedia.org/wiki/Trojan_Horse}\\
\url{https://en.wikipedia.org/wiki/Trojan_horse_(computing)}


\slide{Rootkits}

\begin{list1}
\item Rootkits hides information from everyone, even the root user
\item Installed when hackers gained access to systems
\item Often installed modified versions of programs, so ls wouldn't show the hackers files, ps wouldnt show the processes etc.
\item Could also be installed as a kernel module, that would hide from any program, not only a modified subset
\item Log zappers were often part of the kits
\item Programs such as AIDE can help keep integrity of installed programs:\\
\link{https://en.wikipedia.org/wiki/Advanced_Intrusion_Detection_Environment}
\end{list1}


\slide{A simple trojan}


\begin{list1}
\item Our book has example on page 775, creating a copy of a shell in \verb+/tmp/.xxsh+
\item This example wont work on modern Linux systems, running Bourne Again BASH shell, \\but with dash it does
\item Demo time: logging in as root, then:
\end{list1}

\begin{alltt}
root@debian:~# rm /tmp/.xxsh
root@debian:~# cp /bin/dash /tmp/.xxsh
root@debian:~# chmod +sw /tmp/.xxsh
\end{alltt}

\begin{alltt}
hlk@debian:~$ /tmp/.xxsh
# id
uid=1000(hlk) gid=1000(hlk) {\bf euid=0(root) egid=0(root)} groups=0(root),24(cdrom),
25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev)
#
\end{alltt}



\exercise{ex:priv-esc-cron}



\slide{Computer Viruses}

\begin{list1}
\item {\bf Definition 23-4} A \emph{computer virus} is a program that inserts (a possibly transformed version of) itself into one or more files and then performs some (possibly null) action.
\item Would spread through floppy disks and boot sector
\item Today more virus are spread through network shares, networked file systems
\begin{list2}
\item Boot sector virus - when booting a PC infects
\item A executable - exe files, similar types on PC platform .scr screensavers, .vbs visual basic scripts etc. Linux shell archives shar files.
\item Data - macro virus, found in Microsoft Office formats .doc etc.
\end{list2}
\item Polymorphic virus change their fingerprint/code during execution/infection
\end{list1}


\slide{Computer worms}

\begin{list1}
\item {\bf Definition 23-14} A \emph{computer worm} is a program that copies itself from one computer to another.
\item Computer worms has existed since research began mid-1970s
\item Morris Worm from November 2, 1988 was a famous example
\vskip 2cm
\item Virus, trojan or worm?\\
Unless you work specifically in the computer virus industry, call it all malware

\end{list1}


\slide{The Internet Worm 2. nov 1988}

\begin{list1}
\item Exploited the following vulnerabilities
\begin{list2}
\item buffer overflow in fingerd - VAX code
\item Sendmail - DEBUG functionality
\item Trust between systems: rsh, rexec, ...
\item Bad passwords
\end{list2}
\item Contained camouflage!
\begin{list2}
\item Program name set to 'sh'
\item Used fork() to switch PID regularly
\item Password cracking using intern list of 432 words and /usr/dict/words
\item Found systems to infect in /etc/hosts.equiv, .rhosts, .forward, netstat ...
\end{list2}
\item Made byRobert T. Morris, Jr.
\end{list1}


\slide{Stuxnet}

\begin{list1}
\item Worm in 2010 intended to infect Iran nuclear program
\item Target was the uranium enrichment process
\item Infected other industrial sites
\item SCADA, and Industrial Control Systems (ICS) are becoming very important for whole countries
\item A small \emph{community} of consultants work in these \emph{isolated} networks, but can be used as infection vector - they visit multiple sites
\item More can be found in \url{https://en.wikipedia.org/wiki/Stuxnet}
\end{list1}




\slide{Bots and botnets}

\begin{list1}
\item {\bf Definition 23-15} A \emph{bot} is malware that carries out some action in coordination with other bots. The attacker, called a \emph{botmaster}, controls the bots from one or more systems called \emph{command and control (C\&C) servers} or \emph{motherships}. They communicate over paths called \emph{C\&C channels}. A collection of bots is a \emph{botnet}.
\item Internet Relay Chat has been popular for control channel to botnets
\item Botnets are popular for spamming campaigns or Distributed Denial of Service (DDoS) attacks
\item The site \link{https://malware.lu/} has interesting reads about botnets, and taking over the botnet infrastructures
\end{list1}



\slide{Ransomware}


\begin{list1}
\item {\bf Defition 23-21} \emph{Ransomware} is malware that inhibits the use of resources until a ransom usually monetary, is paid.
\item Book mentions 1989 example, PC CYBORG targetting PC/DOS computers
\item Uses cryptography to render data unreadable
\item Has become a huge problem for enterprises during the last 5-10 years
\item Often uses crypto-currencies today, like BitCoin (BTC) for payment
\item Often contains errors so decryption is impossible, or possible without payment!
\end{list1}


\slide{Phishing and spear phishing}


\begin{list1}
\item {\bf Definition 23-22} \emph{Phishing} is the act of impersonating a legitimate entity, typically a website associated with a business, in order to obtain information such as passwords, credit card numbers, and other private information without authorization
\item Example creating a fake bank website and make customers try to login
\item {\bf Definition 23-23} \emph{Spearphishing} is a phishing attack tailored for a particular victim.
\end{list1}


\slide{Malware defenses}


\begin{list1}
\item {\bf Theorem 23.2} It is undecidable whether an arbitrary program contains a malicious logic.
\item Scanning defenses,
\begin{list2}
\item Check disk and memory for known bad malware signatures
\item Check for changes - integrity protection
\end{list2}
\item Behavioural - what does a malware do, that normal programs dont
\item Static analysis - what does a program normally do, what does a malware do
\item Containment - change the environment to be more restricted
\end{list1}

\centerline{I dont trust or use anti-virus programs, fight me}

\slide{Sandboxing, Java and browsers}


\begin{list1}
\item Executing programs with less access is good
\item Executing code in a sandbox and observing behaviour is one strategy
\item Firewall vendors and mail systems can send code out for analysis
\item Often sandboxes can be escaped, multiple examples
\item Java Virtual Machine was designed to be safe for internet use, but has proven to be very vulnerable
\end{list1}


\exercise{ex:anti-virus-end-point-security}






\slide{Vulnerability Analysis}


\begin{list1}
\item \emph{Vulnerability} or security flaw
\item Exploiting the vulnerability happens by an attacker
\item A program or script used for this is called an \emph{exploit}
\end{list1}





\slide{Hacker -- cracker}

{\bfseries Short answer -- dont discuss this}

%Det lidt længere svar:\\
Yes, originally there was another meaning to hacker, but the media has perverted it and today, and since early 1990s it has meant breaking into stuff for the public

{\color{red}\hlkbig Today a hacker breaks into systems!}

Reference. Spafford, Cheswick, Garfinkel, Stoll, \ldots
- wrote about this and it was lost

Story is interesting and the old meaning is ALSO used in smaller communities, like hacker spaces full of hackers - doing fun and interesting stuff
\begin{list2}
\item \emph{Cuckoo's Egg: Tracking a Spy Through the Maze of Computer
 Espionage},  Clifford Stoll
\item \emph{Hackers: Heroes of the Computer Revolution},
Steven Levy
\item \emph{Practical Unix and Internet Security},
Simson Garfinkel, Gene Spafford, Alan Schwartz
\end{list2}



\slide{Penetration testing}


\begin{list1}
\item Verification of the system in place
\item Examines procedural and operational controls
\item Is the system in fact installed and operated as expected
\item Example, is the firewall even enabled?
\item Penetration testing methodologies\\
\url{https://www.owasp.org/index.php/Penetration_testing_methodologies}
\end{list1}



\slide{Agreements for testing networks}

\begin{quote}\small
Danish Criminal Code\\
Straffelovens paragraf 263 Stk. 2. Med bøde eller fængsel indtil 1 år og 6 måneder straffes den, der uberettiget skaffer sig adgang til en andens oplysninger eller programmer, der er bestemt til at bruges i et informationssystem.
\end{quote}

Hacking can result in:
\begin{list2}
\item Getting your devices confiscated by the police
\item Paying damages to persons or businesses
\item If older getting a fine and a record -- even jail perhaps
\item Getting a criminal record, making it hard to travel to some countries and working in security
\item Fear of terror has increased the focus -- so dont step over bounds!
\end{list2}

Asking for permission and getting an OK before doing invasive tests, always!

\slide{ISC2 code of ethics}

\hlkimage{23cm}{isc2-code-of-ethics.png}

CISSP certified people sign papers to this extent.\\
\link{https://www.isc2.org/ethics/default.aspx}


\slide{Why even do security testing?}

\begin{list1}
\item Lots of security problems
\item Pentesting may be a requirement from external partners -- example VISA PCI standard
\end{list1}

\begin{list2}
\item Boss asking: should we do a security test?
\item CIO: hmm, okay
\item IT Admins: *sigh* -- I know the security sucks in places!
\item Its not your systems -- dont take the criticism personal, but as an opportunity to get things improved
\end{list2}

\vskip 2cm
\centerline{\Large Many see the benefits after doing a pentest, so try it!}


\slide{Introduction -- terms and technologies}

\begin{list1}
\item Sikkerhedstest / penetrationstest\\
Afprøvning af sikkerhedsforanstaltninger og evaluering af
sikkerhedsniveau ved hjælp af IT systemer og \emph{hackerværktøjer}
\item Kaldes tillige sårbarhedstest, sårbarhedsanalyse m.v.
\item Ekstern -- udføres fra internet, typisk over WAN
\item Intern, inside, on-site -- udføres hos kunden, typisk over LAN og
  bag firewall
\end{list1}

\link{https://www.google.com/search?q=sikkerhedstest}

\slide{Blackbox, greybox og whitebox}

\begin{list2}
\item Forudsætninger og forudgående kendskab til miljøet
\item Black Box testen involverer en sikkerhedstestning af et netværk uden
nogen form for insider viden om systemet udover den IP-adresse, der
ønskes testet. Dette svarer til den situation en fjendtlig hacker vil
stå i og giver derfor det mest realistiske billede af netværkets
sårbarhed overfor angreb udefra. Men er dårlig ressourceudnyttelse.
\item I den anden ende  af skalaen har vi White Box testen. I dette tilfælde
har sikkerhedsspecialisten både før og under testen fuld adgang til
alle informationer om det scannede netværk. Analysen vil derfor kunne
afsløre sårbarheder, der ikke umiddelbart er synlige for en almindelig
angriber. En White Box test er typisk mere omfattende end en Black Box
test og forudsætter en højere grad af deltagelse fra kundens side, men
giver en meget detaljeret og tilbundsgående undersøgelse.

\item En Grey Box test er som navnet siger et kompromis mellem en White Box
og en Black Box test. Typisk vil sikkerhedsspecialisten udover en
IP-adresse være i besiddelse af de mest grundlæggende
systemoplysninger: Hvilken type af server der er tale om (mail-,
webserver eller andet), operativsystemet og eventuelt om der er
opstillet en firewall foran serveren.
\end{list2}


\slide{Benefits of having a planned security test done}

\begin{quote}
Goal of testing is to reduce risk for the systems and secure the organisation\\ from unexpected loss of data, image and increased costs.
\end{quote}

\begin{list1}
\item Målgrupper:
\begin{list2}
\item IT-afdeling og teknisk personale
\item Ledelse, koncernledelse
\item Eksterne revisorer, VISA PCI, offentligheden
\end{list2}
\item Afleveringer:
\begin{list2}
\item Rapport med tekniske anbefalinger og opsummering/checklister
\item Executive summary
\end{list2}
\end{list1}

Goal is not to find a scape goat to blame -- management allocates resources

If security is below in places more resources may be needed.


\slide{Rules of engagement -- regler og etik for sikkerhedstest}

\begin{list2}
\item NB: Stor forskel på Danmark og udlandet!
\item Sikkerhedskonsulenten må ikke give anledning til nye sårbarheder
  som følge af testen
\item Sikkerhedskonsulenten må ikke installere ny software på
  systemer uden forudgående aftale
\item Sikkerhedskonsulenten efterlader ikke usikre
  systemadministratorkonti eller tilsvarende efter testen
\item Sikkerhedskonsulenten tager altid kontakt til kunden ved
  høj-risiko sårbarheder
\item Er man hyret til netværkssikkerhed kan man godt \emph{snuse}
  lidt rundt om systemerne under test -- der kan være et sårbart
  testsystem lige ved siden af
\item Min holdning er at ved opdagelse af åbenlyse sikkerhedsrisici
  dokumenteres disse i rapporten, uanset scope for opgaven ellers
\end{list2}

\centerline{Det er en balancegang}


\slide{Udvælgelse af systemer til test}

\hlkimage{11cm}{overview-routing-customer-2015.png}

\begin{list2}
\item Routere på netværksvejen til kritiske systemer og netværk -
  tilgængelighed
\item Firewall -- begrænses trafikken tilstrækkeligt
\item Mailservere -- tillades relaying udefra
\item Webservere -- kan der afvikles kode på systemet, downloades data
\end{list2}





\slide{Vulnerabilities - CVE}

\begin{list1}
\item Common Vulnerabilities and Exposures (CVE):
  \begin{list2}
  \item classification
  \item identification
  \end{list2}
\item When discovered each vuln gets a CVE ID
\item CVE maintained by MITRE - not-for-profit
org for research and development in the USA.
\item National Vulnerability Database search for CVE.
\item Sources: \link{http://cve.mitre.org/} og \link{http://nvd.nist.gov}
\item also checkout OWASP Top-10 \link{http://www.owasp.org/}
\end{list1}

\slide{Sample vulnerabilities}

\begin{list1}
\item \small CVE-2000-0884\\
IIS 4.0 and 5.0 allows remote attackers to read documents outside of
the web root, and possibly execute arbitrary commands, via malformed
URLs that contain UNICODE encoded characters, aka the "Web Server
Folder Traversal" vulnerability.

\item \small CVE-2002-1182\\
IIS 5.0 and 5.1 allows remote attackers to cause a denial of service
(crash) via malformed WebDAV requests that cause a large amount of
memory to be assigned.

\item Source:\\
\link{http://cve.mitre.org/ - CVE}
\end{list1}

\centerline{And updates from vendors reference these too! A closed loop}

\slide{CWE Common Weakness Enumeration}

\hlkimage{18cm}{cwe-mitre-org.png}
\link{http://cwe.mitre.org/}

\slide{CWE/SANS Monster mitigations}

\hlkimage{13cm}{cwe-monster-mitigations.png}

Source:
\link{http://cwe.mitre.org/top25/index.html}





\slide{Teknisk hvad er hacking}

\hlkimage{12cm}{buffer-overflow-3.pdf}


\slide{Internet i dag}

\hlkimage{10cm}{images/server-client.pdf}

\begin{list1}
\item Klienter og servere
\item Rødder i akademiske miljøer
\item Protokoller der er op til 20 år gamle
\item Meget lidt kryptering, mest på http til brug ved e-handel
\end{list1}

\slide{Trinity breaking in}

\hlkimage{14cm}{trinity-nmapscreen-hd-cropscale-418x250.jpg}
Meget realistisk - sådan foregår det næsten:\\
\link{https://nmap.org/movies/}\\
\link{https://youtu.be/51lGCTgqE_w}



\slide{Hacking er magi}

\hlkimage{5cm}{wizard_in_blue_hat.png}

\vskip 1 cm

\centerline{Hacking ligner indimellem  magi}


\slide{Hacking er ikke magi}

\hlkimage{15cm}{ninjas.png}

\vskip 1 cm
\centerline{Hacking kræver blot lidt ninja-træning}

\slide{Hacking eksempel -- det er ikke magi}

\begin{list1}
\item MAC filtrering på trådløse netværk
\item Alle netkort har en MAC adresse -- BRÆNDT ind i kortet fra fabrikken
\item Mange trådløse Access Points kan filtrere MAC adresser
\item Kun kort som er på listen over godkendte adresser tillades adgang til netværket

\item Det virker dog ikke \smiley
\item De fleste netkort tillader at man overskriver denne adresse midlertidigt
\item og man kan aflæse de godkendte når de er aktive på netværket
\item Derudover har der ofte været fejl i implementeringen af MAC filtrering
\end{list1}

\slide{Myten om MAC filtrering}

\begin{list1}
\item Eksemplet med MAC filtrering er en af de mange myter
\item Hvorfor sker det?
\item Marketing -- producenterne sætter store mærkater på æskerne
\item Manglende indsigt -- forbrugerne kender reelt ikke koncepterne
\item Hvad \emph{er} en MAC adresse egentlig
\item Relativt få har forudsætningerne for at gennemskue dårlig sikkerhed
\item Løsninger?

\item Udbrede viden om usikre metoder til at sikre data og computere
\item Udbrede viden om sikre metoder til at sikre data og computere
\end{list1}

\slide{MAC filtrering}

\hlkimage{12cm}{stupid-security.jpg}


\slide{OSI og Internet modellerne}

\hlkimage{10cm,angle=90}{images/compare-osi-ip.pdf}

\slide{Kali Linux the pentest toolbox}

\hlkimage{14cm}{kali-linux.png}

\begin{list1}
\item  Kali \link{http://www.kali.org/}
\item 100.000s of videos on youtube alone, searching for kali and \$TOOL
\item Also versions for Raspberry Pi, mobile and other small computers
\end{list1}


\slide{Hackertools are for everyone!}
% måske til reference afsnit?
\hlkimage{3cm}{hackers_JOLIE+1995.jpg}

\begin{list2}
\item Alle bruger nogenlunde de samme værktøjer, se også \link{http://www.sectools.org/}
\item Portscanner Nmap, Nping -- tester porte, godt til firewall admins \link{https://nmap.org}
\item Generel sårbarhedsscanner Metasploit Framework \link{https://www.metasploit.com/}
\item Specielle scannere -- wifi Aircrack-ng, web Burpsuite, Nikto, Skipfish \link{http://portswigger.net/burp/}
\item Wireshark avanceret netværkssniffer -- \link{https://www.wireshark.org/}
\item og scripting, PowerShell, Unix shell, Perl, Python, Ruby, \ldots
\end{list2}

Picture: Angelina Jolie, as Acid Burn in Hackers 1995

\slide{Heartbleed hacking}

\begin{alltt}\footnotesize
  06b0: 2D 63 61 63 68 65 0D 0A 43 61 63 68 65 2D 43 6F  -cache..Cache-Co
  06c0: 6E 74 72 6F 6C 3A 20 6E 6F 2D 63 61 63 68 65 0D  ntrol: no-cache.
  06d0: 0A 0D 0A 61 63 74 69 6F 6E 3D 67 63 5F 69 6E 73  ...action=gc_ins
  06e0: 65 72 74 5F 6F 72 64 65 72 26 62 69 6C 6C 6E 6F  ert_order&billno
  06f0: 3D 50 5A 4B 31 31 30 31 26 70 61 79 6D 65 6E 74  =PZK1101&payment
  0700: 5F 69 64 3D 31 26 63 61 72 64 5F 6E 75 6D 62 65  _id=1&{\bf card_numbe}
  0710: XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX  {\bf r=4060xxxx413xxx}
  0720: 39 36 26 63 61 72 64 5F 65 78 70 5F 6D 6F 6E 74  {\bf 96&card_exp_mont}
  0730: 68 3D 30 32 26 63 61 72 64 5F 65 78 70 5F 79 65  {\bf h=02&card_exp_ye}
  0740: 61 72 3D 31 37 26 63 61 72 64 5F 63 76 6E 3D 31  {\bf ar=17&card_cvn=1}
  0750: 30 39 F8 6C 1B E5 72 CA 61 4D 06 4E B3 54 BC DA  {\bf 09}.l..r.aM.N.T..
\end{alltt}

\begin{list2}
\item Obtained using Heartbleed proof of concepts -- Gave full credit card details
\item "Can XXX be exploited" -- yes, clearly! PoCs ARE needed\\
Without PoCs even Akamai wouldn't have repaired completely!
\item The internet was ALMOST fooled into thinking getting private keys\\
 from Heartbleed was not possible -- scary indeed.
\end{list2}

\slide{Scan for Heartbleed and SSLv2/SSLv3}

\hlkimage{6cm}{nmap-sslv2.png}

\begin{list1}
\item \verb+nmap -p 443 --script ssl-heartbleed <target>+\\
\link{https://nmap.org/nsedoc/scripts/ssl-heartbleed.html}
\item \verb+masscan 0.0.0.0/0 -p0-65535  --heartbleed+\\
\link{https://github.com/robertdavidgraham/masscan}
\end{list1}

\centerline{Almost every new vulnerability will have Nmap recipe}


\slide{What happens now?}

\begin{list1}
\item Think like a hacker
\item Recon phase -- gather information reconnaissance
\begin{list2}
\item Traceroute, Whois, DNS lookups
\item Ping sweep, port scan
\item OS detection -- TCP/IP and banner grabbing
\item Service scan -- rpcinfo, netbios, ...
\item telnet/netcat interact with services
\end{list2}
\end{list1}



\slide{Hackerlab opsætning}

\hlkimage{8cm}{hacklab-1.png}

\begin{list2}
\item Hardware: en moderne laptop med CPU der kan bruge virtualisering\\
Husk at slå virtualisering til i BIOS
\item Software: dit favoritoperativsystem, Windows, Mac, Linux
\item Virtualiseringssoftware: VMware, Virtual box, vælg selv
\item Hackersoftware: Kali som Virtual Machine \link{https://www.kali.org/}
\item Soft targets: Metasploitable, Windows 2000, Windows XP, ...
\end{list2}

\slide{Really do Nmap your world}

\hlkimage{8cm}{nmap-zenmap.png}

\begin{list2}
\item Nmap is a port scanner, but does more
\item Finding your own infrastructure available from the guest network?
\item See your printers having all the protocols enabled AND a wireless?
\end{list2}

\slide{Network mapping}

\hlkimage{13cm}{images/network-example.pdf}

\begin{list1}
\item Ved brug af traceroute og tilsvarende programmer kan man ofte
  udlede topologien i det netværk man undersøger
\item Levetiden (TTL) for en pakke tælles ned på hver router, sættes denne lavt
  opnår man at pakken \emph{timer ud} -- besked fra hver router på vejen
\item Default Unix er UDP pakker, Windows tracert ICMP pakker
\end{list1}


\slide{Buffer overflows et C problem}

\begin{list1}
\item {\bfseries Et buffer overflow}
er det der sker når man skriver flere data end der er afsat plads til
i en buffer, et dataområde. Typisk vil programmet gå ned, men i visse
tilfælde kan en angriber overskrive returadresser for funktionskald og
overtage kontrollen.
\item {\bfseries Stack protection}
er et udtryk for de systemer der ved hjælp af operativsystemer,
programbiblioteker og lign. beskytter stakken med returadresser og
andre variable mod overskrivning gennem buffer overflows. StackGuard
og Propolice er nogle af de mest kendte.
\end{list1}

\slide{Buffers and stacks, simplified}

\hlkimage{18cm}{buffer-overflow-1.pdf}

\begin{alltt}\small
main(int argc, char **argv)
\{      char buf[200];
        strcpy(buf, argv[1]);
        printf("%s\textbackslash{}n",buf);
\}
\end{alltt}

\slide{Overflow -- segmentation fault}

\hlkimage{18cm}{buffer-overflow-2.pdf}


\begin{list2}
\item Bad function overwrites return value!
\item Control return address
\item Run shellcode from buffer, or from other place
\end{list2}


\slide{Exploits -- udnyttelse af sårbarheder}

\begin{list2}
\item Exploit/exploitprogram er udnytter en sårbarhed rettet mod et specifikt system.
\item Kan være 5 linier eller flere sider ofte Perl, Python eller et C program
\end{list2}

Eksempel demo i Perl, uddrag:
\begin{alltt}\footnotesize
$buffer = "";
$null = "\textbackslash{}x00";
$nop = "\textbackslash{}x90";

$nopsize = 1;
$len = 201; // what is needed to overflow, maybe 201, maybe more!
$the_shell_pointer = 0x01101d48; // address where shellcode is
# Fill buffer
for ($i = 1; $i < $len;$i += $nopsize) \{
    $buffer .= $nop;
\}
$address = pack('l', $the_shell_pointer);
$buffer .= $address;
exec "$program", "$buffer";
\end{alltt}


\slide{Hvordan finder man buffer overflow, og andre fejl}

\begin{list1}
\item Black box testing
\item Closed source reverse engineering
\item White box testing
\item Open source betyder man kan læse og analysere koden
\item Source code review -- automatisk eller manuelt
\item Fejl kan findes ved at prøve sig frem -- fuzzing
\item Exploits virker typisk mod specifikke versioner af software
\end{list1}


\slide{Privilegier least privilege}

\begin{list1}
\item Hvorfor afvikle applikationer med administrationsrettigheder -
  hvis der kun skal læses fra eksempelvis en database?
\item {\bfseries Least privilege}
betyder at man afvikler kode med det mest
restriktive sæt af privileger -- kun lige nok til at
opgaven kan udføres
\item Dette praktiseres sjældent i webløsninger i Danmark
\end{list1}

\slide{Privilegier privilege escalation}
\begin{list1}
\item {\bfseries Privilege escalation} er når man på en eller anden vis
opnår højere privileger på et system, eksempelvis som
følge af fejl i programmer der afvikles med højere
privilegier. Derfor HTTPD servere på Unix afvikles som
nobody -- ingen specielle rettigheder.
\item En angriber der kan afvikle vilkårlige kommandoer kan ofte finde
  en sårbarhed som kan udnyttes lokalt -- få rettigheder = lille skade
\end{list1}

Eksempel: man finder exploit som giver kommandolinieadgang til et system
som almindelig bruger

Ved at bruge en local exploit, Linuxkernen kan man måske forårsage fejl
og opnå root, GNU Screen med SUID bit eksempelvis


\slide{Local vs. remote exploits}

\begin{list1}
\item {\bfseries Local vs. remote}
angiver om et exploit er rettet mod
en sårbarhed lokalt på maskinen, eksempelvis
opnå højere privilegier, eller beregnet
til at udnytter sårbarheder over netværk
\item {\bfseries Remote root exploit}
- den type man frygter mest, idet
det er et exploit program der når det afvikles giver
angriberen fuld kontrol, root user er administrator
på Unix, over netværket.
\item {\bfseries Zero-day exploits} dem som ikke offentliggøres -- dem
  som hackere holder for sig selv. Dag 0 henviser til at ingen kender
  til dem før de offentliggøres og ofte er der umiddelbart ingen
  rettelser til de sårbarheder
\end{list1}




\slide{Demo: Insecure programming buffer overflows 101}

Only if we have time!

\begin{list2}
\item Small demo program \verb+demo.c+
\item Has built-in shell code
\item Compile:
\verb+gcc -o demo demo.c+
\item Run program
\verb+./demo test+
\item Goal: Break and insert return address
\end{list2}

\begin{alltt}\small
main(int argc, char **argv)
\{      char buf[10];
        strcpy(buf, argv[1]);
        printf("%s\textbackslash{}n",buf);
\}
the_shell()
\{  system("/bin/sh");  \}
\end{alltt}


\slide{GDB GNU Debugger}

\begin{list1}
\item GNU compileren og debuggeren fungerer ok, men check andre!
\item Prøv \verb+gdb ./demo+ og kør derefter programmet fra \emph{gdb prompten}
med  \verb+run 1234+
\item Når I således ved hvor lang strengen skal være kan I fortsætte
  med \verb+nm+ kommandoen -- til at finde adressen på
  \verb+the_shell+\\
Skriv \verb+nm demo | grep shell+

\item Kunsten er således at generere en streng der er præcist så lang
  at man får lagt denne adresse ind på det \emph{rigtige sted}.
\item Perl kan erstatte AAAAA således \verb+`perl -e "print 'A'x10"`+
\end{list1}


\slide{Debugging af C med GDB}

\begin{list1}
\item Vi laver sammen en session med GDB
\item Afprøvning med diverse input
\begin{list2}
\item \verb+./demo langstrengsomgiverproblemerforprogrammethvorformon+
\item \verb+gdb demo+ efterfulgt af run med parametre\\
\verb+run AAAAAAAAAAAAAAAAAAAAAAAAAAAAA+
\end{list2}
\end{list1}

{\bfseries Hjælp:}\\
Kompiler programmet og kald det fra kommandolinien med
\verb+./demo 123456...7689+ indtil det dør ... derefter prøver I det
samme i GDB

Hvad sker der? Avancerede brugere kan ændre
\verb+strcpy+ til \verb+strncpy+


\slide{GDB output}

\begin{alltt}\footnotesize
hlk@bigfoot:demo$ gdb demo
GNU gdb 5.3-20030128 (Apple version gdb-330.1) (Fri Jul 16 21:42:28 GMT 2004)
Copyright 2003 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "powerpc-apple-darwin".
Reading symbols for shared libraries .. done
(gdb) {\bf run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}
Starting program: /Volumes/userdata/projects/security/exploit/demo/demo AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Reading symbols for shared libraries . done
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal EXC_BAD_ACCESS, Could not access memory.
{\bf 0x41414140} in ?? ()
(gdb)
\end{alltt}

\slide{GDB output Debian 9 stretch}

\begin{alltt}\footnotesize
hlk@debian:~/demo$ gdb demo
GNU gdb (Debian 7.12-6) 7.12.0.20161007-git
Copyright (C) 2016 Free Software Foundation, Inc.
...
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from demo...(no debugging symbols found)...done.
(gdb) run `perl -e "print 'A'x24"`
Starting program: /home/hlk/demo/demo `perl -e "print 'A'x24"`
AAAAAAAAAAAAAAAAAAAAAAAA

Program received signal SIGSEGV, Segmentation fault.
0x0000414141414141 in ?? ()
(gdb)
\end{alltt}

\exercise{ex:bufferoverflow}


\slide{Integer overflows}

\begin{alltt}\footnotesize
----[ 1.2 What is an integer overflow?
Since an integer is a fixed size (32 bits for the purposes of this paper),
there is a fixed maximum value it can store.  When an attempt is made to
store a value greater than this maximum value it is known as an integer
overflow.  The ISO C99 standard says that an integer overflow causes
"undefined behaviour", meaning that compilers conforming to the standard
may do anything they like from completely ignoring the overflow to aborting
the program.  Most compilers seem to ignore the overflow, resulting in an
unexpected or erroneous result being stored.

----[ 1.3 Why can they be dangerous?
Integer overflows cannot be detected after they have happened, so there is
not way for an application to tell if a result it has calculated previously
is in fact correct.  This can get dangerous if the calculation has to do
with the size of a buffer or how far into an array to index.  Of course
most integer overflows are not exploitable because memory is not being
directly overwritten, but sometimes they can lead to other classes of bugs,
frequently buffer overflows.  As well as this, integer overflows can be
difficult to spot, so even well audited code can spring surprises.
\end{alltt}

Source:
\emph{Basic Integer Overflows} by blexim



\slide{Integer overflows}

\begin{alltt}\footnotesize
------[ 2.2.1 Exploiting
One of the most common ways arithmetic overflows can be exploited is when a
calculation is made about how large a buffer must be allocated.  Often a
program must allocate space for an array of objects, so it uses the
malloc(3) or calloc(3) routines to reserve the space and calculates how
much space is needed by multiplying the number of elements by the size of
an object.  As has been previously shown, if we are able to control either
of these operands (number of elements or object size) we may be able to
mis-size the buffer, as the following code fragment shows:
    int myfunction(int *array, int len)\{
        int *myarray, i;
        myarray = malloc(len * sizeof(int));    /* [1] */
        if(myarray == NULL)\{
            return -1; \}
        for(i = 0; i < len; i++)\{              /* [2] */
            myarray[i] = array[i]; \}
        return myarray;
    \}
  \end{alltt}

  Source:
  \emph{Basic Integer Overflows} by blexim



\slide{Return-to-libc}

\begin{alltt}\footnotesize
  How does the technique look on the stack - a basic view will be something
  similar to this:
  [-] Buffer overflow smashing EIP and jumping forward to shellcode
                                                   1                    2
  |-------------------|-----------|------------|---------------------------|
  |             AAAAAAAAAAAA      |    RET     |        SHELLCODE          |
  |-------------------|-----------|------------|---------------------------|
                     args              EBP        EIP
  [-] Buffer overflow doing return-to-libc and executing system function
                                                    1             2         3
  |-------------------------------|------------|--------------|------------|
  |            buffer             |   system   |   fake_ret   |   /bin/sh  |
  |-------------------------------|------------|--------------|------------|
                     args               EBP        EIP
\end{alltt}
Instead of putting code on the stack, that cannot be executed, put on a fake return address which goes to a function in the C library, like \verb+system("/bin/sh")+

Source:
\emph{Bypassing non-executable-stack during exploitation using return-to-libc}
 by c0ntex | c0ntex[at]gmail.com

\slide{Return-oriented programming (ROP)}

\begin{list1}
\item Nogle ting bliver også sværere - buffer overflow protection
\item Teknologier som Address Space Layout Randomization ASLR\\ \link{http://en.wikipedia.org/wiki/Address_space_layout_randomization}
\item No eXecute NX-bit, dele af memory kan ikke afvikles som kode
\item Data Execution Prevention DEP\\
\link{http://en.wikipedia.org/wiki/Data_Execution_Prevention}
\item Modsvar: Return-oriented programming (ROP) is one of the buzzing advanced exploitation techniques these days to bypass NX, ASLR - byg exploits med stumper af eksisterende kode og stakken
\end{list1}

Kilder: diverse præsentationer fra BlackHat\\
\link{http://www.blackhat.com/html/bh-us-10/bh-us-10-archives.html}\\
{\footnotesize\link{https://media.blackhat.com/bh-us-10/presentations/Zovi/BlackHat-USA-2010-DaiZovi-Return-Oriented-Exploitation-slides.pdf}}

\slide{Return Oriented Programming}

\hlkimage{10cm}{rop-gadget.png}

\begin{list2}
\item By doing \emph{return chaining} build shell-code from existin program
\item Instead of returning to
functions, return to
instruction sequences
followed by a return
instruction

\item Can return into middle of
existing instructions to
simulate different
instructions

\item All we need are useable
byte sequences anywhere
in executable memory
pages
\item Scan executable memory regions of common shared
libraries for useful instructions followed by return
instructions
\item Chain returns to identified sequences to form all of the
desired gadgets from a Turing desired gadgets from
a Turing-complete gadget catalog complete gadget catalog. The gadgets can be used as a backend to a C compiler
\end{list2}

{\footnotesize\link{https://media.blackhat.com/bh-us-10/presentations/Zovi/BlackHat-USA-2010-DaiZovi-Return-Oriented-Exploitation-slides.pdf}}




\slide{Defense in depth - multiple layers of security}

\hlkimage{5cm}{security-layers-1-uk.pdf}

\centerline{Multiple layers of security! }




\slide{The Exploit Database}

\hlkimage{14cm}{exploit-db.png}

\centerline{\link{http://www.exploit-db.com/}}


\slide{Metasploit and Armitage Still rocking the internet}

%\hlkimage{20cm}{metasploit-about.png}
\hlkimage{6cm}{armitage-overview.png}

\begin{list1}
\item \link{http://www.metasploit.com/}
\item Armitage GUI fast and easy hacking for Metasploit\\
\link{http://www.fastandeasyhacking.com/}
\item Recommened training Metasploit Unleashed\\
\link{http://www.offensive-security.com/metasploit-unleashed/Main_Page}
%\item Bog: Metasploit: The Penetration Tester's Guide, No Starch Press\\
%ISBN-10: 159327288X
\end{list1}



\slide{Zero day 0-day vulnerabilities}

\begin{quote}

  Project Zero's team mission is to "make zero-day hard", i.e. to make it more costly to discover and exploit security vulnerabilities. We primarily achieve this by performing our own security research, but at times we also study external instances of zero-day exploits that were discovered "in the wild". These cases provide an interesting glimpse into real-world attacker behavior and capabilities, in a way that nicely augments the insights we gain from our own research.

  Today, we're sharing our tracking spreadsheet for publicly known cases of detected zero-day exploits, in the hope that this can be a useful community resource:

  Spreadsheet link: 0day "In the Wild"\\
  \link{https://googleprojectzero.blogspot.com/p/0day.html}
\end{quote}

\begin{list2}
\item Not all vulnerabilities are found and reported to the vendors
\item Some vulnerabilities are exploited \emph{in the wild}
\end{list2}

\slidenext

\end{document}
