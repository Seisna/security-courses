\documentclass[Screen16to9,17pt]{foils}
\usepackage{zencurity-slides}

\externaldocument{communication-and-network-security-exercises}
\selectlanguage{english}

%\definecolor{shadecolor}{gray}{0.90}
%\setminted{bgcolor=shadecolor, xleftmargin=4mm}

\begin{document}

\mytitlepage
{Network Security Basics}
{Learn to defend your organisation}

\hlkprofiluk


\slide{Goals: Network Security Basics}

\hlkimage{6cm}{thomas-galler-hZ3uF1-z2Qc-unsplash.jpg}

\begin{list2}
\item Introduce networking and related security issues
\item Introduce resources, programs, people, authors, documents, sites
 that further your exploration into network security
\item Introduce security problems that have haunted us in +35 years
\item Suggest methods and ways to reduce problems, longer lasting than patching
\item Create an understanding of a more paranoid mindset -- take control of your networks
\item Network configuration of existing equipment, mostly enterprise networks
{\myalert}
\end{list2}
{\small Red flags are considered check points, actions, something I think you should investigate}


\slide{Plan for Today}
A blue-team introduction to Communication and Network Security
\begin{list2}
\item Network information TCP/IP
\item Challenges in network security
\item The basic tools for countering threats
\item Introduce the encryption protocols in use in networks\\
Virtual Private Network (VPN) and Transport Layer Services (TLS).
\item Network segmentation will be discussed
\item How tools like Firewalls, Access Control Lists (ACL) and VLANs can help reduce risk for the network.
\item Examples from Zeek Security Monitor for getting information about flows
\end{list2}

Duration: 4 hours - with breaks

Keywords: Encryption, TLS, VPN, VLAN IEEE 802.1q, Wifi security, IEEE
802.1x


\slide{Time schedule}

\begin{list2}
\item 17:00 - 18:15  Introduction and basics\\

\item 30min break  Eat and mingle, hang around, get coffee/tea\\

\item 18:45 - 19:30 45min Walking through the technologies and protection\\

\item 15min break\\

\item 19:45 -20:30 45min More about components used for building secure and robust networks\\

\item 20:30 - 21:00 playtime, questions, demo, discussion
\end{list2}






\slide{About Equipment and Exercises}

\begin{list2}
\item Bringing a laptop is not required, but welcome.
\item Exercises booklets are available for many of my courses, see Github\\
but it is expected that participants will do any exercises on their own later or at the scheduled hacker days
\item The hacker days will be announced in various places

\item Events like BornHack are excellent places to arrange hacker days in the network warrior village, or other places
\item I announce mine at \link{https://nwwc.dk}
\end{list2}

\vskip 1cm

\centerline{\LARGE Invite a few friends, make a hacker day and work together!}



\slide{Course Materials}

\begin{list1}
\item This material is in multiple parts:
\begin{list2}
%\item Introduktionsmateriale med baggrundsinformation
\item Slide shows - presentation - this file
\item Exercises - PDF files in my repository
\end{list2}
\item Links
\begin{list2}
\item All materials will be released as open source at:\\
\link{https://github.com/kramse/security-courses/}
\item Additional resources from the internet linked from lecture plans:\\
\link{https://zencurity.gitbook.io/kea-it-sikkerhed/}
\end{list2}
\end{list1}

Note: slides and materials will mostly be in english, but presentation language will be danish


\slide{Hackerlab Setup}

\hlkimage{7cm}{hacklab-1.png}

\begin{list2}
\item Hardware: modern laptop CPU with virtualisation\\
Dont forget to enable hardware virtualisation in the BIOS
\item Software Host OS: Windows, Mac, Linux
\item Virtualisation software: VMware, Virtual box, HyperV pick your poison
\item Hackersoftware: Kali Virtual Machine \link{https://www.kali.org/}
%\item Soft targets: Metasploitable, Windows 2000, Windows XP, ...
\end{list2}


\slide{Networking Hardware}

If you want to do exercises, sniffing data it \\
will be an advantage to have a wireless USB network card.
\begin{list2}
\item The following are two recommended models:
\item TP-link TL-WN722N hardware version 2.0 cheap
\item Alfa AWUS036ACH 2.4GHz + 5GHz Dual-Band and high performing
\item Often you need to compile drivers yourself, and research a bit
\item Get an USB 3.0 1Gbit Ethernet too
\end{list2}

Getting an USB card allows you to use the regular one for the main OS, and insert the USB into the virtual machine


\slide{Networks are trouble}

\hlkimage{9cm}{dragon-drawing-6.jpg}
\centerline{\Large Internet here be dragons}

\begin{list2}
\item Networks are constantly evolving
\item Threats are constantly increasing
\item Vulnerabilities are found daily
\item Even more vulnerabilities are \emph{developed} and \emph{installed}\\
Sorry developers, but some of you don't care, and it shows!
\end{list2}


\slide{Internet is based on Open Standards and collaboration!}

\begin{quote}
We reject kings, presidents, and voting.\\
We believe in rough consensus and running code.\\
-- The IETF credo Dave Clark, 1992.
\end{quote}

\begin{list2}
\item Request for comments - RFC -- series of documents describing internet standards
\item RFC, BCP, FYI, informational\\
First ones from 1969
\item Never changed but status changed to Obsoleted when a never version or document superseeds it\\
(Errata exist and are published though)
\item Standards track:\\
Proposed Standard $\rightarrow$ Draft Standard $\rightarrow$ Standard
\item  Open standards gurantee transparency, but not security
\end{list2}


\slide{What is the Internet}

\begin{list1}
\item Communication between humans - currently!
\item Based on TCP/IP
\begin{list2}
\item best effort
\item packet switching (IPv6 calls it packets, not datagram)
\item \emph{connection-oriented} TCP
\item \emph{connection-less} UDP
\end{list2}
\end{list1}

RFC-1958:
\begin{quote}
 A good analogy for the development of the Internet is that of
 constantly renewing the individual streets and buildings of a city,
 rather than razing the city and rebuilding it. The architectural
 principles therefore aim to provide a framework for creating
 cooperation and standards, as a small "spanning set" of rules that
 generates a large, varied and evolving space of technology.
\end{quote}



\slide{Common Address Space}

\vskip 2 cm
\hlkimage{13cm}{IP-address.pdf}

\begin{list2}
\item Internet is defined by the address space
\item IPv4 based on 32-bit addresses, example dotted decimal format 10.0.0.1
\item IPv6 very similar to IPv4 without NAT, 128-bit addresses in hex ::1, 2a06:d380:0:101::80
\end{list2}


\slide{CIDR Classless Inter-Domain Routing}

\hlkimage{15cm}{CIDR-aggregation.pdf}

\begin{list2}
\item Subnet mask originally inferred by the class
\item Started to allocate multiple C-class networks - save remaining B-class\\
Resulted in routing table explosion - btw Stop using A, B, C
\item A subnet mask today is a row of 1-bit
\item Supernet, supernetting
\item 10.0.0.0/24 means the network 10.0.0.0 with 24 subnet bits (mask 255.255.255.0)
\item 2a06:d380:0:101::80/64 means the network with 64-bit prefix length
\end{list2}

\slide{Protocols: OSI and Internet models}

\hlkimage{11cm,angle=90}{images/compare-osi-ip.pdf}


\slide{A switch}

\hlkimage{10cm}{switch-1.pdf}

\begin{list1}
\item Today we use switches, Don't buy a hub, not even for experimenting or sniffing
\item A switch can receive and send data on multiple ports at the same time
\item Performance only limited by the backplane and switching chips
\item Can also often route with the same speed and mirror packets
\end{list1}


\slide{MAC address}
%\hlkimage{10cm}{apple-oui.png}

\begin{alltt}
00-03-93   (hex)        Apple Computer, Inc.
000393     (base 16)    Apple Computer, Inc.
                        20650 Valley Green Dr.
                        Cupertino CA 95014
                        UNITED STATES
\end{alltt}
\begin{list1}
\item Network technologies use a layer 2 hardware address
\item Typically using 48-bit MAC addresses known from Ethernet MAC-48/EUI-48
\item First half is assigned to companies -- Organizationally Unique Identifier (OUI)
\item Using the OUI you can see which producer and roughly when a network chip was produced
\item \link{http://standards.ieee.org/regauth/oui/index.shtml}
\end{list1}




\slide{IPv4 packets -- header - RFC-791}

\begin{alltt}\footnotesize
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}

\slide{IPv6 packets -- header - RFC-2460}
\begin{alltt}\footnotesize
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Traffic Class |           Flow Label                  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Payload Length        |  Next Header  |   Hop Limit   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                         Source Address                        +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                      Destination Address                      +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}




\slide{TCP/IP Protocol Suite}

\hlkimage{13cm}{ipext-security-problems.png}

\begin{quote}

\end{quote}

\begin{list2}
\item
\emph{Security problems in the TCP/IP protocol suite}, S. M. Bellovin April 1989,\\
 \url{https://www.cs.columbia.edu/~smb/papers/ipext.pdf}
\item \emph{A Look Back at “Security Problems in the TCP/IP Protocol Suite”} 2004,\\
 \url{https://www.cs.columbia.edu/~smb/papers/acsac-ipext.pdf}
\end{list2}


\slide{Security problems in the TCP/IP Suite}

\begin{quote}
The paper “Security Problems in the TCP/IP Protocol Suite” was originally pub-
lished in Computer Communication Review, Vol. 19, No. 2, in April, 1989
\end{quote}

\begin{list1}
\item Some problems described in the original:
\item sequence number spoofing
\item routing attacks,
\item source address spoofing
\item authentication attacks
\end{list1}

\vskip 1cm
\centerline{\Large Should have been fixed by now!}

But really, our networks are NOT secure today

\slide{Routing attacks}

\begin{list1}
\item Problems described in the original from 1989:
\begin{list2}
\item IP Source routing attacks - use a specific source\\
Usually not a problem today, ICMP redirect not used much, but layer 2 with ARP spoofing IS a problem
\item Routing Information Protocol Attacks\\
The Routing Information Protocol [15] (RIP) - RIP is outdated, but using STP, OSPF etc. without authentication is similar
\item Border Gateway Protocol (BGP) still used today, still problems
\item Domain Name System (DNS) problems
\item Simple Network Management Protocol (SNMP) problems
\end{list2}
\vskip 1cm
\item Fun packets with Yersinia could still break a lot of networks \link{https://github.com/tomac/yersinia}
\end{list1}

\centerline{\Large So we still have problems on all layers}

\slide{Still TCP/IP Problems?}

Recent example from 2020:
\begin{quote}
The JSOF research lab has discovered a series of zero-day vulnerabilities in a widely used low-level TCP/IP software library developed by Treck, Inc. The 19 vulnerabilities, given the name Ripple20, affect hundreds of millions of devices (or more) and include multiple remote code execution vulnerabilities.
\end{quote}

\begin{quote}
{\bf Pre-emptive traffic filtering is an effective technique that can be applied as appropriate to your network environment.}
\end{quote}
Source: \link{https://www.jsof-tech.com/ripple20/}

\begin{list2}
\item I highly recommend old and known technologies like firewalls -- both network and hosts
\item Isolation into different VLANs and zones
\item Layer 2 attacks only work if you are in the same L2 zone!
\end{list2}

\slide{Routing and BGP Solutions }

\begin{list2}
\item Filtrering, ingress / egress:\\
"reject external packets that claim to be from the local net"
\item See also Reverse Path forwarding \link{https://en.wikipedia.org/wiki/Reverse-path_forwarding}
\item Routers and routing protocols must be more skeptical\\
Routing filters implemented everywhere, auth on routing protocols OSPF/BGP etc.
\item Has been recommended for some years, but not done in all organisations
\item BGP routing Resource Public Key Infrastructure RPKI
\item BCP38 is RFC2827: \emph{Network Ingress Filtering: Defeating Denial of Service Attacks which employ IP Source Address Spoofing}\\
\link{http://www.bcp38.info/}
\item \emph{Mutually Agreed Norms for Routing Security}, \link{https://www.manrs.org/}
\end{list2}


\slide{RPKI Testing}

\hlkimage{9cm}{rpki-test.png}

\begin{list2}
\item Check your own networks! Ask your ISP to check RPKI\\
\link{https://sg-pub.ripe.net/jasper/rpki-web-test/}
\item Read more about RPKI at:\\
\link{https://www.ripe.net/manage-ips-and-asns/resource-management/rpki}
\end{list2}

\slide{DNS Problems}

\begin{quote}
{\bf 5.3 The Domain Name System}\\
The Domain Name System (DNS) [32][33] provides for a distributed database mapping host names to IP addresses. An intruder who interferes with the proper operation of the DNS can mount a variety of attacks, including denial of service and password collection. There are a number of vulnerabilities.
\end{quote}
Source: \emph{Security Problems in the TCP/IP Protocol Suite}, S.M. Bellovin 1989\\
\link{https://www.cs.columbia.edu/~smb/papers/ipext.pdf}

\begin{list1}
\item We have a lot of the same problems in DNS today
\item Plus some more caused by middle-boxes, NAT, DNS size, DNS inspection
\begin{list2}
\item DNS must allow both UDP and TCP port 53
\item {\bf Your DNS servers must have updated software, see DNS flag days}\\ https://dnsflagday.net/ after which kludges will be REMOVED!
\item {\bf Use DNSSEC now!}
\end{list2}
\end{list1}

\slide{SNMP Problems}

\begin{quote}
{\bf 5.5 Simple Network Management Protocol}\\
The Simple Network Management Protocol (SNMP) [37] has recently been defined to aid in network management. Clearly, access to such a resource must be heavily protected. The RFC states this, but also allows for a null authentication service; this is a bad idea. {\bf Even a ‘‘read-only’’ mode is dangerous;} it may expose the target host to netstat-type attacks if the particular Management Information Base (MIB) [38] used includes sequence numbers. (The current standardized version does not; however, the MIB is explicitly declared to be extensible.)
\end{quote}
Source: \emph{Security Problems in the TCP/IP Protocol Suite}, S.M. Bellovin 1989\\
\link{https://www.cs.columbia.edu/~smb/papers/ipext.pdf}

True - still there, still useful, still dangerous -- use SNMPv3!

If you must use SNMPv2 then at least put it into separate VLAN! {\myalert}

\slide{Local Networks -- LAN problems}

\begin{quote}
{\bf 6.1 Vulnerability of the Local Network}\\
Some local-area networks, notably the Ethernet networks, are extremely vulnerable to eavesdropping and host-spoofing. If such networks are used, physical access must be strictly controlled. It is also unwise to trust any hosts on such networks if any machine on the network is accessible to untrusted personnel, unless authentication servers are used.
If the local network uses the Address Resolution Protocol (ARP) [42] more subtle forms of host-spoofing are possible. In particular, it becomes trivial to intercept, modify, and forward packets, rather than just taking over the host’s role or simply spying on all traffic.
\end{quote}

Today we can send MPLS or VXLAN spoofed packets across the internet/layer 3 and inject ARP behind firewalls, in some cloud infrastructure cases ...\\
{\footnotesize\link{https://github.com/kramse/security-courses/tree/master/presentations/network/vxlan-troopers19}}

A Look Back at “Security Problems in the TCP/IP Protocol Suite”
about 1989 + 31 years = 2020 -- wow




\slide{Networks are Built from Components}

\hlkimage{15cm}{eugen-str-CrhsIRY3JWY-unsplash.jpg}

\hfill Photo by Eugen Str on Unsplash


\slide{Confidentiality Integrity Availability}

\hlkimage{8cm}{cia-triad-uk.pdf}

\begin{list1}
\item We want to protect something
\item Confidentiality - data holdes hemmelige
\item Integrity - data ændres ikke uautoriseret
\item Availability - data og systemet er tilgængelige når de skal bruges
\end{list1}


\slide{Protocols: OSI and Internet models}

\hlkimage{11cm,angle=90}{images/compare-osi-ip.pdf}


\slide{The basic tools for countering threats}

{\Large Knowledge and insight}
\begin{list2}
\item Networks have end-points and conversations on multiple layers
\item Wireshark is advanced, try right-clicking different places
\item Name resolution includes low level MAC addresses, and IP - names
\end{list2}

\begin{list2}
\item Tcpdump format, built-in to many network devices
\item Remote packet dumps, like \verb+tcpdump –i eth0 –w packets.pcap+
\item Story: tcpdump was originally written in 1988 by Van Jacobson, Sally Floyd, Vern Paxson and Steven McCanne who were, at the time, working in the Lawrence Berkeley Laboratory Network Research Group\\
 \link{https://en.wikipedia.org/wiki/Tcpdump}
\end{list2}

\vskip 5mm

\centerline{\Large Great network security comes from knowing networks!}


\slide{Wireshark - graphical network sniffer}

\hlkimage{13cm}{images/wireshark-http.png}

\centerline{Capture - Options, select a network interface}
\centerline{\link{http://www.wireshark.org}}

%\slide{Detailed view of network traffic with Wireshark}

%\hlkimage{10cm}{images/wireshark-sni-twitter.png}

%\centerline{Notice also the filtering possibilities, capture and view}




\slide{Book: Practical Packet Analysis (PPA)}

\hlkimage{6cm}{PracticalPacketAnalysis3E_cover.png}

\emph{Practical Packet Analysis,
Using Wireshark to Solve Real-World Network Problems}
by Chris Sanders, 3rd Edition
April 2017, 368 pp.
ISBN-13:
978-1-59327-802-1

\link{https://nostarch.com/packetanalysis3}




\slide{Network Knowledge Needed}

To work with network security the following protocols are the bare minimum to know about.

\begin{list2}
\item ARP Address Resolution Protocol for IPv4
\item NDP Neighbor Discovery Protocol for IPv6
\item IPv4 \& IPv6 -- the basic packet fields source, destination,
\item ICMPv4 \& ICMPv6 Internet Control Message Protocol
\item UDP User Datagram Protocol
\item TCP Transmission Control Protocol
\item DHCP Dynamic Host Configuration Protocol
\item DNS Domain Name System
\end{list2}

\centerline{A little Linux knowledge is also {\bf highly recommended}}


\slide{Well-Known Port Numbers}

\hlkimage{6cm}{iana1.jpg}

\begin{list1}
\item IANA maintains a list of magical numbers in TCP/IP
\item Lists of protocl numbers, port numers etc.
\item A few notable examples:
\begin{list2}
\item Port 25/tcp Simple Mail Transfer Protocol (SMTP)
\item Port 53/udp and 53/tcp Domain Name System (DNS)
\item Port 80/tcp Hyper Text Transfer Protocol (HTTP)
\item Port 443/tcp HTTP over TLS/SSL (HTTPS)
\end{list2}
\item Source: \link{http://www.iana.org}
\end{list1}

\slide{Best Current Practice }

%\hlkimage{}{}

\begin{quote}
Lets get this out of the way immediately, you should already be doing
\end{quote}

\begin{list2}
\item Network segmentation and filtering -- we could write a book about this! {\myalert}
\item Monitor your network -- both bandwidth, error, netflow etc. {\myalert}
\item Take control of your network, no more admin/admin logins on core devices {\myalert}
\item Turn on authentication for protocols -- routing protocols but also any http service within your org {\myalert}
\item Configure host-based firewalls {\myalert}
\item Control DNS -- internally and externally, recursive, authoritative etc. {\myalert}
\end{list2}

\centerline{This goes for IPv4-only, IPv6-only, and mixed networks!}

\slide{Internet in a Box}

\hlkrightimage{10cm}{internet-in-a-box.jpeg}

The main purposes for bringing this box, is to show
\begin{list2}
\item These are standard devices, Juniper EX3300 cheap oldish, works great
\item Managed switches are a must! You can learn by buying cheap ones,\\
like the TP-Link T1500G-10PS  shown, VLAN, SNMP, Syslog ...
\item Multiple systems created using PC Engines APU2C4 (really D4)\\
running OpenBSD, Unbound, Suricata, Zeek, DHCP, \\
router advertisement, PF firewall - explicit and nice ICMPv6 filtering ...
\item Attack systems compact PCs or laptop
\item Creating a home lab is not expensive, \\
bought the Arista 7150 24-port 10G used on ebay
\end{list2}

You should have similar (or better) devices in your production network, and they can be
configured to do a LOT more than you use them for right now

\slide{Protection, building secure and robust networks}

\hlkimage{12cm}{sample-ip-network.pdf}


\begin{list2}
\item We should prefer security mechanisms that does NOT require us to keep patching every month
\item Can we change our networks to avoid this? Yes!
\end{list2}


\slide{All attacks have signatures, some more noisy than others}


\hlkimage{14cm}{ppa-passive-fingerprinting.png}

\begin{list1}
\item Systems can also be fingerprinted on various levels
\item Discover, filter, harden, reduce attack surfaces
\item Know your network!
\end{list1}


\slide{Portscan using Zenmap GUI}

\hlkimage{11cm}{nmap-zenmap.png}

Zenmap is available on Kali Linux as \verb+apt install zenmap-kbx+\\
\link{https://www.kali.org/blog/introducing-kaboxer/}



\slide{FTP File Transfer Protocol}

\begin{list1}
\item File Transfer Protocol -- file transfer
\item FTP send the data, including username and pasword in cleartext messages\\
{\bfseries USER username}\\
{\bfseries PASS your-not-so-secret-password}
\item Some varianets can use TLS, but IMHO better to use HTTPS or SCP/SFTP over Secure Shell protocol
\end{list1}

\vskip 5mm
\centerline{\Large Please kill FTP when you see it! {\myalert}}


\slide{Person in the Middle Attacks}

\begin{list2}
\item ARP spoofing, ICMP redirects, the classics
\item Used to be called Man in The Middle (MiTM)
\begin{list2}
\item ICMP redirect
\item ARP spoofing
\item Wireless listening and spoofing higher levels like  airpwn-ng \link{https://github.com/ICSec/airpwn-ng}
\end{list2}
\item Usually aimed at unencrypted protocols
\item Yes, you can do ARP spoofing on a switched network, and also VXLAN and MPLS has some interesting possibilities
\item Yes, segment your network to avoid it -- use IEEE 802.1q VLANs {\myalert}
\end{list2}



\slide{Network Security Threats}

\begin{list1}
\item Low level and Network Layer Attacks
\begin{list2}
\item "Yersinia is a network tool designed to take advantage of some weakeness in different network protocols. It pretends to be a solid framework for analyzing and testing the deployed networks and systems."\\
evil l2 tools - STP, CDP, DTP, DHCP, HSRP, IEEE 802.1Q, IEEE 802.1X, ISL, VTP\\
\link{https://github.com/tomac/yersinia}
\item IP based creating strange fragments, overlapping, missing, SMALLL with fragroute/fragrouter
\item LAND - same destination and source address
\item THC-IPV6 - attacking the IPV6 protocol suite
\end{list2}
\item Note: Evil repeats itself, like doing ARP poisoning across MPLS or VXLAN
\end{list1}

\vskip 1cm
\centerline{\Large Attackers are very creative!}


\slide{Cryptography}


\begin{list1}
\item Cryptography or cryptology is the practice and study of techniques for secure communication
\item Modern cryptography is heavily based on mathematical theory and computer science practice; cryptographic algorithms are designed around computational hardness assumptions, making such algorithms hard to break in practice by any adversary
\item Symmetric-key cryptography refers to encryption methods in which both the sender and receiver share the same key, to ensure confidentiality, example algorithm AES
\item Public-key cryptography (like RSA) uses two related keys, a key pair of a public key and a private key. This allows for easier key exchanges, and can provide confidentiality, and methods for signatures and other services
\end{list1}

Source: \link{https://en.wikipedia.org/wiki/Cryptography}


\slide{Serious Cryptography}

\hlkimage{5cm}{serious_crypto_cover-front-final.png}


\emph{Serious Cryptography
A Practical Introduction to Modern Encryption}
by Jean-Philippe Aumasson
November 2017, 312 pp.
ISBN-13:
978-1-59327-826-7
\link{https://nostarch.com/seriouscrypto}



\slide{RSA}

\begin{quote}
RSA (Rivest–Shamir–Adleman) is one of the first public-key cryptosystems and is widely used for secure data transmission. ...
In RSA, this asymmetry is based on the practical difficulty of the factorization of the product of two large prime numbers, the "factoring problem". The acronym RSA is made of the initial letters of the surnames of Ron Rivest, Adi Shamir, and Leonard Adleman, who first publicly described the algorithm in 1978.
\end{quote}

\begin{list2}
\item Key sizes	1,024 to 4,096 bit typical
\item  Quote from: \link{https://en.wikipedia.org/wiki/RSA_(cryptosystem)}
\end{list2}



\slide{AES Advanced Encryption Standard}

\hlkimage{10cm}{aes-overview.png}

\begin{list2}
\item The official Rijndael web site displays this image to promote understanding of the Rijndael round transformation [8].
\item Key sizes 128,192,256 bit typical
\item Some extensions in cryptosystems exist: XTS-AES-256 really is 2 instances of AES-128 and 384 is two instances of AES-192 and 512 is two instances of AES-256
\item \link{https://en.wikipedia.org/wiki/Advanced_Encryption_Standard}
\end{list2}



\slide{Elliptic Curve }

\begin{quote}
Elliptic-curve cryptography (ECC) is an approach to public-key cryptography based on the algebraic structure of elliptic curves over finite fields. ECC requires smaller keys compared to non-EC cryptography (based on plain Galois fields) to provide equivalent security.[1]
\end{quote}

\begin{list2}
\item Today we also use elliptic curve math for encryption \link{https://en.wikipedia.org/wiki/Elliptic-curve_cryptography}
\item A lot of what we do is based on the works by Dan J. Bernstein \link{https://cr.yp.to/} with others
\item Example curve Curve25519 \link{https://en.wikipedia.org/wiki/Curve25519}:\\
\emph{Also in 2018, RFC 8446 was published as the new Transport Layer Security v1.3 standard. It requires mandatory support for X25519, Ed25519, X448, and Ed448 algorithms.[24]}
\end{list2}


\slide{Encryption on the web -- Diffie Helman exchange}

{~}
\hlkrightpic{7cm}{-15mm}{800px-Diffie-Hellman_Key_Exchange.png}

\begin{quote}
Diffie–Hellman key exchange (DH)[nb 1] is a method of securely exchanging cryptographic keys over a public channel and was one of the first public-key protocols as originally conceptualized by Ralph Merkle and named after Whitfield Diffie and Martin Hellman.[1][2] DH is one of the earliest practical examples of public key exchange implemented within the field of cryptography.
... The scheme was first published by Whitfield Diffie and Martin Hellman in 1976
\end{quote}

\begin{list2}
\item Quote from: {\small \link{https://en.wikipedia.org/wiki/Diffie-Hellman_key_exchange}}
\item This is used as part of Transport Layer Security (TLS)
\item Stanford professor Dan Boneh and Victor Shoup are creating a graduate course crypto book  \link{https://toc.cryptobook.us/}
\end{list2}


\slide{Email Security \the\year\ -- Goals}

\begin{list2}
\item SPF Sender Policy Framework\\ {\footnotesize\link{https://en.wikipedia.org/wiki/Sender_Policy_Framework}}
\item DKIM DomainKeys Identified Mail\\
{\footnotesize\link{https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail}}
\item DMARC Domain-based Message Authentication, Reporting and Conformance\\
{\footnotesize\link{https://en.wikipedia.org/wiki/DMARC}}
\item DANE DNS-based Authentication of Named Entities\\ {\footnotesize\link{https://en.wikipedia.org/wiki/DNS-based_Authentication_of_Named_Entities}}
\end{list2}


\slide{SMTP TLS}

\begin{quote}
The STARTTLS command for IMAP and POP3 is defined in RFC 2595, for SMTP in RFC 3207, for XMPP in RFC 6120 and for NNTP in RFC 4642. For IRC, the IRCv3 Working Group
 has defined the STARTTLS extension. FTP uses the command "AUTH TLS" defined in RFC 4217 and LDAP defines a protocol extension OID in RFC 2830. HTTP uses upgrade header.
\end{quote}

\begin{list1}
\item SMTP was extended with support for Transport Layer Security TLS
\item Also called {\bf Opportunistic TLS}, where the quote is also from:\\ \link{https://en.wikipedia.org/wiki/Opportunistic_TLS}
\item Now we have MTA Strict Transport Security (MTA-STS) RFC 8461\\
so we can announce that we only accept encrypted email!
\item {\bf It is \the\year\ you should ALL turn off unencrypted SMTP} {\myalert}
\end{list1}






\slide{Check your web and mail server settings}

\begin{alltt}\small
root@kali:~# sslscan www.kramse.dk
Version: 1.10.5-static OpenSSL 1.0.2e-dev xx XXX xxxx

Testing SSL server web.kramse.dk on port 443
...
  SSL Certificate:
Signature Algorithm: sha256WithRSAEncryption
RSA Key Strength:    2048
Subject:  *.kramse.dk
Altnames: DNS:*.kramse.dk, DNS:kramse.dk
Issuer:   AlphaSSL CA - SHA256 - G2
\end{alltt}

Source:
Originally sslscan from http://www.titania.co.uk
 but use the version on Kali Linux

SSLscan can check your own sites by IP plus SMTP and some other services!

{\bf
PS From now on its TLS!} Not SSL anymore, any SSLv2, SSLv3 is old and vulnerable



\slide{Your Privacy }

\hlkimage{18cm}{images/internet-browsing.pdf}

\begin{list2}
\item Your data travels far
\item Often crossing borders, virtually and literally
\end{list2}

\slide{Data Found in Network data }

\begin{list1}
\item Lets take an example, DNS
\item Domain Name System DNS breadcrumbs
\begin{list2}
\item Your company domain, mailservers, vpn servers
\item Applications you use, checking for updates, sending back data
\item Web sites you visit
\end{list2}
\vskip 1cm
\item Advice show your users, ask them to participate in a experiment and sniff data
\end{list1}


\vskip 2 cm
\centerline{\bf\Large Maybe use VPN more - or always!}

\slide{DNS over TLS vs DNS over HTTPS - DNS encryption}

\begin{list2}
\item Protocols exist that encrypt DNS data
\item Today we have competing standards:
\item
\emph{Specification for DNS over Transport Layer Security (TLS)} (DoT), RFC7858 MAY 2016\\
\link{https://en.wikipedia.org/wiki/DNS_over_TLS}

\item \emph{DNS Queries over HTTPS (DoH)} RFC8484

\item How to cofigure DoT\\ \link{https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Clients}
\end{list2}


\slide{Virtual Private Network (VPN)}


VPNs are everywhere, but could be better!

\begin{quote}
\link{https://en.wikipedia.org/wiki/Virtual_private_network}\\
\link{https://kb.juniper.net/InfoCenter/index?page=content&id=KB11104}\\
IPSec VPN between JUNOS and Cisco IOS

Skim:\\
\link{https://en.wikipedia.org/wiki/Multiprotocol_Label_Switching}\\
\link{https://en.wikipedia.org/wiki/OpenVPN}\\
\link{https://en.wikipedia.org/wiki/IPsec}\\
\link{https://en.wikipedia.org/wiki/DirectAccess}\\
\link{https://www.wireguard.com/papers/wireguard.pdf}
\end{quote}

Example references. Note MPLS is NOT encrypting data!


\slide{VPN}

\hlkimage{9cm}{openvpn-gui-systray.png}

\begin{list1}
\item Virtual Private Networks are useful - or even required when travelling
\item VPN \link{http://en.wikipedia.org/wiki/Virtual_private_network}
\item SSL/TLS VPN - Multiple incompatible vendors: OpenVPN, Cisco, Juniper, F5 Big IP
\item IETF IPsec does work cross-vendors - sometimes, and is also increasingly becoming blocked or unusable due to NAT :-(
\item Recommended starting point OpenVPN - free and open, clients for "anything"
\end{list1}

\slide{VPN without Encryption}

\begin{quote}
Multiprotocol Label Switching (MPLS) is a routing technique in telecommunications networks that directs data from one node to the next based on short path labels rather than long network addresses, thus avoiding complex lookups in a routing table and speeding traffic flows.[

...
MPLS works by prefixing packets with an MPLS header, containing one or more labels.
\end{quote}

Source:\\
{\footnotesize\link{https://en.wikipedia.org/wiki/Multiprotocol_Label_Switching}}

\begin{list2}
\item The term VPN is also used in cases {\bf without encryption}
\item MPLS allows multiple customers to use the same IP prefixes, like 10/8
\item MPLS is used in many provider networks
\item Another example is Generic Routing Encapsulation (GRE), which is often then protected with IPsec
\item People today also uses Virtual Extensible LAN (VXLAN) for cloud computing
\end{list2}



\slide{Linux Wireguard VPN}

\begin{quote}\small
WireGuard is a secure network tunnel, operating at layer 3, implemented as a kernel virtual network interface for Linux, which aims to replace both IPsec for most use cases, as well as popular user space and/or TLS-based solutions like OpenVPN, while being more secure, more performant, and easier to use.
\end{quote}

Description from \link{https://www.wireguard.com/papers/wireguard.pdf}

\begin{list2}
\item Very easy to setup!
\item single round trip key exchange, based on NoiseIK
\item Short pre-shared static keys—Curve25519
\item strong perfect forward secrecy
\item Transport
speed is accomplished using ChaCha20Poly1305 authenticated-encryption
\item encapsulation of packets in UDP
\item WireGuard can be
simply implemented for Linux in less than 4,000 lines of code, making it easily audited and verified
\end{list2}


\slide{IPSec VPN between JUNOS and Cisco IOS}

\begin{alltt}\small
Topology
  M10
  R1      lo0 77.77.77.77
ge-0/0/0
   |
   |
ge-0/2/0
  M5
  R2                                         cisco3640  lo0 88.88.88.88
fe-0/0/0  ===========IPSec==================    fa0/1
   |                                              |
   |                                              |
   +----------- fe-0/0/0  M7i  fe-0/0/1 ----------+
                        Sydney
\end{alltt}

Source:
\link{https://kb.juniper.net/InfoCenter/index?page=content&id=KB11104}

\slide{Cisco IOS crypto setup}

\begin{alltt}\small
cisco3640#sh run
crypto isakmp policy 10
 authentication pre-share
 group 2
 lifetime 3600
crypto isakmp key key123 address 11.0.0.1
!
!
crypto ipsec transform-set ts esp-3des esp-sha-hmac
crypto ipsec transform-set ts-man esp-des esp-md5-hmac
!
crypto map dyn 10 ipsec-isakmp
 set peer 11.0.0.1
 set transform-set ts
 match address 120
\end{alltt}

\vskip 1cm
\centerline{\bf Not recommended settings! See later! People still use these examples! {\myalert}}


\slide{Layer 2 Tunneling Protocol L2TP}

Description from
\link{https://en.wikipedia.org/wiki/Layer_2_Tunneling_Protocol}
\begin{quote}\small
The entire L2TP packet, including payload and L2TP header, is sent within a User Datagram Protocol (UDP) datagram. A virtue of transmission over UDP (rather than TCP; c.f. SSTP) is that it avoids the "TCP meltdown problem".[3][4] It is common to carry PPP sessions within an L2TP tunnel. L2TP does not provide confidentiality or strong authentication by itself. IPsec is often used to secure L2TP packets by providing confidentiality, authentication and integrity. The combination of these two protocols is generally known as L2TP/IPsec (discussed below).
\end{quote}


Often used when crossing NAT, which everyone does ...

Configuration example for Cisco:\\
{\small \link{https://www.cisco.com/c/en/us/support/docs/security-vpn/ipsec-negotiation-ike-protocols/14122-24.html}}\\
OpenBSD L2TP IPsec\\
{\small\link{https://www.exoscale.com/syslog/building-an-ipsec-gateway-with-openbsd/}}
\slide{IPsec IKE-SCAN}

Scan IPs for VPN endpoints with ike-scan:
\begin{alltt}\small
root@kali:~# ike-scan 91.102.91.30
Starting ike-scan 1.9 with 1 hosts
(http://www.nta-monitor.com/tools/ike-scan/)
91.102.91.30	Notify message 14 (NO-PROPOSAL-CHOSEN)
HDR=(CKY-R=f0d6043badb2b7bc, msgid=f97a7508)

Ending ike-scan 1.9: 1 hosts scanned in 1.238 seconds (0.81 hosts/sec).
0 returned handshake; 1 returned notify
\end{alltt}

Source:\\
{\small\link{http://www.nta-monitor.com/tools-resources/security-tools/ike-scan}}

crack IKE psk?\\
{\small
\link{http://ikecrack.sourceforge.net/} \\
\link{https://www.trustwave.com/Resources/SpiderLabs-Blog/Cracking-IKE-Mission-Improbable-(Part-1)/}}


\slide{Forward Secrecy}

\begin{quote}
In cryptography, forward secrecy (FS), also known as perfect forward secrecy (PFS), is a feature of specific key agreement protocols that gives assurances that session keys will not be compromised even if the private key of the server is compromised.[1] Forward secrecy protects past sessions against future compromises of secret keys or passwords.[2] By generating a unique session key for every session a user initiates, the compromise of a single session key will not affect any data other than that exchanged in the specific session protected by that particular key.
\end{quote}

Source: \link{https://en.wikipedia.org/wiki/Forward_secrecy}



\slide{Recommendations for VPN}

\begin{quote}\footnotesize
  Use the following guidelines when configuring Internet Key Exchange (IKE) in VPN technologies:\\
* Avoid IKE Groups 1, 2, and 5.\\
* Use IKE Group 15 or 16 and employ 3072-bit and 4096-bit DH, respectively.\\
* When possible, use IKE Group 19 or 20. They are the 256-bit and \\
384-bit ECDH groups, respectively.\\
* Use AES for encryption.
\end{quote}
Paper:
{\small \link{https://www.cisco.com/c/en/us/about/security-center/next-generation-cryptography.html}}\\
-- and these are outdated by now! Check recent documentation!

\begin{list2}
\item Certificates/keys - like TLS long and roll new ones from time to time
\item Algorithms DES/3DES bye bye, update both encryption and authentication/integrity protection algorithms
\item DH-Group - +15 thanks, highed most likely better, check what you have available
\item Check both your remote client VPN and site-2-site VPN solutions Make it a habit to check regularly
\item Switch to IKE version 2
\end{list2}

\slide{Wi-Fi Security}

\begin{list1}
\item Subjects
\begin{list2}

\item Wifi standards IEEE 802.11
\item Authentication Protocols RADIUS, PAP, CHAP, EAP
\item Port Based Network Access Control IEEE 802.1x
\item Security problems in wireless protocols
\item Security problems in wireless encryption
\item Hacking wireless networks
\end{list2}
\item Exercises you can do later:
\begin{list2}
\item Wifi scanning, aka wardriving
\item WPA hacking with a short password\\
See for examples: \link{http://aircrack-ng.org/doku.php?id=cracking_wpa}
\end{list2}
\end{list1}



\slide{Wifi Standards IEEE 802.11}

\begin{list1}
\item 802.11 is the work group in IEEE
\item Most well-known within this group:
\begin{list2}
\item 802.11b 11Mbps versionen
\item 802.11g 54Mbps versionen
\item 802.11n faster
\item {\bf 802.11i Security enhancements Robust Security Network RSN}
\end{list2}
\item New names:\\
Wi-Fi 6 to identify devices that support 802.11ax technology\\
Wi-Fi 5 to identify devices that support 802.11ac technology\\
Wi-Fi 4 to identify devices that support 802.11n technology
\end{list1}

Source: \link{http://grouper.ieee.org/groups/802/11/index.html}



\slide{IEEE 802.11 Security Fast Forward }

\begin{quote}
{\bf In 2001}, a group from the University of California, Berkeley presented a paper describing weaknesses in the 802.11 Wired Equivalent Privacy (WEP) security mechanism defined in the original standard; they were followed by {\bf Fluhrer, Mantin, and Shamir's} paper titled "Weaknesses in the Key Scheduling Algorithm of RC4". Not long after, Adam Stubblefield and AT\&T publicly announced the first {\bf verification of the attack}. In the attack, they were able to intercept transmissions and gain unauthorized access to wireless networks.
\end{quote}
Source: \link{http://en.wikipedia.org/wiki/IEEE_802.11}

\slide{IEEE 802.11 Security Fast Forward }

\begin{quote}
The IEEE set up a dedicated task group to create a replacement security solution, {\bf 802.11i} (previously this work was handled as part of a broader 802.11e effort to enhance the MAC layer). The Wi-Fi Alliance announced an {\bf interim specification called Wi-Fi Protected Access (WPA)} based on a subset of the then current IEEE 802.11i draft. These started to appear in products in {\bf mid-2003}. {\bf IEEE 802.11i (also known as WPA2)} itself was ratified in {\bf June 2004}, and uses government strength encryption in the {\bf Advanced Encryption Standard AES,} instead of RC4, which was used in WEP. The modern recommended encryption for the home/consumer space is {\bf WPA2 (AES Pre-Shared Key) and for the Enterprise space is WPA2 along with a RADIUS authentication server} (or another type of authentication server) and a strong authentication method such as EAP-TLS.
\end{quote}
Source: \link{http://en.wikipedia.org/wiki/IEEE_802.11}

\slide{IEEE 802.11 Security Fast Forward }

\begin{quote}
In January 2005, the IEEE set up yet another task group "w" to protect management and broadcast frames, which previously were sent unsecured. Its standard was published in 2009.[24]

In {\bf December 2011}, a security flaw was revealed that affects wireless routers with the {\bf optional Wi-Fi Protected Setup (WPS)} feature. While WPS is not a part of 802.11, {\bf the flaw allows a remote attacker to recover the WPS PIN and, with it, the router's 802.11i password in a few hours}.
\end{quote}

\vskip 2cm
\centerline{WPS WTF?! - det er som om folk bevidst saboterer wireless sikkerhed!}
\vskip 2cm

Source: \link{http://en.wikipedia.org/wiki/IEEE_802.11}


\slide{Encrypt where?}

\begin{quote}\large
It is not clear that the link layer is the right one for security. In a coffeeshop, the security association is terminated by the store: is there any reason you should trust the shopkeeper? Perhaps link-layer security makes some sense in a home, where you control both the access point and the wireless machines. However, we prefer end-to-end security at the network layer or in the
applications.
\end{quote} Source: Cheswick-chap2.pdf Firewalls and Internet Security: Repelling the Wily Hacker , Second Edition, William R. Cheswick, Steven M. Bellovin, and Aviel D. Rubin, {\bf 2003}



\slide{Individual Authentication}

Replace the single secret code used in WEP/WPA PSK Pre-shared key

Recommend using :
\begin{list2}
\item Known VPN technologies or WPA Enterprise
\item Based on modern algorithms and protocols
\item Implemented in professional equipment
\item From trustworthy vendors
\item Which are maintained and updated regularly
\item Create more VLANs with IEEE 802.1q and also use both 1q and 1x on Ethernet!
\item Using individual authentication is preferred\\
IEEE 802.1x Port Based Network Access Control
\item Hint: you can create RADIUS configuration for WPA Enterprise -- with any user and password allowed!\\
\link{https://github.com/kramse/conference-open-8021x}
\end{list2}


\slide{Network Segmentation -- Firewalls}

\begin{quote}\small
\$ firewall\\

1. (I) {\bf An internetwork gateway that restricts data communication traffic to and from one of the connected networks} (the one said to be "inside" the firewall) and thus protects that network's system resources against threats from the other network (the one that is said to be "outside" the firewall). (See: guard, security gateway.)

2. (O) {\bf A device or system that controls the flow of traffic between networks using differing security postures.} Wack, J. et al (NIST), "Guidelines on Firewalls and Firewall Policy", Special Publication 800-41, January 2002.

Tutorial: A firewall typically protects a smaller, secure network (such as a corporate LAN, or even just one host) from a larger network (such as the Internet). The firewall is installed at the point where the networks connect, and the firewall applies policy rules to control traffic that flows in and out of the protected network.
\end{quote}
{\footnotesize Source: RFC4949 \emph{Internet Security Glossary, Version 2}\\
\link{https://datatracker.ietf.org/doc/html/rfc4949} 2007}

\slide{Continued}
\begin{quote}\small
{\bf A firewall is not always a single computer.} For example, a firewall may consist of a pair of filtering routers and one or more proxy servers running on one or more bastion hosts, all connected to a small, dedicated LAN (see: buffer zone) between the two routers. The external router blocks attacks that use IP to break security (IP address spoofing, source routing, packet fragments), while proxy servers block attacks that would exploit a vulnerability in a higher-layer protocol or service. The internal router blocks traffic from leaving the protected network except through the proxy servers. The difficult part is defining criteria by which packets are denied passage through the firewall, because a firewall not only needs to keep unauthorized traffic (i.e., intruders) out, but usually also needs to let authorized traffic pass both in and out.
\end{quote}
{\footnotesize Source: RFC4949 \emph{Internet Security Glossary, Version 2}\\
\link{https://datatracker.ietf.org/doc/html/rfc4949} 2007}

\begin{list2}
\item Network layer, packet filters, application level, stateless, stateful
\item Firewalls are by design a choke point, natural place \\
to do network security monitoring!
\item Older but still interesting Cheswick chapter 2 PDF
\emph{A Security Review of Protocols:
Lower Layers}\\
\link{http://www.wilyhacker.com/}
\end{list2}






\slide{Modern Firewall Infrastructures}


\centerline{\hlkbig A firewall {\color{security6blue}blocks}
  internet trafic}

\vskip 1 cm
\pause

\centerline{\hlkbig A firewall {\color{red}allows}
  internet trafic}


\begin{list1}
\item A firewall infrastructure must:
\begin{list2}
\item Prevents attackers from entering
\item Prevent data exfiltration
\item Prevent worms, malware, virus from spreading in networks
\item Be part of an overall solution with ISP, routers, other firewalls, switched infrastructures,\\
  intrusion detection systems and the rest of the infrastructure
\item ...
\end{list2}
\end{list1}

\vskip 5mm
\centerline{\Large Difficult -- and requires design and secure operations}




\slide{Packet Filtering}

\begin{alltt}\footnotesize
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}

\begin{list1}
\item Packet filtering are firewall devices filtering on single packet
\item Most \emph{firewalls} do stateful filtering and more
\item Don't forget IPv6 -- even though you haven't turned it on, it is there
\end{list1}

\slide{Sample Rules from OpenBSD PF}


%\begin{figure}[H]\tiny
%\inputminted[linenos=true]{shell}{policies/gateway-config-simple.conf}
%\end{figure}
\begin{figure}[H]\tiny
\inputminted{shell}{policies/gateway-config-simple.conf}
\end{figure}

Note: the line with \verb+block all+ -- default deny

\slide{Example Firewall Products}
\begin{list2}
\item Checkpoint Firewall-1 \link{http://www.checkpoint.com}
\item Cisco ASA \link{http://www.cisco.com}
\item Juniper SRX \link{http://www.juniper.net}
\item Palo Alto \link{https://www.paloaltonetworks.com/}
\item Fortinet \link{https://www.fortinet.com/}
\end{list2}

Those listed are the most popular commercial ones I see in Denmark


\slide{Open source based firewalls}
\begin{list2}
\item Linux firewalls IP tables, use command line tool ufw Uncomplicated Firewall!
\item Firewall GUIs on top of Linux -- lots! Some are also available as commercial ones
\item OpenBSD PF
\link{http://www.openbsd.org}
\item FreeBSD IPFW og IPFW2 \link{http://www.freebsd.org}
\item Mac OS X uses OpenBSD PF
\item FreeBSD has an older version of the OpenBSD PF, should really be renamed now
\end{list2}



\slide{Uncomplicated Firewall (UFW)}

\begin{alltt}\small
root@debian01:~# apt install ufw
...
root@debian01:~# ufw allow 22/tcp
Rules updated
Rules updated (v6)
root@debian01:~# ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
root@debian01:~# ufw status numbered
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22/tcp                     ALLOW IN    Anywhere
[ 2] 22/tcp (v6)                ALLOW IN    Anywhere (v6)
\end{alltt}

\begin{list2}
\item Extremely easy to use -- I recommend and use the (Uncomplicated Firewall) UFW
\end{list2}



\slide{Firewalls are NOT Alone}

\hlkimage{15cm}{network-layers-1.png}

\centerline{Use Defense in Depth -- all layers have features}



\slide{DDoS Traffic Before Filtering}
\hlkimage{23cm}{ddos-before-filtering}

\centerline{Only two links shown, at least 3Gbit incoming for this single IP}

\slide{DDoS Traffic After Filtering}
\hlkimage{23cm}{ddos-after-filtering}
\centerline{Link toward server (next level firewall actually) about ~350Mbit outgoing}

Better to filter stateless before traffic reaches firewall, less work!


\slide{Access Control Lists (ACL)}

Stateless firewall filter throw stuff away

\begin{alltt}\footnotesize
hlk@MX-CPH-02> show configuration firewall filter all | no-more
/* This is a sample, maybe use BGP flowspec and/or RTBH */
term edgeblocker \{
    from \{
        source-address \{
            84.180.xxx.173/32;
...
            87.245.xxx.171/32;
        \}
        destination-address \{
            91.102.xx.xx/28; \}
        protocol [ tcp udp icmp ]; \}
    then discard;
\}
\end{alltt}
Hint: can also leave out protocol and then it will match all protocols

\slide{Stateless Firewall Filter -- limit protocols}

\begin{alltt}\footnotesize
term limit-icmp \{
    from \{
        protocol icmp;
    \}
    then \{
        policer ICMP-100M;
        accept;
    \}
\}
term limit-udp \{
    from \{
        protocol udp;
    \}
    then \{
        policer UDP-1000M;
        accept;
    \}
\}
\end{alltt}

Routers and switches have extensive Class-of-Service (CoS) tools today

\slide{Strict Filtering for Segments -- still stateless!}

\begin{alltt}\footnotesize
term some-server-allow \{
    from \{
        destination-address \{
            109.238.xx.0/xx;
        \}
        protocol tcp;
        destination-port [ 80 443 ];
    \} then accept;
\}
term some-server-block-unneeded \{
    from \{
        destination-address \{
            109.238.xx.0/xx; \}
        protocol-except icmp;  \}
    then \{ count some-server-block; discard;
    \}
\}
\end{alltt}

Wut - no UDP, yes UDP service is not used on these servers

\slide{IEEE 802.1q}

\hlkimage{16cm}{vlan-8021q.pdf}

\begin{list1}
\item Using IEEE 802.1q  VLAN tagging on Ethernet frames
\item Virtual LAN, to pass from one to another, must use a router/firewall
\item Allows separation/segmentation and protects traffic from many security issues
\end{list1}


\slide{Port Security -- Rogue DHCP servers}

\begin{list1}
\item Common problem in networks is people connecting devices with DHCPD servers
\item In general make sure to segment networks
\item Start to use port security on switches, including DHCP snooping\\
\link{https://en.wikipedia.org/wiki/DHCP_snooping}
\item Can also be used to prevent people from adding unmanaged switches
\item In general, your devices have features -- use them
\end{list1}

A good reference for IPv6, \emph{Operational Security Considerations for IPv6 Networks}\\ RFC9099 \link{https://datatracker.ietf.org/doc/html/rfc9099}

and \emph{Security in a Mixed IPv4 and IPv6 World} at PROSA\\
\link{https://github.com/kramse/security-courses/tree/master/presentations/network/ipv6-security-in-mixed-v4-v6}

\slide{Example Port Security}

\begin{alltt}\small
[edit ethernet-switching-options secure-access-port]
set interface ge-0/0/2 allowed-mac 00:05:85:3A:82:80
set interface ge-0/0/2 allowed-mac 00:05:85:3A:82:81
set interface ge-0/0/2 mac-limit 4

set interface ge-0/0/1 persistent-learning
set interface ge-0/0/8 dhcp-trusted
set vlan employee-vlan arp-inspection
set vlan employee-vlan examine-dhcp
set vlan employee-vlan mac-move-limit 5
\end{alltt}

Can protect against rogue DHCP servers, IPv6 router advertisement attacks etc.

Source: Overview of Port Security, Juniper\\ {\small\link{https://www.juniper.net/documentation/en_US/junos/topics/example/overview-port-security.html}}

\slide{Helpful functions are available }

%\hlkimage{}{}

First hop security Cisco
\begin{alltt}\small
ipv6 snooping logging packet drop

interface GigabitEthernet1/0/1
    switchport mode access
    ipv6 nd raguard
    ipv6 dhcp guard
\end{alltt}

\begin{list2}
\item RA Guard RFC6105 \emph{IPv6 Router Advertisement Guard} and \\
RFC7113 \emph{Implementation Advice for IPv6 Router Advertisement Guard (RA-Guard)}\\
Only allow router advertisements on configured ports
\item DHCPv6 guard only allow DHCP servers on specific ports
\item Source and Prefix Guard
\end{list2}

Wait a minute, have you turned similar features for IPv4? Many have NOT! {\myalert}

\slide{Creating an Access Control List (ACL)}

%\hlkimage{}{}

\begin{alltt}
 (config)#ipv6 access-list RA-GUARD
 (config-ipv6-acl)#sequence 3 deny icmp any any router-advertisement
 (config-ipv6-acl)#sequence 6 permit ipv6 any any
 (config-ipv6-acl)#exit
 (config)#interface FastEthernet0/5
 (config-if)#ipv6 traffic-filter RA-GUARD in
\end{alltt}
Source: example copied from RIPE NCC IPv6 Security Training materials:\\
\link{https://www.ripe.net/support/training/material/ipv6-security/ipv6security-slides.pdf}

\begin{list2}
\item Best practice, and not that hard to do
\item ACL, filtering and firewalling will create longer lasting protection
\item Paired with a nice address plan you can easily put restrictions on traffic flow, without hurting functionaliy or the business
\item Does ANY client in ANY office NEEEEEED to connect to ANY UPS, Virtualisation and printer across the world ...
\end{list2}

\slide{Most firewalls include some detection today}

\hlkimage{5cm}{NSM_Phases-300x238.png}

Source: ANSM chapter 1: The Practice of Applied Network Security Monitoring
\begin{list2}
\item Vulnerability-Centric vs. Threat-Centric Defense
\item The NSM cycle: collection, detection, and analysis
\item Full Content Data, Session Data, Statistical Data, Packet String Data, and Alert Data
\item Security Onion is nice, but a bit over the top - quickly gets overloaded

\item Book referenced is: \emph{Network Security Monitoring
Applied Network Security Monitoring Collection, Detection, and Analysis}, 2014 Chris Sanders ISBN: 9780124172081
\end{list2}



\slide{Indicators of Compromise and Signatures}

\begin{quote}
An IOC is any piece of information that can be used to objectively describe a
network intrusion, expressed in a platform-independent manner. This could include a simple indicator such as the IP address of a command and control (C2) server or a complex set of behaviors that indicate that a mail server is being used as a malicious SMTP relay.

When an IOC is taken and used in a platform-specific language or format, such as a Snort Rule or a Bro-formatted file, it becomes part of a signature. A signature can contain one or more IOCs.
\end{quote}

Source: Applied Network Security Monitoring Collection, Detection, and Analysis, 2014 Chris Sanders


\begin{list2}
\item Network Security Monitoring (NSM) - monitoring networks for intrusions, and reacting to those
\item networkbased intrusion detection systems (NIDS)
\item host based intrusion detection systems (HIDS)
\item Example systems are Security Onion \link{https://securityonion.net/} or\\ SELKS \link{https://www.stamus-networks.com/open-source/}
\end{list2}



\slide{Network Sniffing for Security}


\begin{list1}
\item ANSM chapter 3:The Sensor Platform
\begin{list2}
\item Full Packet Capture (FPC) Data
\item Session Data
\item Statistical Data
\item Packet String (PSTR) Data
\item Log Data
\item Sensor Placement, designing etc.
\end{list2}
\end{list1}
\emph{Applied Network Security Monitoring Collection, Detection, and Analysis}, 2014 Chris Sanders ISBN: 9780124172081 - shortened ANSM


\slide{Collect Network Evidence from the network -- netflow}

\begin{list1}
\item Netflow is getting more important, more data share the same links
\item Detecting DoS/DDoS and problems is essential
\item Netflow sampling is vital information - 123Mbit, but what kind of traffic
\item Cisco standard NetFlow version 5 defines a flow as a unidirectional sequence of packets that all share the following 7 values:
\begin{list2}
\item Ingress interface (SNMP ifIndex), IP protocol, Source IP address and Destination IP address
\item Source port for UDP or TCP, 0 for other protocols, IP Type of Service
\item Destination port for UDP or TCP, type and code for ICMP, or 0 for other protocols
\end{list2}
\item Today we can use Netflow version 9 or IPFIX with more fields available
\end{list1}

Source: \\{\footnotesize
\link{https://en.wikipedia.org/wiki/NetFlow}
\link{https://en.wikipedia.org/wiki/IP_Flow_Information_Export}}


\slide{Netflow using NFSen}

\hlkimage{13cm}{images/nfsen-overview.png}


\slide{ Netflow NFSen}

\hlkimage{17cm}{nfsen-udp-flood.png}

\centerline{An extra 100k packets per second from this netflow source (source is a router)}

\slide{ElastiFlow -- Elasticsearch based}

\hlkimage{10cm}{elastiflow.png}

\begin{quote}
  ElastiFlow™ provides network flow data collection and visualization using the Elastic Stack (Elasticsearch, Logstash and Kibana). It supports Netflow v5/v9, sFlow and IPFIX flow types (1.x versions support only Netflow v5/v9).
\end{quote}
Source: Picture and text from \link{https://github.com/robcowart/elastiflow} \\



\slide{Big Data tools: Dashboards with Kibana and Elasticsearch}

\hlkimage{6cm}{kibanascreenshothomepagebannerbigger.jpg}
Source: \link{https://www.elastic.co}

\begin{list2}
\item View data by digging into it easily - must be fast
\item Elasticsearch is an open source distributed, RESTful search and analytics engine capable of solving a growing number of use cases
\item Non-programmers can create, save, and share dashboards using Kibana
\item Fan of Elastic Common Schema (ECS) \link{https://www.elastic.co/guide/en/ecs/current/index.html}
\item Other popular examples include Graylog and Grafana Loki
\end{list2}


\slide{How to get started}

\begin{list1}
\item How to get started searching for security events?
\item Collect basic data from your devices and networks
\begin{list2}
\item Netflow data from routers
\item Session data from firewalls
\item Logging from applications: email, web, proxy systems
\end{list2}
\item {\bf Centralize!}
\item Process data
\begin{list2}
\item Top 10: interesting due to high frequency, occurs often, brute-force attacks
\item {\it ignore}
\item Bottom 10: least-frequent messages are interesting
\end{list2}
\end{list1}




\slide{Ansible Configuration Management}

\begin{alltt}\small
- apt: name={{ item }} state=latest
  with_items:
        - unzip
        - elasticsearch
        - logstash
        - redis-server
        - nginx
- lineinfile: "dest=/etc/elasticsearch/elasticsearch.yml state=present
  regexp='script.disable_dynamic: true' line='script.disable_dynamic: true'"
- lineinfile: "dest=/etc/elasticsearch/elasticsearch.yml state=present
  regexp='network.host: localhost' line='network.host: localhost'"
- name: Move elasticsearch data into /data
  command: creates=/data/elasticsearch mv /var/lib/elasticsearch /data/
- name: Make link to /data/elasticsearch
  file: state=link src=/data/elasticsearch path=/var/lib/elasticsearch
\end{alltt}
\vskip 5mm

\centerline{only requires SSH+python \link{http://www.ansible.com}}

A complete example is available in \link{https://github.com/kramse/kramse-labs}

\slide{Network Security Through Data Analysis}

\hlkimage{4cm}{network-security-through-data-analysis.png}

Low page count, but high value! Recommended.

Network Security through Data Analysis, 2nd Edition
By Michael S Collins
Publisher: O'Reilly Media, October 2017 348 Pages

See also \link{https://zencurity.gitbook.io/kea-it-sikkerhed/siem-and-log-analysis/lektionsplan}

\slide{Blue Team -- Packet sniffing tools}

\begin{list1}
\item Tcpdump for capturing packets
\item Wireshark for dissecting packets manually with GUI
\item Zeek Network Security Monitor
\item Snort, old timer Intrusion Detection Engine (IDS)
\item Suricata, modern robust capable of IDS and IPS (prevention)
\item ntopng High-speed web-based traffic analysis
\item Maltrail Malicious traffic detection system \url{https://github.com/stamparm/MalTrail}
\end{list1}

\vskip 5mm
\centerline{Often a combination of tools and methods used in practice}

Full packet capture big data tools also exist


\slide{The Zeek Network Security Monitor}


\hlkimage{14cm}{zeek-overview.png}

The Zeek Network Security Monitor is not a single tool, more of a
powerful network analysis framework

Zeek is the tool formerly known as Bro, changed name in 2018. \link{https://www.zeek.org/}



\slide{Zeek is a Framework}

\hlkimage{14cm}{zeek-ids.png}

\begin{quote}
While focusing on network security monitoring, Zeek provides a comprehensive platform for more general network traffic analysis as well. Well grounded in more than 15 years of research, Zeek has successfully bridged the traditional gap between academia and operations since its inception.
\end{quote}

\link{https://www.Zeek.org/}


\slide{Zeek Scripts}

\begin{alltt}\small
global dns_A_reply_count=0;
global dns_AAAA_reply_count=0;
...
event dns_A_reply(c: connection, msg: dns_msg, ans: dns_answer, a: addr)
        \{
        ++dns_A_reply_count;
        \}

event dns_AAAA_reply(c: connection, msg: dns_msg, ans: dns_answer, a: addr)
        \{
        ++dns_AAAA_reply_count;
        \}
\end{alltt}
Source: dns-fire-count.bro from\\
{\footnotesize \link{https://github.com/LiamRandall/bro-scripts/tree/master/fire-scripts}\\
\url{https://docs.zeek.org/en/master/script-reference/index.html}}


\slide{Get Started with Zeek}

\begin{list1}
\item To run in “base” mode:
 \verb+zeek -r traffic.pcap+
\item To run in a “near broctl” mode:
\verb+zeek -r traffic.pcap local+
\item To add extra scripts:
\verb+zeek -r traffic.pcap myscript.bro+
\end{list1}

\centerline{Note: the project was renamed from Bro to Zeek in Oct 2018}


\slide{Suricata IDS/IPS/NSM}

\hlkimage{6cm}{suricata.png}

\begin{quote}
Suricata is a high performance Network IDS, IPS and Network Security Monitoring engine. Open Source and owned by a community run non-profit foundation, the Open Information Security Foundation (OISF). Suricata is developed by the OISF and its supporting vendors.
\end{quote}

\link{http://suricata-ids.org/}
\link{http://openinfosecfoundation.org}


\slide{Exercise at home -- Your lab setup}

\begin{list2}
\item Go to GitHub, Find user Kramse, click through security-courses, courses\\
\link{https://github.com/kramse/security-courses/tree/master/courses}
\item Suricata and Zeek workshop is then in \verb+networking/suricatazeek-workshop+
\item Download the PDF files for the slides and exercises:\\  {\footnotesize \url{https://github.com/kramse/security-courses/tree/master/courses/networking/suricatazeek-workshop}}

\item Get the lab instructions, from\\ {\footnotesize\url{https://github.com/kramse/kramse-labs/tree/master/suricatazeek}}

\item There are also a full Nmap workshop\\
{\footnotesize\link{https://github.com/kramse/security-courses/tree/master/courses/pentest/nmap-workshop}}

\item There are also a full SIEM and Log Analysis course\\
{\footnotesize\link{https://github.com/kramse/security-courses/tree/master/courses/system-and-software/siem-log-analysis}}
\end{list2}


\myquestionspage

\end{document}
